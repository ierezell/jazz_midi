import{c as R,a as _,f as V}from"./CmtjIIgE.js";import{f as H,p as B,c as f,s as w,t as T,a as G,v as u,Z as I,U as A,r as m}from"./ipsVM-65.js";import{d as F,s as q}from"./Brx6x_Mu.js";import{i as j}from"./D8W4ZUO4.js";import{r as z,b as S,k as U}from"./CO8AMRA4.js";import"./D90TUp_q.js";import{I as W,s as Z}from"./BvDaSNAJ.js";import{l as J,s as Q}from"./CSIEbD0i.js";import{P as X}from"./BAHfEBhx.js";import{M as Y}from"./DTRnenjV.js";import{_ as ee}from"./PPVm8Dsz.js";function te(r,e){const t=J(e,["children","$$slots","$$events","$$legacy"]);const s=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1"}]];W(r,Q({name:"pause"},()=>t,{get iconNode(){return s},children:(i,n)=>{var o=R(),a=H(o);Z(a,e,"default",{}),_(i,o)},$$slots:{default:!0}}))}var se=V('<div class="metronome svelte-1lsk5dc"><div class="controls svelte-1lsk5dc"><button><!></button> <div class="bpm-control svelte-1lsk5dc"><span class="bpm-display svelte-1lsk5dc"> </span> <input type="range" min="40" max="240" class="bpm-slider svelte-1lsk5dc"/></div></div></div>');function ge(r,e){B(e,!0);let t=A(120),s=A(!1),i=null,n=null;function o(){u(s)?l():a()}function a(){n||(n=new AudioContext),I(s,!0);const c=60/u(t)*1e3;v(),i=window.setInterval(v,c)}function l(){I(s,!1),i&&(clearInterval(i),i=null)}function v(){if(!n)return;const c=n.createOscillator(),d=n.createGain();c.connect(d),d.connect(n.destination),c.frequency.value=1e3,d.gain.value=.5,c.start(),d.gain.exponentialRampToValueAtTime(.001,n.currentTime+.1),c.stop(n.currentTime+.1),e.onTick?.(Date.now())}function x(c){const d=c.target;I(t,parseInt(d.value),!0),u(s)&&(l(),a())}var g=se(),E=f(g),p=f(E);let k;p.__click=o;var $=f(p);{var L=c=>{te(c,{size:20})},P=c=>{X(c,{size:20})};j($,c=>{u(s)?c(L):c(P,!1)})}m(p);var D=w(p,2),y=f(D),K=f(y);m(y);var b=w(y,2);z(b),b.__input=x,m(D),m(E),m(g),T(()=>{k=S(p,1,"toggle-btn svelte-1lsk5dc",null,k,{playing:u(s)}),q(K,`${u(t)??""} BPM`),U(b,u(t))}),_(r,g),G()}F(["click","input"]);class ie{constructor(e={}){this.options=e,this.options={velocity:100,channel:0,...e}}listeners=[];activeNotes=new Set;currentOctave=4;rootNoteOffset=0;rootNoteName="C";addEventListener(e,t){e==="midimessage"&&this.listeners.push(t)}removeEventListener(e,t){if(e==="midimessage"){const s=this.listeners.indexOf(t);s>-1&&this.listeners.splice(s,1)}}pressKey(e,t=this.options.velocity||100){if(this.activeNotes.has(e))return;this.activeNotes.add(e);const s=this.createMidiMessage(144,e,t);this.dispatchMidiEvent(s)}releaseKey(e){if(!this.activeNotes.has(e))return;this.activeNotes.delete(e);const t=this.createMidiMessage(128,e,0);this.dispatchMidiEvent(t)}releaseAllKeys(){for(const e of this.activeNotes)this.releaseKey(e)}getActiveNotes(){return Array.from(this.activeNotes)}playChord(e,t=this.options.velocity||100){e.forEach(s=>this.pressKey(s,t))}setOctave(e){this.currentOctave=Math.max(0,Math.min(8,e))}getOctave(){return this.currentOctave}setRootNote(e){const t={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};this.rootNoteOffset=t[e]||0,this.rootNoteName=e}getRootNote(){return this.rootNoteName}createMidiMessage(e,t,s){return new Uint8Array([e|(this.options.channel||0),t,s])}dispatchMidiEvent(e){const t={data:e,timeStamp:performance.now(),type:"midimessage"};this.listeners.forEach(s=>s(t))}}function ne(r="Virtual MIDI Keyboard"){const e=new ie,t={id:"virtual-midi-input",manufacturer:"Virtual",name:r,type:"input",version:"1.0.0",state:"connected",connection:"open",onmidimessage:null,onstatechange:null,addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e),dispatchEvent:()=>!1,open:()=>Promise.resolve(t),close:()=>Promise.resolve(t),_virtualInput:e};return Object.defineProperty(t,"onmidimessage",{get(){return this._onmidimessage},set(o){this._onmidimessage=o,o&&e.addEventListener("midimessage",o)}}),{inputs:new Map([["virtual-midi-input",t]]),outputs:new Map,sysexEnabled:!1,onstatechange:null,addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1,getVirtualInput:()=>e}}const O={z:0,x:2,c:4,v:5,f:5,b:7,n:9,m:11,",":12,".":14,"/":16,s:1,d:3,g:6,h:8,j:10,l:13,";":15,"'":17,q:12,w:14,e:16,r:17,t:19,y:21,u:23,i:24,o:26,p:28,"[":29,"]":31,2:1,3:3,5:6,6:8,7:10,9:13,0:15,"=":20};function N(r,e){const t={},s=r*12+12;let i=0;e&&(i={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11}[e]||0);for(const[n,o]of Object.entries(O)){const a=s+i+o;a>=24&&a<=127&&(t[n]=a)}return t}function C(r,e=!1){const t=new Set;function s(n){if(!e)return;const o=n.key.toLowerCase();console.debug("Key pressed:",o);const a=N(r.getOctave(),r.getRootNote());if(a[o]&&!t.has(o)){t.add(o);const l=a[o];console.debug(`Pressing MIDI note ${l} for key '${o}' (octave ${r.getOctave()})`),r.pressKey(l),n.preventDefault()}}function i(n){if(!e)return;const o=n.key.toLowerCase(),a=N(r.getOctave(),r.getRootNote());if(a[o]&&t.has(o)){t.delete(o);const l=a[o];console.debug(`Releasing MIDI note ${l} for key '${o}' (octave ${r.getOctave()})`),r.releaseKey(l),n.preventDefault()}}return e?console.debug("Virtual keyboard input setup complete. Available keys:",Object.keys(O),"Base octave:",r.getOctave()):console.debug("Virtual keyboard input setup (keyboard disabled)"),document.addEventListener("keydown",s),document.addEventListener("keyup",i),()=>{console.debug("Virtual keyboard input cleanup"),document.removeEventListener("keydown",s),document.removeEventListener("keyup",i)}}class h{static instance;basicPitch=null;audioContext=null;isRecording=!1;listeners=[];constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async start(){if(!this.isRecording)try{if(!this.basicPitch){const{BasicPitch:e}=await ee(async()=>{const{BasicPitch:t}=await import("./CAYENW2a.js");return{BasicPitch:t}},[],import.meta.url);this.basicPitch=new e("https://unpkg.com/@spotify/basic-pitch@1.0.1/model/model.json")}this.audioContext=new AudioContext,await this.audioContext.resume(),this.isRecording=!0,console.warn("Real-time audio processing with BasicPitch is pending implementation.")}catch(e){throw console.error("Error starting audio input:",e),e}}stop(){this.isRecording&&(this.isRecording=!1,this.audioContext&&(this.audioContext.close(),this.audioContext=null))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e,t,s){const i=s?144:128,n=new Uint8Array([i,e,t]),o=new MIDIMessageEvent("midimessage",{data:n});this.listeners.forEach(a=>a(o))}}const M=h.getInstance();class oe{midiAccess=null;virtualMidi=null;keyboardCleanup=null;eventHandlers={};errorCallbacks=[];debugMode=!1;audioInputEnabled=!1;constructor(){}async initialize(){try{return await this.connectMIDI(),this.setupAudioInput(),!0}catch(e){return this.handleError(e),!1}}async connectMIDI(){try{if(this.midiAccess=await this.safeRequestMidiAccess({sysex:!1}),!this.midiAccess)throw new Error("Failed to obtain MIDI access");return this.safeSetupMidiCallback(this.midiAccess,this.handleMIDIMessage.bind(this),this.handleError.bind(this)),console.debug("MIDI Manager: Connected to physical MIDI devices"),!0}catch(e){return this.handleError(e),!1}}async safeRequestMidiAccess(e){try{if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser"),null;const t=await navigator.requestMIDIAccess(e||{sysex:!1});return console.debug("MIDI Access obtained successfully"),t}catch(t){return console.error("Failed to obtain MIDI access:",t),null}}safeSetupMidiCallback(e,t,s){try{e.inputs.forEach(i=>{const n=`Input port [type:'${i.type}'] id:'${i.id}' manufacturer:'${i.manufacturer}' name:'${i.name}' version:'${i.version}'`;console.debug(`Setting up MIDI input: ${n}`),i.onmidimessage=o=>{try{t(o)}catch(a){console.error("Error in MIDI message callback:",a),s&&s(a)}}}),e.onstatechange=i=>{const n=i.port;console.debug(`MIDI port state changed: ${n.name} is now ${n.state}`)}}catch(i){console.error("Error setting up MIDI callback:",i),s&&s(i)}}setupVirtualKeyboard(){try{const e=ne("Virtual Debug Keyboard");this.virtualMidi=e.getVirtualInput(),this.keyboardCleanup=C(this.virtualMidi,this.debugMode);const t=Array.from(e.inputs.values())[0];t&&(t.onmidimessage=this.handleMIDIMessage.bind(this)),console.debug("MIDI Manager: Virtual keyboard enabled")}catch(e){this.handleError(e)}}setDebugMode(e){this.debugMode=e,this.virtualMidi&&(this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.keyboardCleanup=C(this.virtualMidi,this.debugMode),console.debug(`MIDI Manager: Debug mode ${e?"enabled":"disabled"}`))}setupAudioInput(){M.addListener(e=>{this.audioInputEnabled&&this.handleMIDIMessage(e)})}async setAudioInput(e){this.audioInputEnabled=e,e?(await M.start(),console.debug("MIDI Manager: Audio input enabled")):(M.stop(),console.debug("MIDI Manager: Audio input disabled"))}getVirtualMidi(){return this.virtualMidi}safeGetMidiNote(e){try{if(!e.data||e.data.length<3)return console.warn("Invalid MIDI message data"),null;const[t,s,i]=e.data,n=t&240,o=t&15;if(n!==144&&n!==128)return null;if(s<24||s>127)return console.warn(`MIDI note ${s} out of valid range (24-127)`),null;const a=s,l=Y[a];if(!l)return console.error(`No note name found for MIDI note ${a}`),null;const v=n===144&&i>0;return{noteNumber:a,type:v?"on":"off",noteFullName:l,noteName:l.slice(0,-1),velocity:i||0,timestamp:e.timeStamp||performance.now(),channel:o}}catch(t){return console.error("Error parsing MIDI message:",t),null}}handleMIDIMessage(e){try{const t=this.safeGetMidiNote(e);if(!t)return;t.type==="on"&&this.eventHandlers.onNoteOn?this.eventHandlers.onNoteOn(t):t.type==="off"&&this.eventHandlers.onNoteOff&&this.eventHandlers.onNoteOff(t)}catch(t){this.handleError(t)}}setEventHandlers(e){this.eventHandlers={...this.eventHandlers,...e}}handleError(e){console.error("MIDI Manager Error:",e),this.errorCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in error callback:",s)}}),this.eventHandlers.onError&&this.eventHandlers.onError(e)}getMIDIDevices(){return this.midiAccess?{inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())}:{inputs:[],outputs:[]}}cleanup(){this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.virtualMidi&&(this.virtualMidi.releaseAllKeys(),this.virtualMidi=null),this.midiAccess&&(this.midiAccess.inputs.forEach(e=>{e.onmidimessage=null}),this.midiAccess.onstatechange=null),this.eventHandlers={},this.errorCallbacks=[],console.debug("MIDI Manager: Cleaned up all connections")}}const ye=new oe;export{ge as M,N as g,ye as m};
