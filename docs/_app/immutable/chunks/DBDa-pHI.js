import{c as Ct,a as w,f as y}from"./Bdvgn338.js";import{o as $e,a as Yt}from"./BRJReVLM.js";import{e as Xt,h as Jt,f as Ee,p as Re,g as at,k as t,U as D,c as r,s as l,r as s,t as F,a as Ie,Z as b,X as x,_ as Qt,V as Qe,W as Zt,Y as Mt}from"./ZtE6Gyvq.js";import{d as st,s as S}from"./BnZ86L-c.js";import{I as $t,s as ea,e as Ne,i as ke}from"./BbjHMeAY.js";import{i as B}from"./CdTPX8-T.js";import{s as ta}from"./C1phzpXo.js";import{c as Se,j as Ze,e as aa,C as sa,h as jt,i as ra,s as na,a as oa}from"./C2lzuMI8.js";import{t as ze,s as ia,f as et,u as Be}from"./BmZ7kVW3.js";import{l as la,s as tt,p as Z}from"./-nZJNBOr.js";import{g as da,m as Ce,M as ca}from"./B4ADBuEr.js";import{D as rt,M as _e,N as nt,g as va,f as ua,A as We,b as fa,h as ha}from"./CXrKfc7O.js";import{p as St}from"./BYaj1R6p.js";import{g as ma}from"./D3KJybuK.js";import{j as ga}from"./DgjDHdGy.js";import{_ as _a}from"./PPVm8Dsz.js";import{S as ba}from"./BWbTUZzl.js";import"./BUbxQ3bP.js";import{A as pa}from"./5CzTn_X0.js";class ot{#e=new WeakMap;#t;#a;static entries=new WeakMap;constructor(e){this.#a=e}observe(e,n){var i=this.#e.get(e)||new Set;return i.add(n),this.#e.set(e,i),this.#s().observe(e,this.#a),()=>{var d=this.#e.get(e);d.delete(n),d.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#s(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var n of e){ot.entries.set(n.target,n);for(var i of this.#e.get(n.target)||[])i(n)}}))}}var wa=new ot({box:"border-box"});function Et(a,e,n){var i=wa.observe(a,()=>n(a[e]));Xt(()=>(Jt(()=>n(a[e])),i))}function ya(a,e){const n=la(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];$t(a,tt({name:"rotate-ccw"},()=>n,{get iconNode(){return i},children:(d,u)=>{var N=Ct(),T=Ee(N);ea(T,e,"default",{}),w(d,N)},$$slots:{default:!0}}))}const Na=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[0]+12,fifth:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n}}},ka=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],seventh:a[3],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[3],seventh:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[3],fifth:a[0]+12,seventh:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[3],third:a[0]+12,fifth:a[1]+12,seventh:a[2]+12,inversion:3,chordType:n}}},Tt=(a,e,n=0)=>{const i=a+2,d=a+3,u=a+4,N=a+5,T=a+6,_=a+7,O=a+8,E=a+9,h=a+10,C=a+11;let v=[];switch(e){case"major":{v=[a,u,_];break}case"minor":{v=[a,d,_];break}case"maj7":{v=[a,u,_,C];break}case"min7":{v=[a,d,_,h];break}case"7":case"dom7":{v=[a,u,_,h];break}case"diminished":{v=[a,d,T];break}case"augmented":{v=[a,u,O];break}case"sus2":{v=[a,i,_];break}case"sus4":{v=[a,N,_];break}case"dim7":{v=[a,d,T,E];break}case"half-dim7":{v=[a,d,T,h];break}default:v=[a]}if(v.length===3){if(n===3)throw new Error(`Triad ${e} chords do not have a 3rd inversion`);return Na(v,n,e)}else return ka(v,n,e)};function xa(a,e){const n=[a.root,a.third,a.fifth,a.seventh].filter(d=>d!==void 0),i=a.root+14;switch(e){case"full-right":return n;case"full-left":return n.map(d=>d-12).filter(d=>d>=24);case"1735":return[a.root-12,(a.seventh||a.root)-12,a.third,a.fifth].filter(d=>d!==void 0&&d>=24);case"1537":return[a.root-12,a.fifth-12,a.third,a.seventh||a.root].filter(d=>d!==void 0&&d>=24);case"rootless-a":return[a.third,a.fifth,a.seventh,i].filter(d=>d!==void 0);case"rootless-b":return[a.seventh,i,a.third+12,a.fifth+12].filter(d=>d!==void 0);default:return n}}function Ma(a,e){const n=xa(a,e);switch(e){case"full-right":return{leftHand:[],rightHand:[n.map(i=>_e[i])]};case"full-left":return{leftHand:[n.map(i=>_e[i])],rightHand:[]};case"1735":case"1537":{const i=n.slice(0,2),d=n.slice(2);return{leftHand:[i.map(u=>_e[u])],rightHand:[d.map(u=>_e[u])]}}case"rootless-a":case"rootless-b":return{leftHand:[],rightHand:[n.map(i=>_e[i])]};default:return{leftHand:[],rightHand:[n.map(i=>_e[i])]}}}function Ts(a,e,n,i){const d=a+rt,u=nt[d],N=Tt(u,e,n);return Ma(N,i)}function Sa(a,e=2,n=7){if(a.length===0)return{middleC:va,octaves:e};const i=Math.min(...a),d=Math.max(...a),u=d-i,N=Math.ceil(u/12)+1,T=Math.max(e,Math.min(n,N)),O=(i+d)/2-T*12/2,h=Math.floor(O/12)*12+Math.floor(T/2)*12;return{middleC:Math.max(24,h),octaves:T}}function Ea(a,e){switch((a%12-e%12+12)%12){case 0:return"root";case 4:return"third";case 7:return"fifth";case 11:return"seventh";case 2:return"ninth";case 5:return"eleventh";case 9:return"thirteenth";default:return"unknown"}}function As(a,e,n=rt){const i=a+n,d=nt[i],u=ua[e];return d+u}class Ca{audioElements=new Map;enabled=!0;unlocked=!1;volume=.7;constructor(){this.preloadSounds()}async preloadSounds(){try{await this.loadSound("success","/src/lib/sounds/ok.mp3"),await this.loadSound("error","/src/lib/sounds/error.mp3")}catch(e){console.warn("Failed to preload some audio files:",e)}}async loadSound(e,n){return new Promise((i,d)=>{if(typeof Audio>"u"){i();return}const u=new Audio;u.addEventListener("canplaythrough",()=>{this.audioElements.set(e,u),i()}),u.addEventListener("error",N=>{console.warn(`Failed to load sound "${e}" from ${n}:`,N),d(N)}),u.preload="auto",u.volume=this.volume,u.src=n})}async playSound(e,n){if(!this.enabled)return;if(!this.unlocked){console.warn("Audio playback blocked: user gesture required to enable sound. Call audioManager.unlock() from a user interaction.");return}const i=this.audioElements.get(e);if(!i){console.warn(`Sound "${e}" not found`);return}try{i.currentTime=0,n!==void 0?i.volume=Math.max(0,Math.min(1,n)):i.volume=this.volume,await i.play()}catch(d){console.warn(`Failed to play sound "${e}":`,d)}}async playSuccess(){await this.playSound("success",.8)}async playError(){await this.playSound("error",.6)}async unlock(){if(this.unlocked)return!0;try{const e=this.audioElements.get("success")??Array.from(this.audioElements.values())[0];if(!e)return this.unlocked=!0,!0;const n=e.volume;return e.volume=0,await e.play(),e.pause(),e.currentTime=0,e.volume=n,this.unlocked=!0,this.enabled=!0,console.debug("AudioManager: audio unlocked by user gesture"),!0}catch(e){return console.warn("AudioManager: unlock failed (user gesture required):",e),this.enabled=!1,this.unlocked=!1,!1}}needsUserGesture(){return!this.unlocked}}const Ae=new Ca;var ja=y("<option> </option>"),Ta=y("<option> </option>"),Aa=y("<option> </option>"),Ra=y('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Virtual MIDI Controls</h4> <div class="control-group svelte-pmsc4d"><label class="svelte-pmsc4d">Root Note: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Keyboard Octave: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Chord Type: <select class="svelte-pmsc4d"></select></label></div></div> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Quick Actions</h4> <div class="button-group svelte-pmsc4d"><button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn stop svelte-pmsc4d">Stop All Notes</button> <button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn svelte-pmsc4d">Random Note</button></div></div>',1),Ia=y('<div class="svelte-pmsc4d"> </div>'),Oa=y('<div class="svelte-pmsc4d"> </div>'),Ha=y('<div class="svelte-pmsc4d"> </div>'),Da=y('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Exercise Status</h4> <div class="status-info svelte-pmsc4d"><!> <!> <!></div></div>'),Fa=y('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Ka=y('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),La=y('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d"> </h4> <div class="shortcuts svelte-pmsc4d"><div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">White Keys:</strong><br/> <!></div> <div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">Black Keys:</strong><br/> <!></div></div></div>'),Pa=y('<div class="debug-content svelte-pmsc4d"><!> <!> <!> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Status</h4> <div class="status svelte-pmsc4d"><p class="svelte-pmsc4d">Active Notes: <span class="count svelte-pmsc4d"> </span></p> <p class="svelte-pmsc4d">Virtual MIDI: <span class="status-good svelte-pmsc4d"> </span></p></div></div></div>'),Va=y('<div><div class="debug-header svelte-pmsc4d"><h3 class="svelte-pmsc4d">ðŸŽ¹ Debug Panel</h3> <button class="toggle-btn svelte-pmsc4d"> </button></div> <!></div>');function Ba(a,e){Re(e,!0);let n=Z(e,"debugMode",3,!0),i=Z(e,"noteEvents",19,()=>[]),d=Z(e,"expectedNotes",19,()=>[]),u=Z(e,"currentNotes",19,()=>[]),N=x(()=>d().map(k=>_e[k])),T=x(()=>u().map(k=>_e[k])),_=D("C"),O=D("maj7"),E=D(4),h=x(()=>{const k=da(t(E),t(_)),j=U=>U.map(R=>({key:R.toUpperCase(),note:_e[k[R.toLowerCase()]]})).filter(R=>R.note);return{white:j(["z","x","c","v","b","n","m"]),black:j(["s","d","g","h","j"])}});at(()=>{e.virtualMidi&&(e.virtualMidi.setOctave(t(E)),e.virtualMidi.setRootNote(t(_)))});function C(){if(!e.virtualMidi)return;const k=t(E)*12+12,j=We.indexOf(t(_));if(j===-1)return;const U=k+j,R=Tt(U,t(O)),A=[R.root,R.third,R.fifth,R.seventh].filter(W=>W!=null&&W!=null);e.virtualMidi.playChord(A)}function v(){e.virtualMidi&&e.virtualMidi.releaseAllKeys()}let m=[];function g(){if(!e.virtualMidi)return;m.forEach(A=>clearTimeout(A)),m=[];const k=t(E)*12+12,j=We.indexOf(t(_));if(j===-1)return;const U=k+j;[0,2,4,5,7,9,11,12].map(A=>U+A).forEach((A,W)=>{const pe=setTimeout(()=>{e.virtualMidi.pressKey(A),setTimeout(()=>e.virtualMidi.releaseKey(A),300)},W*400);m.push(pe)})}function p(){if(!e.virtualMidi)return;const k=72+Math.floor(Math.random()*24);e.virtualMidi.pressKey(k),setTimeout(()=>e.virtualMidi.releaseKey(k),500)}var M=Va();let L;var fe=r(M),Y=l(r(fe),2);Y.__click=function(...k){e.onToggleDebugMode?.apply(this,k)};var z=r(Y);s(Y),s(fe);var X=l(fe,2);{var be=k=>{var j=Pa(),U=r(j);{var R=G=>{var re=Ra(),ne=Ee(re),me=l(r(ne),2),ce=r(me),q=l(r(ce));Ne(q,21,()=>We,ke,(ee,se)=>{var P=ja(),xe=r(P,!0);s(P);var de={};F(()=>{S(xe,t(se)),de!==(de=t(se))&&(P.value=(P.__value=t(se))??"")}),w(ee,P)}),s(q),s(ce);var J=l(ce,2),ie=l(r(J));Ne(ie,20,()=>[2,3,4,5,6],ke,(ee,se)=>{var P=Ta(),xe=r(P,!0);s(P);var de={};F(()=>{S(xe,se),de!==(de=se)&&(P.value=(P.__value=se)??"")}),w(ee,P)}),s(ie),s(J);var we=l(J,2),K=l(r(we));Ne(K,21,()=>fa,ke,(ee,se)=>{var P=Aa(),xe=r(P,!0);s(P);var de={};F(()=>{S(xe,t(se)),de!==(de=t(se))&&(P.value=(P.__value=t(se))??"")}),w(ee,P)}),s(K),s(we),s(me),s(ne);var I=l(ne,2),$=l(r(I),2),Q=r($);Q.__click=C;var ve=r(Q);s(Q);var ae=l(Q,2);ae.__click=v;var oe=l(ae,2);oe.__click=g;var le=r(oe);s(oe);var ye=l(oe,2);ye.__click=p,s($),s(I),F(()=>{S(ve,`Play ${t(_)??""}${t(O)??""}`),S(le,`Play ${t(_)??""} Scale`)}),Ze(q,()=>t(_),ee=>b(_,ee)),Ze(ie,()=>t(E),ee=>b(E,ee)),Ze(K,()=>t(O),ee=>b(O,ee)),w(G,re)};B(U,G=>{e.virtualMidi&&G(R)})}var A=l(U,2);{var W=G=>{var re=Da(),ne=l(r(re),2),me=r(ne);{var ce=K=>{var I=Ia(),$=r(I);s(I),F(Q=>S($,`Expected Notes: ${Q??""}`),[()=>t(N).join(", ")]),w(K,I)};B(me,K=>{d().length>0&&K(ce)})}var q=l(me,2);{var J=K=>{var I=Oa(),$=r(I);s(I),F(Q=>S($,`Current Notes: ${Q??""}`),[()=>t(T).join(", ")]),w(K,I)};B(q,K=>{u().length>0&&K(J)})}var ie=l(q,2);{var we=K=>{var I=Ha(),$=r(I);s(I),F(()=>S($,`Recent Events: ${i().length??""}`)),w(K,I)};B(ie,K=>{i().length>0&&K(we)})}s(ne),s(re),w(G,re)};B(A,G=>{(d().length>0||u().length>0)&&G(W)})}var pe=l(A,2);{var Oe=G=>{var re=La(),ne=r(re),me=r(ne);s(ne);var ce=l(ne,2),q=r(ce),J=l(r(q),3);Ne(J,17,()=>t(h).white,ke,(K,I)=>{let $=()=>t(I).key,Q=()=>t(I).note;var ve=Fa(),ae=Ee(ve),oe=r(ae,!0);s(ae);var le=l(ae,2),ye=r(le,!0);s(le),F(()=>{S(oe,$()),S(ye,Q())}),w(K,ve)}),s(q);var ie=l(q,2),we=l(r(ie),3);Ne(we,17,()=>t(h).black,ke,(K,I)=>{let $=()=>t(I).key,Q=()=>t(I).note;var ve=Ka(),ae=Ee(ve),oe=r(ae,!0);s(ae);var le=l(ae,2),ye=r(le,!0);s(le),F(()=>{S(oe,$()),S(ye,Q())}),w(K,ve)}),s(ie),s(ce),s(re),F(()=>S(me,`Keyboard Shortcuts (Octave ${t(E)??""})`)),w(G,re)};B(pe,G=>{e.virtualMidi&&G(Oe)})}var je=l(pe,2),He=l(r(je),2),he=r(He),te=l(r(he)),Ue=r(te,!0);s(te),s(he);var De=l(he,2),Fe=l(r(De)),Ke=r(Fe,!0);s(Fe),s(De),s(He),s(je),s(j),F(G=>{S(Ue,G),S(Ke,e.virtualMidi?"Connected":"Disconnected")},[()=>e.virtualMidi?e.virtualMidi.getActiveNotes().length:0]),w(k,j)};B(X,k=>{n()&&k(be)})}s(M),F(()=>{L=Se(M,1,"debug-panel svelte-pmsc4d",null,L,{visible:n()}),S(z,`${n()?"Hide":"Show"} Debug`)}),w(a,M),Ie()}st(["click"]);var Wa=y('<div><div class="note-role-dot svelte-ouqkuv"></div></div>'),za=y("<div><!></div>");function Ua(a,e){Re(e,!0);let n=Z(e,"interactive",3,!1),i=Z(e,"noteRoleColor",3,"transparent"),d=Z(e,"isWrongNote",3,!1),u=![1,3,6,8,10].includes(e.noteNum%12),N=D(0);u||([1,6].includes(e.noteNum%12)?b(N,-e.keyWidth/12):[3,10].includes(e.noteNum%12)&&b(N,e.keyWidth/12));function T(){n()&&e.onclick&&e.onclick()}function _(g){n()&&e.onmousedown&&(e.onmousedown(),g.preventDefault())}function O(g){n()&&e.onmouseup&&(e.onmouseup(),g.preventDefault())}function E(g){n()&&e.onmousedown&&(e.onmousedown(),g.preventDefault())}function h(g){n()&&e.onmouseup&&(e.onmouseup(),g.preventDefault())}var C=za();aa(C,()=>({style:`--width: ${e.keyWidth-e.keyWidth*.47*(u?0:1)}px; --height: ${e.keyHeight??""}px; --note-role-color: ${i()??""}; transform: translate(${t(N)??""}px);`,draggable:"false",onclick:T,onmousedown:_,onmouseup:O,ontouchstart:E,ontouchend:h,role:n()?"button":void 0,...n()?{tabindex:0}:{},[sa]:{accidental:!u,natural:u,pressed:e.pressed,interactive:n(),"wrong-note":d()}}),void 0,void 0,void 0,"svelte-ouqkuv");var v=r(C);{var m=g=>{var p=Wa();let M;F(()=>M=Se(p,1,"note-role-indicator svelte-ouqkuv",null,M,{"natural-indicator":u,"accidental-indicator":!u})),w(g,p)};B(v,g=>{i()&&g(m)})}s(C),w(a,C),Ie()}var Ga=y('<div class="keyboard svelte-1dlz8xf"></div>');function qa(a,e){Re(e,!0);let n=Z(e,"expectedNotes",19,()=>[]),i=Z(e,"showExpected",3,!1),d=D(10),u=D(10),N=x(()=>Math.max(1,Math.min(10,e.octaves||2))),T=x(()=>Math.max(24,Math.min(108,e.middleC||60))),_=x(()=>[...Array(t(N)*12+1).keys()].map(h=>h+(t(T)-Math.floor(t(N)/2)*12))),O=x(()=>t(_).filter(h=>![1,3,6,8,10].includes(h%12)).length);var E=Ga();Ne(E,21,()=>t(_),ke,(h,C)=>{const v=x(()=>i()&&n().includes(t(C))?"#2ecc71":ha[e.noteRoles[t(C)]]),m=x(()=>e.midiNotes.includes(t(C))),g=x(()=>t(m)&&n().length>0&&!n().includes(t(C)));{let p=x(()=>t(d)/t(O));Ua(h,{get noteNum(){return t(C)},get pressed(){return t(m)},get keyWidth(){return t(p)},get keyHeight(){return t(u)},get noteRoleColor(){return t(v)},get isWrongNote(){return t(g)}})}}),s(E),Et(E,"clientWidth",h=>b(d,h)),Et(E,"clientHeight",h=>b(u,h)),w(a,E),Ie()}var Ya=y('<div id="score-container" class="svelte-25wfcq"><canvas id="output" class="svelte-25wfcq"></canvas></div>');function Xa(a,e){Re(e,!0);let n=null,i=D(!1);$e(async()=>{n=await _a(()=>import("./wr6S8XWn.js"),[],import.meta.url),b(i,!0)});const d=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]),u={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","E#":"F","B#":"C"};function N(m){return m.includes("b")?!0:d.has(m)}function T(m){return{"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"}[m]||m}function _(m){const g=/(.*?)(\d+)$/.exec(m);if(!g)return m;let p=g[1];const M=parseInt(g[2],10);return(p==="A#"||p==="D#"||p==="G#"||N(e.selectedNote)&&p.includes("#"))&&(p=u[p]??p),`${p}${M+1}`}const O=m=>m?.map(g=>g.length>1?`(${g.map(p=>_(p)).join(" ")})`:_(g[0])).join(", ")||"";let E=x(()=>O(e.rightHand)),h=x(()=>O(e.leftHand));function C(m){if(!n||!t(i))return;const{Factory:g,Renderer:p,Voice:M}=n,L=m<768,fe=m<480,Y=m<360;let z;Y?z=200:fe?z=240:L?z=280:z=340;const X=document.getElementById("output");if(!X)return;const be=X.getContext("2d");if(!be)return;be.clearRect(0,0,X.width,X.height);const k=new g({renderer:{elementId:"output",backend:p.Backends.CANVAS,width:Math.max(300,m),height:Math.max(200,z)}}),j=k.EasyScore({throwOnError:!1}),U=L?10:20,R=k.System({width:Math.max(300,m),spaceBetweenStaves:U,noPadding:L,noJustification:L,formatOptions:{alignRests:!0,autoBeam:!0}});if((!e.rightHand||e.rightHand.length===0)&&(!e.leftHand||e.leftHand.length===0)){console.debug("No notes to render, rendering test chord");const A=`${_("C3")}, ${_("E3")}, ${_("G3")}`;try{const W=R.addStave({voices:[j.voice(j.notes(A,{clef:"treble",stem:"up"})).setMode(M.Mode.SOFT)]});W.addClef("treble"),e.selectedNote&&W.addKeySignature(T(e.selectedNote)),k.draw()}catch(W){console.error("Error rendering test chord:",W)}return}console.debug("Rendering score with notes:",{stringLeftHand:t(h),stringRightHand:t(E)}),console.debug("Selected note for key signature:",e.selectedNote);try{if(e.rightHand&&e.rightHand.length>0&&t(E)){const A=R.addStave({voices:[j.voice(j.notes(t(E),{clef:"treble",stem:"up"})).setMode(M.Mode.SOFT)]});A.addClef("treble"),e.selectedNote&&A.addKeySignature(T(e.selectedNote))}if(e.leftHand&&e.leftHand.length>0&&t(h)){const A=R.addStave({voices:[j.voice(j.notes(t(h),{clef:"bass",stem:"down"})).setMode(M.Mode.SOFT)]});A.addClef("bass"),e.selectedNote&&A.addKeySignature(T(e.selectedNote))}e.rightHand&&e.rightHand.length>0&&e.leftHand&&e.leftHand.length>0&&(R.addConnector("brace"),R.addConnector("single")),k.draw()}catch(A){console.error("Error rendering VexFlow score:",A)}}at(()=>{t(i)&&(console.debug("Score $effect triggered with props:",{leftHand:e.leftHand,rightHand:e.rightHand,selectedNote:e.selectedNote}),setTimeout(()=>{const m=document.getElementById("score-container");if(m){const g=m.getBoundingClientRect().width;g>0&&C(g)}},100))}),$e(()=>{const m=()=>{const g=document.getElementById("score-container");if(g){const p=g.getBoundingClientRect().width;console.debug(`Container width: ${p}`),p>0&&C(p)}};return window.addEventListener("resize",m),()=>{window.removeEventListener("resize",m)}});var v=Ya();w(a,v),Ie()}var Ja=y('<div class="star-wrapper svelte-h6yjv8"><!></div>'),Qa=y('<div class="modal-overlay svelte-h6yjv8"><div class="modal-content svelte-h6yjv8"><div class="modal-header"><h2 class="svelte-h6yjv8">Lesson Complete!</h2> <div class="stars-container svelte-h6yjv8"></div></div> <div class="stats-grid svelte-h6yjv8"><div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">Accuracy</span> <span class="stat-value svelte-h6yjv8"> </span></div> <div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">XP Gained</span> <span class="stat-value svelte-h6yjv8"> </span></div></div> <div class="modal-actions svelte-h6yjv8"><button class="retry-btn svelte-h6yjv8"><!> Retry</button> <button class="continue-btn svelte-h6yjv8">Continue <!></button></div></div></div>');function Za(a,e){var n=Ct(),i=Ee(n);{var d=u=>{var N=Qa(),T=r(N),_=r(T),O=l(r(_),2);Ne(O,20,()=>Array(3),ke,(X,be,k)=>{var j=Ja();jt(j,`animation-delay: ${k*200}ms`);var U=r(j);{let R=x(()=>k<e.stars?"star-filled":"star-empty"),A=x(()=>k<e.stars?"#ffd700":"none"),W=x(()=>k<e.stars?"#ffd700":"currentColor");ba(U,{size:48,get class(){return t(R)},get fill(){return t(A)},get stroke(){return t(W)}})}s(j),w(X,j)}),s(O),s(_);var E=l(_,2),h=r(E),C=l(r(h),2),v=r(C);s(C),s(h);var m=l(h,2),g=l(r(m),2),p=r(g);s(g),s(m),s(E);var M=l(E,2),L=r(M);L.__click=function(...X){e.onRetry?.apply(this,X)};var fe=r(L);ya(fe,{size:20}),Qt(),s(L);var Y=l(L,2);Y.__click=function(...X){e.onContinue?.apply(this,X)};var z=l(r(Y));pa(z,{size:20}),s(Y),s(M),s(T),s(N),F(()=>{S(v,`${e.accuracy??""}%`),S(p,`+${e.xp??""}`)}),ze(3,T,()=>ia),ze(3,N,()=>et),w(u,N)};B(i,u=>{e.isOpen&&u(d)})}w(a,n)}st(["click"]);var $a=y("<option> </option>"),es=y('<div class="control-group svelte-w7gj7d"><label for="note-select" class="svelte-w7gj7d">Root Key</label> <select id="note-select" class="svelte-w7gj7d"></select></div>'),ts=y('<div class="control-group svelte-w7gj7d"><!></div>'),as=y('<div class="control-group svelte-w7gj7d"><label for="tempo-toggle" class="svelte-w7gj7d">Tempo Mode</label> <button id="tempo-toggle"> </button></div> <!>',1),ss=y('<div class="control-group svelte-w7gj7d"><label for="training-mode-toggle" class="svelte-w7gj7d">Training Mode</label> <button id="training-mode-toggle" title="If enabled, mistakes will stop the lesson until you correct it"> </button></div>'),rs=y('<div class="exercise-description svelte-w7gj7d"><span class="info-icon svelte-w7gj7d">? <span class="desc-tooltip svelte-w7gj7d"> </span></span></div>'),ns=y('<div class="feedback-toast svelte-w7gj7d"> </div>'),os=y('<div class="prompt-card card-premium svelte-w7gj7d"><div class="prompt-text svelte-w7gj7d"> </div></div>'),is=y('<div class="score-container card-premium svelte-w7gj7d"><!></div>'),ls=y('<div class="adaptive-help-text"> </div>'),ds=y('<div class="debug-panel-wrapper"><!></div>'),cs=y('<div class="exercise-layout"><aside class="sidebar glass svelte-w7gj7d"><div class="sidebar-header svelte-w7gj7d"><h3 class="svelte-w7gj7d">Exercise Controls</h3></div> <div class="sidebar-content"><!> <!> <!> <div class="control-group svelte-w7gj7d"><label for="debug-toggle" class="svelte-w7gj7d">Virtual Keyboard</label> <button id="debug-toggle"> </button></div> <div class="sidebar-spacer"></div> <button class="reset-btn svelte-w7gj7d">Reset Session</button></div></aside> <main class="exercise-main svelte-w7gj7d"><header class="exercise-header svelte-w7gj7d"><div class="info-group svelte-w7gj7d"><!> <h1 class="svelte-w7gj7d"> </h1></div> <div class="performance-strip svelte-w7gj7d"><div><span class="label">Mistakes:</span> <span class="value"> </span></div> <div class="stat-pill success svelte-w7gj7d"><span class="label">Progress:</span> <span class="value"> </span></div></div></header> <!> <div class="focus-area svelte-w7gj7d"><!> <!> <!> <div><!></div> <div class="exercise-custom-content"><!></div></div> <!> <footer class="exercise-footer svelte-w7gj7d"><div class="progress-track svelte-w7gj7d"><div class="progress-fill svelte-w7gj7d"></div></div></footer></main></div> <!>',1);function Rs(a,e){Re(e,!0);let n=Z(e,"randomMode",3,!1),i=Z(e,"exerciseType",3,"chord"),d=Z(e,"progressiveHints",3,!0),u=Z(e,"showTempoControl",3,!0),N=Z(e,"showTrainingControl",3,!0),T=Z(e,"timingModeLabel",3,"Play on beat");const _=1,O=3,E=3;let h=D(Qe(e.initialNote??"C"));at(()=>{e.initialNote!==void 0&&e.initialNote!==t(h)&&(b(h,e.initialNote,!0),q())});let C=D(Qe([])),v=D(0),m=D(Qe(new Set)),g=D(0),p=D(!1),M=D(!1),L=D(""),fe=!1,Y=D(!1),z=D(!1),X=D(0),be=D(120);const k=150;let j=x(()=>e.showScore===!1?!1:i()==="partition"?!0:d()?t(v)>=_:e.showScore??!0);const U=x(()=>St.url.searchParams.get("unitId")),R=x(()=>St.url.searchParams.get("lessonId")),A=x(()=>!!t(U)&&!!t(R));let W=D(!1),pe=D(0),Oe=D(0),je=D(0),He=x(()=>t(v)>=E),he=x(()=>t(C).map(o=>o.noteNumber)),te=x(()=>e.generateExpectedNotes(t(h))),Ue=x(()=>e.generateScoreProps(t(h))),De=x(()=>t(M)||d()&&t(v)>=O),Fe=x(()=>({...Sa(t(te)),midiNotes:t(he),debugMode:t(M),noteRoles:Object.fromEntries(t(te).map(o=>[o,Ea(o,nt[`${t(h)}${rt}`])])),expectedNotes:t(te),showExpected:t(He)})),Ke=x(()=>{if(t(te).length===0)return 0;const o=[...new Set(t(te))];return Math.round(t(m).size/o.length*100)}),G=x(()=>{if(!d()||t(p)||i()==="partition")return"";if(t(v)<_){let o=`correct ${i()||"note"}`;if(e.prompt){const c=i()==="II-V-I"?"progression":i()==="note"?"note":i();o=`${e.prompt} ${c}`}return`Play the ${o}. After ${_-t(v)} more mistake${_-t(v)===1?"":"s"} the score will appear.`}return t(v)<O?`Reference keyboard will appear after ${O-t(v)} more mistake${O-t(v)===1?"":"s"}.`:"Adaptive help is active. Use the score and keyboard for reference."}),re=x(()=>({selectedNote:t(h),currentNotes:t(he),expectedNotes:t(te),mistakes:t(v),completed:t(p),collectedNotes:t(m),debugMode:t(M),feedbackMessage:t(L),showNotesRoles:fe,tempoMode:t(z),toggleDebug:I,showFeedback:J,toggleTempoMode:ve,handleTick:Q,completeExercise:o=>ie(o)}));Yt(()=>{Ce.cleanup()}),$e(async()=>{await Ce.initialize(),Ce.setupVirtualKeyboard(),Ce.setEventHandlers({onNoteOn:ne,onNoteOff:me}),b(g,Date.now(),!0);const o=async()=>{if(Ae.needsUserGesture()){const c=await Ae.unlock();J(c?"Audio enabled":"Click or press any key to enable audio","info")}};window.addEventListener("pointerdown",o,{once:!0}),window.addEventListener("keydown",o,{once:!0})});function ne(o){t(M)&&console.debug(`MIDI Note ON: ${o.noteNumber} (${o.noteFullName}) velocity=${o.velocity} channel=${o.channel}`);let c=!1;if(t(z)){const V=Date.now(),ge=60/t(be)*1e3,ue=V-t(X),Te=ge-ue;Math.min(ue,Te)>k&&(J("Off beat! Try to play on the beat.","error"),Mt(v),c=!0,Ae.playError())}b(C,[...t(C),o],!0);const f=e.validateNoteEvent(t(h),o,t(te),t(he));if(f.resetCollected&&b(m,new Set,!0),f.resetMistakes&&b(v,0),f.collected&&!c&&t(m).add(o.noteNumber),f.isCorrect)c||J(f.message,"success");else{if(!c){Mt(v),J(f.message,"error"),Ae.playError();const V=i()==="II-V-I"?"progression":i()==="note"||i()==="interval"?"chord":i();if(V!=="rhythm"&&(Be.trackMissedNote(o.noteName,V),V==="chord"||V==="progression")){const ge=`${t(h)}-${e.prompt??i()??"unknown"}`;Be.trackMissedChord(ge,V)}}if(t(Y)){b(L,"error : Mistake! Take your time...");return}}if(i()){const V=i()==="II-V-I"?"progression":i()==="note"||i()==="interval"?"chord":i();Be.updateNoteProgress(o.noteName,V,void 0,f.isCorrect,0,f.isCorrect?100:0)}const H=[...t(he),o.noteNumber];e.isCompleted(H,t(te))&&ie()}function me(o){t(M)&&console.debug(`MIDI Note OFF: ${o.noteNumber} (${o.noteFullName}) channel=${o.channel}`),b(C,t(C).filter(c=>c.noteNumber!==o.noteNumber),!0)}function ce(o){b(h,o,!0),q()}function q(){b(C,[],!0),b(v,0),b(p,!1),b(L,""),b(g,Date.now(),!0),b(h,t(h),!0),b(m,new Set,!0),e.onReset?.()}function J(o,c){b(L,`${c} : ${o}`),setTimeout(()=>{b(L,"")},5e3)}function ie(o){b(p,!0);const c=Date.now()-t(g),f=t(te).length,H=f>0?Math.max(0,Math.round((f-t(v))/f*100)):0;if(J(`Exercise completed! Time: ${c}ms, Accuracy: ${H}%`,"success"),Ae.playSound?.("success"),i()){const V=i()==="II-V-I"?"progression":i()==="note"||i()==="interval"?"chord":i();Be.recordExerciseResult({exerciseId:window.location.pathname,exerciseType:V,success:!0,accuracy:H,timeElapsed:c,mistakes:t(v),score:Math.max(0,100-t(v)*10),timestamp:new Date,...o})}t(A)&&t(U)&&t(R)?(b(pe,t(v)===0?3:t(v)<=2?2:1,!0),b(Oe,H,!0),b(je,Math.max(0,100-t(v)*10),!0),ga.completeLesson(t(U),t(R),t(pe)),b(W,!0)):(e.onComplete?.(),q())}function we(){b(W,!1),ma(oa("/journey"))}function K(){b(W,!1),q()}function I(){b(M,!t(M)),Ce.setDebugMode(t(M))}function $(o){const f=o.target.value;ce(f)}function Q(o,c){b(X,o,!0),c&&b(be,c,!0)}function ve(){b(z,!t(z))}var ae=cs(),oe=Ee(ae),le=r(oe),ye=l(r(le),2),ee=r(ye);{var se=o=>{var c=es(),f=l(r(c),2);f.__change=$,Ne(f,21,()=>We,ke,(V,ge)=>{var ue=$a(),Te=r(ue,!0);s(ue);var Me={};F(()=>{S(Te,t(ge)),Me!==(Me=t(ge))&&(ue.value=(ue.__value=t(ge))??"")}),w(V,ue)}),s(f);var H;ra(f),s(c),F(()=>{H!==(H=t(h))&&(f.value=(f.__value=t(h))??"",na(f,t(h)))}),w(o,c)};B(ee,o=>{n()||o(se)})}var P=l(ee,2);{var xe=o=>{var c=as(),f=Ee(c),H=l(r(f),2);let V;H.__click=ve;var ge=r(H,!0);s(H),s(f);var ue=l(f,2);{var Te=Me=>{var Je=ts(),qt=r(Je);ca(qt,{onTick:Q}),s(Je),w(Me,Je)};B(ue,Me=>{t(z)&&Me(Te)})}F(()=>{V=Se(H,1,"toggle-btn svelte-w7gj7d",null,V,{active:t(z)}),S(ge,t(z)?`${T()} âœ“`:T())}),w(o,c)};B(P,o=>{u()&&o(xe)})}var de=l(P,2);{var At=o=>{var c=ss(),f=l(r(c),2);f.__click=()=>b(Y,!t(Y));let H;var V=r(f,!0);s(f),s(c),F(()=>{H=Se(f,1,"toggle-btn svelte-w7gj7d",null,H,{active:t(Y)}),S(V,t(Y)?"Stop on Mistake":"Free Play")}),w(o,c)};B(de,o=>{N()&&o(At)})}var Ge=l(de,2),Le=l(r(Ge),2);Le.__click=I;let it;var Rt=r(Le,!0);s(Le),s(Ge);var It=l(Ge,4);It.__click=q,s(ye),s(le);var lt=l(le,2),qe=r(lt),Ye=r(qe),dt=r(Ye);{var Ot=o=>{var c=rs(),f=r(c),H=l(r(f)),V=r(H,!0);s(H),s(f),s(c),F(()=>S(V,e.description)),w(o,c)};B(dt,o=>{e.description&&o(Ot)})}var ct=l(dt,2),Ht=r(ct,!0);s(ct),s(Ye);var vt=l(Ye,2),Pe=r(vt);let ut;var ft=l(r(Pe),2),Dt=r(ft,!0);s(ft),s(Pe);var ht=l(Pe,2),mt=l(r(ht),2),Ft=r(mt);s(mt),s(ht),s(vt),s(qe);var gt=l(qe,2);{var Kt=o=>{var c=ns(),f=r(c,!0);s(c),F(()=>S(f,t(L))),ze(3,c,()=>et),w(o,c)};B(gt,o=>{t(L)&&o(Kt)})}var Xe=l(gt,2),_t=r(Xe);{var Lt=o=>{var c=os(),f=r(c),H=r(f,!0);s(f),s(c),F(()=>S(H,e.prompt)),w(o,c)};B(_t,o=>{e.prompt&&!t(j)&&o(Lt)})}var bt=l(_t,2);{var Pt=o=>{var c=is(),f=r(c);Xa(f,tt(()=>t(Ue))),s(c),ze(1,c,()=>et),w(o,c)};B(bt,o=>{t(j)&&o(Pt)})}var pt=l(bt,2);{var Vt=o=>{var c=ls(),f=r(c,!0);s(c),F(()=>S(f,t(G))),w(o,c)};B(pt,o=>{t(G)&&o(Vt)})}var Ve=l(pt,2);let wt;var Bt=r(Ve);qa(Bt,tt(()=>t(Fe))),s(Ve);var yt=l(Ve,2),Wt=r(yt);ta(Wt,()=>e.children??Zt,()=>t(re)),s(yt),s(Xe);var Nt=l(Xe,2);{var zt=o=>{var c=ds(),f=r(c);{let H=x(()=>Ce.getVirtualMidi()??void 0);Ba(f,{get noteEvents(){return t(C)},get expectedNotes(){return t(te)},get currentNotes(){return t(he)},get debugMode(){return t(M)},onToggleDebugMode:I,get virtualMidi(){return t(H)}})}s(c),w(o,c)};B(Nt,o=>{t(M)&&o(zt)})}var kt=l(Nt,2),xt=r(kt),Ut=r(xt);s(xt),s(kt),s(lt),s(oe);var Gt=l(oe,2);Za(Gt,{get isOpen(){return t(W)},get stars(){return t(pe)},get accuracy(){return t(Oe)},get xp(){return t(je)},onContinue:we,onRetry:K}),F(o=>{it=Se(Le,1,"toggle-btn svelte-w7gj7d",null,it,{active:t(M)}),S(Rt,t(M)?"Visible":"Hidden"),S(Ht,o),ut=Se(Pe,1,"stat-pill svelte-w7gj7d",null,ut,{neutral:t(v)===0,warn:t(v)>0}),S(Dt,t(v)),S(Ft,`${t(Ke)??""}%`),wt=Se(Ve,1,"keyboard-container svelte-w7gj7d",null,wt,{hidden:!t(De)}),jt(Ut,`width: ${t(Ke)??""}%`)},[()=>i()?.toUpperCase()||"PRACTICE"]),w(a,ae),Ie()}st(["change","click"]);export{Rs as B,Tt as a,xa as b,As as c,Ma as d,Ts as g};
