import{c as At,a as y,f as N}from"./Bdvgn338.js";import{o as et,a as Qt}from"./BRJReVLM.js";import{e as Zt,h as $t,f as ke,p as He,g as st,k as t,U as O,c as o,s as l,r as s,t as H,a as Fe,Z as g,X as S,_ as ea,V as Ze,W as ta,Y as Ct}from"./ZtE6Gyvq.js";import{d as rt,s as C}from"./BnZ86L-c.js";import{I as aa,s as sa,e as we,i as ye}from"./DWPsCs3Q.js";import{i as z}from"./CdTPX8-T.js";import{s as ra}from"./C1phzpXo.js";import{b as Se,j as $e,f as na,C as oa,h as It,i as ia,s as la,a as da}from"./C9cudW0Q.js";import{t as Ue,s as ca,f as tt,u as ze}from"./BmZ7kVW3.js";import{l as va,s as at,p as Q}from"./-nZJNBOr.js";import{g as ua,m as Re,M as fa}from"./H94QBU55.js";import{D as nt,M as be,g as ha,N as ot,f as ma,A as We,b as ga,h as _a}from"./CXrKfc7O.js";import{p as Tt}from"./_pvSvSmo.js";import{g as ba}from"./8Sg2Jt-m.js";import{j as pa}from"./6JBAplwY.js";import{_ as wa}from"./PPVm8Dsz.js";import{S as ya}from"./D9El-Y-J.js";import"./BUbxQ3bP.js";import{A as Ma}from"./DESgWj06.js";class it{#e=new WeakMap;#t;#a;static entries=new WeakMap;constructor(e){this.#a=e}observe(e,n){var r=this.#e.get(e)||new Set;return r.add(n),this.#e.set(e,r),this.#s().observe(e,this.#a),()=>{var d=this.#e.get(e);d.delete(n),d.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#s(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var n of e){it.entries.set(n.target,n);for(var r of this.#e.get(n.target)||[])r(n)}}))}}var Na=new it({box:"border-box"});function jt(a,e,n){var r=Na.observe(a,()=>n(a[e]));Zt(()=>($t(()=>n(a[e])),r))}function xa(a,e){const n=va(e,["children","$$slots","$$events","$$legacy"]);const r=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];aa(a,at({name:"rotate-ccw"},()=>n,{get iconNode(){return r},children:(d,v)=>{var _=At(),k=ke(_);sa(k,e,"default",{}),y(d,_)},$$slots:{default:!0}}))}class Sa{audioElements=new Map;enabled=!0;unlocked=!1;volume=.7;constructor(){this.preloadSounds()}async preloadSounds(){try{await this.loadSound("success","/src/lib/sounds/ok.mp3"),await this.loadSound("error","/src/lib/sounds/error.mp3")}catch(e){console.warn("Failed to preload some audio files:",e)}}async loadSound(e,n){return new Promise((r,d)=>{if(typeof Audio>"u"){r();return}const v=new Audio;v.addEventListener("canplaythrough",()=>{this.audioElements.set(e,v),r()}),v.addEventListener("error",_=>{console.warn(`Failed to load sound "${e}" from ${n}:`,_),d(_)}),v.preload="auto",v.volume=this.volume,v.src=n})}async playSound(e,n){if(!this.enabled)return;if(!this.unlocked){console.warn("Audio playback blocked: user gesture required to enable sound. Call audioManager.unlock() from a user interaction.");return}const r=this.audioElements.get(e);if(!r){console.warn(`Sound "${e}" not found`);return}try{r.currentTime=0,n!==void 0?r.volume=Math.max(0,Math.min(1,n)):r.volume=this.volume,await r.play()}catch(d){console.warn(`Failed to play sound "${e}":`,d)}}async playSuccess(){await this.playSound("success",.8)}async playError(){await this.playSound("error",.6)}async unlock(){if(this.unlocked)return!0;try{const e=this.audioElements.get("success")??Array.from(this.audioElements.values())[0];if(!e)return this.unlocked=!0,!0;const n=e.volume;return e.volume=0,await e.play(),e.pause(),e.currentTime=0,e.volume=n,this.unlocked=!0,this.enabled=!0,console.debug("AudioManager: audio unlocked by user gesture"),!0}catch(e){return console.warn("AudioManager: unlock failed (user gesture required):",e),this.enabled=!1,this.unlocked=!1,!1}}needsUserGesture(){return!this.unlocked}}const De=new Sa;function ka(a,e,n,r){const d=a.timestamp,v=60/r*1e3,_=d-e.timestamp,k=v-_,b=Math.min(_,k);return n.requireDownbeat&&!e.isDownbeat?"Play chords on the first beat of each measure!":b>n.toleranceMs?"Off beat! Try to play on the beat.":null}function Ea(a,e){return a.length===0||e.length===0?1/0:e.reduce((n,r)=>{const d=Math.min(...a.map(v=>Math.abs(r-v)));return n+d},0)}const Ca=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[0]+12,fifth:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n}}},Ta=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],seventh:a[3],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[3],seventh:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[3],fifth:a[0]+12,seventh:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[3],third:a[0]+12,fifth:a[1]+12,seventh:a[2]+12,inversion:3,chordType:n}}},x={second:a=>a+2,minorThird:a=>a+3,majorThird:a=>a+4,fourth:a=>a+5,flatFifth:a=>a+6,perfectFifth:a=>a+7,augmentedFifth:a=>a+8,diminishedSeventh:a=>a+9,minorSeventh:a=>a+10,majorSeventh:a=>a+11},ja={major:[x.majorThird,x.perfectFifth],minor:[x.minorThird,x.perfectFifth],maj7:[x.majorThird,x.perfectFifth,x.majorSeventh],min7:[x.minorThird,x.perfectFifth,x.minorSeventh],7:[x.majorThird,x.perfectFifth,x.minorSeventh],dom7:[x.majorThird,x.perfectFifth,x.minorSeventh],diminished:[x.minorThird,x.flatFifth],augmented:[x.majorThird,x.augmentedFifth],sus2:[x.second,x.perfectFifth],sus4:[x.fourth,x.perfectFifth],dim7:[x.minorThird,x.flatFifth,x.diminishedSeventh],"half-dim7":[x.minorThird,x.flatFifth,x.minorSeventh]};function Aa(a){let e=a;for(;e>60;)e=e-12;for(;e<48;)e=e+12;return e}function lt(a,e,n=0){const r=Aa(a),d=ja[e]??[],v=[r,...d.map(_=>_(r))];if(v.length===3&&n===3)throw new Error(`Triad ${e} chords do not have a 3rd inversion`);return v.length===3?Ca(v,n,e):Ta(v,n,e)}function Ia(a,e){const n=[a.root,a.third,a.fifth,a.seventh].filter(d=>d!==void 0),r=a.root+14;switch(e){case"full-right":return n;case"full-left":return n.map(d=>d-12).filter(d=>d>=24);case"1735":return[a.root-12,(a.seventh||a.root)-12,a.third,a.fifth].filter(d=>d!==void 0&&d>=24);case"1537":return[a.root-12,a.fifth-12,a.third,a.seventh||a.root].filter(d=>d!==void 0&&d>=24);case"rootless-a":return[a.third,a.fifth,a.seventh,r].filter(d=>d!==void 0);case"rootless-b":return[a.seventh,r,a.third+12,a.fifth+12].filter(d=>d!==void 0);default:return n}}function Ra(a,e){const n=Ia(a,e);switch(e){case"full-right":return{leftHand:[],rightHand:[n.map(r=>be[r])]};case"full-left":return{leftHand:[n.map(r=>be[r])],rightHand:[]};case"1735":case"1537":{const r=n.slice(0,2),d=n.slice(2);return{leftHand:[r.map(v=>be[v])],rightHand:[d.map(v=>be[v])]}}case"rootless-a":case"rootless-b":return{leftHand:[],rightHand:[n.map(r=>be[r])]};default:return{leftHand:[],rightHand:[n.map(r=>be[r])]}}}function Fs(a,e,n,r){const d=a+nt,v=ot[d],_=lt(v,e,n);return Ra(_,r)}function Oa(a,e=2,n=7){if(a.length===0)return{middleC:ha,octaves:e};const r=Math.min(...a),d=Math.max(...a),v=d-r,_=Math.ceil(v/12)+1,k=Math.max(e,Math.min(n,_)),R=(r+d)/2-k*12/2,h=Math.floor(R/12)*12+Math.floor(k/2)*12;return{middleC:Math.max(24,h),octaves:k}}function Da(a,e){switch((a%12-e%12+12)%12){case 0:return"root";case 4:return"third";case 7:return"fifth";case 11:return"seventh";case 2:return"ninth";case 5:return"eleventh";case 9:return"thirteenth";default:return"unknown"}}function Ls(a,e,n){if(n.length===0)return 0;const r=e.includes("7")?[0,1,2,3]:[0,1,2];let d=0,v=1/0;for(const _ of r)try{const k=lt(a,e,_),b=[k.root,k.third,k.fifth,k.seventh].filter(T=>T!==void 0),R=Ea(n,b);R<v&&(v=R,d=_)}catch{continue}return d}function Ks(a,e,n=nt){const r=a+n,d=ot[r],v=ma[e];return d+v}var Ha=N("<option> </option>"),Fa=N("<option> </option>"),La=N("<option> </option>"),Ka=N('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Virtual MIDI Controls</h4> <div class="control-group svelte-pmsc4d"><label class="svelte-pmsc4d">Root Note: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Keyboard Octave: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Chord Type: <select class="svelte-pmsc4d"></select></label></div></div> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Quick Actions</h4> <div class="button-group svelte-pmsc4d"><button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn stop svelte-pmsc4d">Stop All Notes</button> <button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn svelte-pmsc4d">Random Note</button></div></div>',1),Va=N('<div class="svelte-pmsc4d"> </div>'),Pa=N('<div class="svelte-pmsc4d"> </div>'),Ba=N('<div class="svelte-pmsc4d"> </div>'),za=N('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Exercise Status</h4> <div class="status-info svelte-pmsc4d"><!> <!> <!></div></div>'),Wa=N('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Ua=N('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Ga=N('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d"> </h4> <div class="shortcuts svelte-pmsc4d"><div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">White Keys:</strong><br/> <!></div> <div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">Black Keys:</strong><br/> <!></div></div></div>'),qa=N('<div class="debug-content svelte-pmsc4d"><!> <!> <!> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Status</h4> <div class="status svelte-pmsc4d"><p class="svelte-pmsc4d">Active Notes: <span class="count svelte-pmsc4d"> </span></p> <p class="svelte-pmsc4d">Virtual MIDI: <span class="status-good svelte-pmsc4d"> </span></p></div></div></div>'),Ya=N('<div><div class="debug-header svelte-pmsc4d"><h3 class="svelte-pmsc4d">ðŸŽ¹ Debug Panel</h3> <button class="toggle-btn svelte-pmsc4d"> </button></div> <!></div>');function Xa(a,e){He(e,!0);let n=Q(e,"debugMode",3,!0),r=Q(e,"noteEvents",19,()=>[]),d=Q(e,"expectedNotes",19,()=>[]),v=Q(e,"currentNotes",19,()=>[]),_=S(()=>d().map(M=>be[M])),k=S(()=>v().map(M=>be[M])),b=O("C"),R=O("maj7"),T=O(4),h=S(()=>{const M=ua(t(T),t(b)),j=Z=>Z.map(F=>({key:F.toUpperCase(),note:be[M[F.toLowerCase()]]})).filter(F=>F.note);return{white:j(["z","x","c","v","b","n","m"]),black:j(["s","d","g","h","j"])}});st(()=>{e.virtualMidi&&(e.virtualMidi.setOctave(t(T)),e.virtualMidi.setRootNote(t(b)))});function I(){if(!e.virtualMidi)return;const M=t(T)*12+12,j=We.indexOf(t(b));if(j===-1)return;const Z=M+j,F=lt(Z,t(R)),A=[F.root,F.third,F.fifth,F.seventh].filter(U=>U!=null&&U!=null);e.virtualMidi.playChord(A)}function p(){e.virtualMidi&&e.virtualMidi.releaseAllKeys()}let f=[];function m(){if(!e.virtualMidi)return;f.forEach(A=>clearTimeout(A)),f=[];const M=t(T)*12+12,j=We.indexOf(t(b));if(j===-1)return;const Z=M+j;[0,2,4,5,7,9,11,12].map(A=>Z+A).forEach((A,U)=>{const Ee=setTimeout(()=>{e.virtualMidi.pressKey(A),setTimeout(()=>e.virtualMidi.releaseKey(A),300)},U*400);f.push(Ee)})}function w(){if(!e.virtualMidi)return;const M=72+Math.floor(Math.random()*24);e.virtualMidi.pressKey(M),setTimeout(()=>e.virtualMidi.releaseKey(M),500)}var E=Ya();let V;var ue=o(E),q=l(o(ue),2);q.__click=function(...M){e.onToggleDebugMode?.apply(this,M)};var W=o(q);s(q),s(ue);var Y=l(ue,2);{var Me=M=>{var j=qa(),Z=o(j);{var F=X=>{var re=Ka(),ne=ke(re),fe=l(o(ne),2),ce=o(fe),ie=l(o(ce));we(ie,21,()=>We,ye,(J,ae)=>{var P=Ha(),xe=o(P,!0);s(P);var de={};H(()=>{C(xe,t(ae)),de!==(de=t(ae))&&(P.value=(P.__value=t(ae))??"")}),y(J,P)}),s(ie),s(ce);var he=l(ce,2),$=l(o(he));we($,20,()=>[2,3,4,5,6],ye,(J,ae)=>{var P=Fa(),xe=o(P,!0);s(P);var de={};H(()=>{C(xe,ae),de!==(de=ae)&&(P.value=(P.__value=ae)??"")}),y(J,P)}),s($),s(he);var ee=l(he,2),L=l(o(ee));we(L,21,()=>ga,ye,(J,ae)=>{var P=La(),xe=o(P,!0);s(P);var de={};H(()=>{C(xe,t(ae)),de!==(de=t(ae))&&(P.value=(P.__value=t(ae))??"")}),y(J,P)}),s(L),s(ee),s(fe),s(ne);var K=l(ne,2),te=l(o(K),2),G=o(te);G.__click=I;var me=o(G);s(G);var oe=l(G,2);oe.__click=p;var le=l(oe,2);le.__click=m;var ve=o(le);s(le);var ge=l(le,2);ge.__click=w,s(te),s(K),H(()=>{C(me,`Play ${t(b)??""}${t(R)??""}`),C(ve,`Play ${t(b)??""} Scale`)}),$e(ie,()=>t(b),J=>g(b,J)),$e($,()=>t(T),J=>g(T,J)),$e(L,()=>t(R),J=>g(R,J)),y(X,re)};z(Z,X=>{e.virtualMidi&&X(F)})}var A=l(Z,2);{var U=X=>{var re=za(),ne=l(o(re),2),fe=o(ne);{var ce=L=>{var K=Va(),te=o(K);s(K),H(G=>C(te,`Expected Notes: ${G??""}`),[()=>t(_).join(", ")]),y(L,K)};z(fe,L=>{d().length>0&&L(ce)})}var ie=l(fe,2);{var he=L=>{var K=Pa(),te=o(K);s(K),H(G=>C(te,`Current Notes: ${G??""}`),[()=>t(k).join(", ")]),y(L,K)};z(ie,L=>{v().length>0&&L(he)})}var $=l(ie,2);{var ee=L=>{var K=Ba(),te=o(K);s(K),H(()=>C(te,`Recent Events: ${r().length??""}`)),y(L,K)};z($,L=>{r().length>0&&L(ee)})}s(ne),s(re),y(X,re)};z(A,X=>{(d().length>0||v().length>0)&&X(U)})}var Ee=l(A,2);{var Ce=X=>{var re=Ga(),ne=o(re),fe=o(ne);s(ne);var ce=l(ne,2),ie=o(ce),he=l(o(ie),3);we(he,17,()=>t(h).white,ye,(L,K)=>{let te=()=>t(K).key,G=()=>t(K).note;var me=Wa(),oe=ke(me),le=o(oe,!0);s(oe);var ve=l(oe,2),ge=o(ve,!0);s(ve),H(()=>{C(le,te()),C(ge,G())}),y(L,me)}),s(ie);var $=l(ie,2),ee=l(o($),3);we(ee,17,()=>t(h).black,ye,(L,K)=>{let te=()=>t(K).key,G=()=>t(K).note;var me=Ua(),oe=ke(me),le=o(oe,!0);s(oe);var ve=l(oe,2),ge=o(ve,!0);s(ve),H(()=>{C(le,te()),C(ge,G())}),y(L,me)}),s($),s(ce),s(re),H(()=>C(fe,`Keyboard Shortcuts (Octave ${t(T)??""})`)),y(X,re)};z(Ee,X=>{e.virtualMidi&&X(Ce)})}var Te=l(Ee,2),Oe=l(o(Te),2),je=o(Oe),Le=l(o(je)),Ne=o(Le,!0);s(Le),s(je);var se=l(je,2),Ke=l(o(se)),Ge=o(Ke,!0);s(Ke),s(se),s(Oe),s(Te),s(j),H(X=>{C(Ne,X),C(Ge,e.virtualMidi?"Connected":"Disconnected")},[()=>e.virtualMidi?e.virtualMidi.getActiveNotes().length:0]),y(M,j)};z(Y,M=>{n()&&M(Me)})}s(E),H(()=>{V=Se(E,1,"debug-panel svelte-pmsc4d",null,V,{visible:n()}),C(W,`${n()?"Hide":"Show"} Debug`)}),y(a,E),Fe()}rt(["click"]);var Ja=N('<div><div class="note-role-dot svelte-ouqkuv"></div></div>'),Qa=N("<div><!></div>");function Za(a,e){He(e,!0);let n=Q(e,"interactive",3,!1),r=Q(e,"noteRoleColor",3,"transparent"),d=Q(e,"isWrongNote",3,!1),v=![1,3,6,8,10].includes(e.noteNum%12),_=O(0);v||([1,6].includes(e.noteNum%12)?g(_,-e.keyWidth/12):[3,10].includes(e.noteNum%12)&&g(_,e.keyWidth/12));function k(){n()&&e.onclick&&e.onclick()}function b(m){n()&&e.onmousedown&&(e.onmousedown(),m.preventDefault())}function R(m){n()&&e.onmouseup&&(e.onmouseup(),m.preventDefault())}function T(m){n()&&e.onmousedown&&(e.onmousedown(),m.preventDefault())}function h(m){n()&&e.onmouseup&&(e.onmouseup(),m.preventDefault())}var I=Qa();na(I,()=>({style:`--width: ${e.keyWidth-e.keyWidth*.47*(v?0:1)}px; --height: ${e.keyHeight??""}px; --note-role-color: ${r()??""}; transform: translate(${t(_)??""}px);`,draggable:"false",onclick:k,onmousedown:b,onmouseup:R,ontouchstart:T,ontouchend:h,role:n()?"button":void 0,...n()?{tabindex:0}:{},[oa]:{accidental:!v,natural:v,pressed:e.pressed,interactive:n(),"wrong-note":d()}}),void 0,void 0,void 0,"svelte-ouqkuv");var p=o(I);{var f=m=>{var w=Ja();let E;H(()=>E=Se(w,1,"note-role-indicator svelte-ouqkuv",null,E,{"natural-indicator":v,"accidental-indicator":!v})),y(m,w)};z(p,m=>{r()&&m(f)})}s(I),y(a,I),Fe()}var $a=N('<div class="keyboard svelte-1dlz8xf"></div>');function es(a,e){He(e,!0);let n=Q(e,"expectedNotes",19,()=>[]),r=Q(e,"showExpected",3,!1),d=O(10),v=O(10),_=S(()=>Math.max(1,Math.min(10,e.octaves||2))),k=S(()=>Math.max(24,Math.min(108,e.middleC||60))),b=S(()=>[...Array(t(_)*12+1).keys()].map(h=>h+(t(k)-Math.floor(t(_)/2)*12))),R=S(()=>t(b).filter(h=>![1,3,6,8,10].includes(h%12)).length);var T=$a();we(T,21,()=>t(b),ye,(h,I)=>{const p=S(()=>r()&&n().includes(t(I))?"#2ecc71":_a[e.noteRoles[t(I)]]),f=S(()=>e.midiNotes.includes(t(I))),m=S(()=>t(f)&&n().length>0&&!n().includes(t(I)));{let w=S(()=>t(d)/t(R));Za(h,{get noteNum(){return t(I)},get pressed(){return t(f)},get keyWidth(){return t(w)},get keyHeight(){return t(v)},get noteRoleColor(){return t(p)},get isWrongNote(){return t(m)}})}}),s(T),jt(T,"clientWidth",h=>g(d,h)),jt(T,"clientHeight",h=>g(v,h)),y(a,T),Fe()}var ts=N('<div id="score-container" class="svelte-25wfcq"><canvas id="output" class="svelte-25wfcq"></canvas></div>');function as(a,e){He(e,!0);let n=null,r=O(!1);et(async()=>{n=await wa(()=>import("./wr6S8XWn.js"),[],import.meta.url),g(r,!0)});const d=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]),v={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","E#":"F","B#":"C"};function _(f){return f.includes("b")?!0:d.has(f)}function k(f){return{"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"}[f]||f}function b(f){const m=/(.*?)(\d+)$/.exec(f);if(!m)return f;let w=m[1];const E=parseInt(m[2],10);return(w==="A#"||w==="D#"||w==="G#"||_(e.selectedNote)&&w.includes("#"))&&(w=v[w]??w),`${w}${E+1}`}const R=f=>f?.map(m=>m.length>1?`(${m.map(w=>b(w)).join(" ")})`:b(m[0])).join(", ")||"";let T=S(()=>R(e.rightHand)),h=S(()=>R(e.leftHand));function I(f){if(!n||!t(r))return;const{Factory:m,Renderer:w,Voice:E}=n,V=f<768,ue=f<480,q=f<360;let W;q?W=200:ue?W=240:V?W=280:W=340;const Y=document.getElementById("output");if(!Y)return;const Me=Y.getContext("2d");if(!Me)return;Me.clearRect(0,0,Y.width,Y.height);const M=new m({renderer:{elementId:"output",backend:w.Backends.CANVAS,width:Math.max(300,f),height:Math.max(200,W)}}),j=M.EasyScore({throwOnError:!1}),Z=V?10:20,F=M.System({width:Math.max(300,f),spaceBetweenStaves:Z,noPadding:V,noJustification:V,formatOptions:{alignRests:!0,autoBeam:!0}});if((!e.rightHand||e.rightHand.length===0)&&(!e.leftHand||e.leftHand.length===0)){console.debug("No notes to render, rendering test chord");const A=`${b("C3")}, ${b("E3")}, ${b("G3")}`;try{const U=F.addStave({voices:[j.voice(j.notes(A,{clef:"treble",stem:"up"})).setMode(E.Mode.SOFT)]});U.addClef("treble"),e.selectedNote&&U.addKeySignature(k(e.selectedNote)),M.draw()}catch(U){console.error("Error rendering test chord:",U)}return}console.debug("Rendering score with notes:",{stringLeftHand:t(h),stringRightHand:t(T)}),console.debug("Selected note for key signature:",e.selectedNote);try{if(e.rightHand&&e.rightHand.length>0&&t(T)){const A=F.addStave({voices:[j.voice(j.notes(t(T),{clef:"treble",stem:"up"})).setMode(E.Mode.SOFT)]});A.addClef("treble"),e.selectedNote&&A.addKeySignature(k(e.selectedNote))}if(e.leftHand&&e.leftHand.length>0&&t(h)){const A=F.addStave({voices:[j.voice(j.notes(t(h),{clef:"bass",stem:"down"})).setMode(E.Mode.SOFT)]});A.addClef("bass"),e.selectedNote&&A.addKeySignature(k(e.selectedNote))}e.rightHand&&e.rightHand.length>0&&e.leftHand&&e.leftHand.length>0&&(F.addConnector("brace"),F.addConnector("single")),M.draw()}catch(A){console.error("Error rendering VexFlow score:",A)}}st(()=>{t(r)&&(console.debug("Score $effect triggered with props:",{leftHand:e.leftHand,rightHand:e.rightHand,selectedNote:e.selectedNote}),setTimeout(()=>{const f=document.getElementById("score-container");if(f){const m=f.getBoundingClientRect().width;m>0&&I(m)}},100))}),et(()=>{const f=()=>{const m=document.getElementById("score-container");if(m){const w=m.getBoundingClientRect().width;console.debug(`Container width: ${w}`),w>0&&I(w)}};return window.addEventListener("resize",f),()=>{window.removeEventListener("resize",f)}});var p=ts();y(a,p),Fe()}var ss=N('<div class="star-wrapper svelte-h6yjv8"><!></div>'),rs=N('<div class="modal-overlay svelte-h6yjv8"><div class="modal-content svelte-h6yjv8"><div class="modal-header"><h2 class="svelte-h6yjv8">Lesson Complete!</h2> <div class="stars-container svelte-h6yjv8"></div></div> <div class="stats-grid svelte-h6yjv8"><div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">Accuracy</span> <span class="stat-value svelte-h6yjv8"> </span></div> <div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">XP Gained</span> <span class="stat-value svelte-h6yjv8"> </span></div></div> <div class="modal-actions svelte-h6yjv8"><button class="retry-btn svelte-h6yjv8"><!> Retry</button> <button class="continue-btn svelte-h6yjv8">Continue <!></button></div></div></div>');function ns(a,e){var n=At(),r=ke(n);{var d=v=>{var _=rs(),k=o(_),b=o(k),R=l(o(b),2);we(R,20,()=>Array(3),ye,(Y,Me,M)=>{var j=ss();It(j,`animation-delay: ${M*200}ms`);var Z=o(j);{let F=S(()=>M<e.stars?"star-filled":"star-empty"),A=S(()=>M<e.stars?"#ffd700":"none"),U=S(()=>M<e.stars?"#ffd700":"currentColor");ya(Z,{size:48,get class(){return t(F)},get fill(){return t(A)},get stroke(){return t(U)}})}s(j),y(Y,j)}),s(R),s(b);var T=l(b,2),h=o(T),I=l(o(h),2),p=o(I);s(I),s(h);var f=l(h,2),m=l(o(f),2),w=o(m);s(m),s(f),s(T);var E=l(T,2),V=o(E);V.__click=function(...Y){e.onRetry?.apply(this,Y)};var ue=o(V);xa(ue,{size:20}),ea(),s(V);var q=l(V,2);q.__click=function(...Y){e.onContinue?.apply(this,Y)};var W=l(o(q));Ma(W,{size:20}),s(q),s(E),s(k),s(_),H(()=>{C(p,`${e.accuracy??""}%`),C(w,`+${e.xp??""}`)}),Ue(3,k,()=>ca),Ue(3,_,()=>tt),y(v,_)};z(r,v=>{e.isOpen&&v(d)})}y(a,n)}rt(["click"]);var os=N("<option> </option>"),is=N('<div class="control-group svelte-w7gj7d"><label for="note-select" class="svelte-w7gj7d">Root Key</label> <select id="note-select" class="svelte-w7gj7d"></select></div>'),ls=N('<div class="control-group svelte-w7gj7d"><!></div>'),ds=N('<div class="control-group svelte-w7gj7d"><label for="tempo-toggle" class="svelte-w7gj7d">Tempo Mode</label> <button id="tempo-toggle"> </button></div> <!>',1),cs=N('<div class="control-group svelte-w7gj7d"><label for="training-mode-toggle" class="svelte-w7gj7d">Training Mode</label> <button id="training-mode-toggle" title="If enabled, mistakes will stop the lesson until you correct it"> </button></div>'),vs=N('<div class="exercise-description svelte-w7gj7d"><span class="info-icon svelte-w7gj7d">? <span class="desc-tooltip svelte-w7gj7d"> </span></span></div>'),us=N('<div class="feedback-toast svelte-w7gj7d"> </div>'),fs=N('<div class="prompt-card card-premium svelte-w7gj7d"><div class="prompt-text svelte-w7gj7d"> </div></div>'),hs=N('<div class="score-container card-premium svelte-w7gj7d"><!></div>'),ms=N('<div class="adaptive-help-text"> </div>'),gs=N('<div class="debug-panel-wrapper"><!></div>'),_s=N('<div class="exercise-layout"><aside class="sidebar glass svelte-w7gj7d"><div class="sidebar-header svelte-w7gj7d"><h3 class="svelte-w7gj7d">Exercise Controls</h3></div> <div class="sidebar-content"><!> <!> <!> <div class="control-group svelte-w7gj7d"><label for="debug-toggle" class="svelte-w7gj7d">Virtual Keyboard</label> <button id="debug-toggle"> </button></div> <div class="sidebar-spacer"></div> <button class="reset-btn svelte-w7gj7d">Reset Session</button></div></aside> <main class="exercise-main svelte-w7gj7d"><header class="exercise-header svelte-w7gj7d"><div class="info-group svelte-w7gj7d"><!> <h1 class="svelte-w7gj7d"> </h1></div> <div class="performance-strip svelte-w7gj7d"><div><span class="label">Mistakes:</span> <span class="value"> </span></div> <div class="stat-pill success svelte-w7gj7d"><span class="label">Progress:</span> <span class="value"> </span></div></div></header> <!> <div class="focus-area svelte-w7gj7d"><!> <!> <!> <div><!></div> <div class="exercise-custom-content"><!></div></div> <!> <footer class="exercise-footer svelte-w7gj7d"><div class="progress-track svelte-w7gj7d"><div class="progress-fill svelte-w7gj7d"></div></div></footer></main></div> <!>',1);function Vs(a,e){He(e,!0);let n=Q(e,"randomMode",3,!1),r=Q(e,"exerciseType",3,"chord"),d=Q(e,"progressiveHints",3,!0),v=Q(e,"showTempoControl",3,!0),_=Q(e,"showTrainingControl",3,!0),k=Q(e,"timingModeLabel",3,"Play on beat");const b=1,R=3,T=3;let h=O(Ze(e.initialNote??"C"));st(()=>{e.initialNote!==void 0&&e.initialNote!==t(h)&&(g(h,e.initialNote,!0),$())});let I=O(Ze([])),p=O(0),f=O(Ze(new Set)),m=O(0),w=O(!1),E=O(!1),V=O(""),ue=!1,q=O(!1),W=O(!1),Y=O(0),Me=120,M=O(0),j=O(!1);const Z=150;let F=S(()=>e.showScore===!1?!1:r()==="partition"?!0:d()?t(p)>=b:e.showScore??!0);const A=S(()=>Tt.url.searchParams.get("unitId")),U=S(()=>Tt.url.searchParams.get("lessonId")),Ee=S(()=>!!t(A)&&!!t(U));let Ce=O(!1),Te=O(0),Oe=O(0),je=O(0),Le=S(()=>t(p)>=T),Ne=S(()=>t(I).map(i=>i.noteNumber)),se=S(()=>e.generateExpectedNotes(t(h))),Ke=S(()=>e.generateScoreProps(t(h))),Ge=S(()=>t(E)||d()&&t(p)>=R),X=S(()=>({...Oa(t(se)),midiNotes:t(Ne),debugMode:t(E),noteRoles:Object.fromEntries(t(se).map(i=>[i,Da(i,ot[`${t(h)}${nt}`])])),expectedNotes:t(se),showExpected:t(Le)})),re=S(()=>{if(t(se).length===0)return 0;const i=[...new Set(t(se))];return Math.round(t(f).size/i.length*100)}),ne=S(()=>{if(!d()||t(w)||r()==="partition")return"";if(t(p)<b){let i=`correct ${r()||"note"}`;if(e.prompt){const c=r()==="II-V-I"?"progression":r()==="note"?"note":r();i=`${e.prompt} ${c}`}return`Play the ${i}. After ${b-t(p)} more mistake${b-t(p)===1?"":"s"} the score will appear.`}return t(p)<R?`Reference keyboard will appear after ${R-t(p)} more mistake${R-t(p)===1?"":"s"}.`:"Adaptive help is active. Use the score and keyboard for reference."});const fe=S(()=>({selectedNote:t(h),currentNotes:t(Ne),expectedNotes:t(se),mistakes:t(p),completed:t(w),collectedNotes:t(f),debugMode:t(E),feedbackMessage:t(V),showNotesRoles:ue,tempoMode:t(W),toggleDebug:G,showFeedback:ee,toggleTempoMode:le,handleTick:oe,completeExercise:i=>L(i)}));Qt(()=>{Re.cleanup()}),et(async()=>{await Re.initialize(),Re.setupVirtualKeyboard(),Re.setEventHandlers({onNoteOn:ce,onNoteOff:ie}),g(m,Date.now(),!0);const i=async()=>{if(De.needsUserGesture()){const c=await De.unlock();ee(c?"Audio enabled":"Click or press any key to enable audio","info")}};window.addEventListener("pointerdown",i,{once:!0}),window.addEventListener("keydown",i,{once:!0})});function ce(i){t(E)&&console.debug(`MIDI Note ON: ${i.noteNumber} (${i.noteFullName}) velocity=${i.velocity} channel=${i.channel}`);let c=!1;if(t(W)){const B={timestamp:t(Y),beatNumber:t(M),isDownbeat:t(j)},_e={toleranceMs:Z,requireDownbeat:r()==="chord"||r()==="progression"||r()==="II-V-I"};if(r()==="partition"||r()==="rhythm"||t(f).size===0){const Ae=ka(i,B,_e,Me);Ae&&(ee(Ae,"error"),Ct(p),c=!0,De.playError())}}g(I,[...t(I),i],!0);const u=e.validateNoteEvent(t(h),i,t(se),t(Ne));if(u.resetCollected&&g(f,new Set,!0),"resetMistakes"in u&&u.resetMistakes&&g(p,0),u.collected&&!c&&t(f).add(i.noteNumber),u.isCorrect)c||ee(u.message,"success");else{if(!c){Ct(p),ee(u.message,"error"),De.playError();const B=r()==="II-V-I"?"progression":r()==="note"||r()==="interval"?"chord":r();if(B!=="rhythm"&&(ze.trackMissedNote(i.noteName,B),B==="chord"||B==="progression")){const _e=`${t(h)}-${e.prompt??r()??"unknown"}`;ze.trackMissedChord(_e,B)}}if(t(q)){g(V,"error : Mistake! Take your time...");return}}if(r()){const B=r()==="II-V-I"?"progression":r()==="note"||r()==="interval"?"chord":r();ze.updateNoteProgress(i.noteName,B,void 0,u.isCorrect,0,u.isCorrect?100:0)}const D=[...t(Ne),i.noteNumber];e.isCompleted(D,t(se))&&L()}function ie(i){t(E)&&console.debug(`MIDI Note OFF: ${i.noteNumber} (${i.noteFullName}) channel=${i.channel}`),g(I,t(I).filter(c=>c.noteNumber!==i.noteNumber),!0)}function he(i){g(h,i,!0),$()}function $(){g(I,[],!0),g(p,0),g(w,!1),g(V,""),g(m,Date.now(),!0),g(h,t(h),!0),g(f,new Set,!0),e.onReset?.()}function ee(i,c){g(V,`${c} : ${i}`),setTimeout(()=>{g(V,"")},5e3)}function L(i){g(w,!0);const c=Date.now()-t(m),u=t(se).length,D=u>0?Math.max(0,Math.round((u-t(p))/u*100)):0;if(ee(`Exercise completed! Time: ${c}ms, Accuracy: ${D}%`,"success"),De.playSound?.("success"),r()){const B=r()==="II-V-I"?"progression":r()==="note"||r()==="interval"?"chord":r();ze.recordExerciseResult({exerciseId:window.location.pathname,exerciseType:B,success:!0,accuracy:D,timeElapsed:c,mistakes:t(p),score:Math.max(0,100-t(p)*10),timestamp:new Date,...i})}t(Ee)&&t(A)&&t(U)?(g(Te,t(p)===0?3:t(p)<=2?2:1,!0),g(Oe,D,!0),g(je,Math.max(0,100-t(p)*10),!0),pa.completeLesson(t(A),t(U),t(Te)),g(Ce,!0)):(e.onComplete?.(),$())}function K(){g(Ce,!1),ba(da("/journey"))}function te(){g(Ce,!1),$()}function G(){g(E,!t(E)),Re.setDebugMode(t(E))}function me(i){const u=i.target.value;he(u)}function oe(i,c,u){g(Y,i,!0),g(M,c,!0),g(j,u,!0)}function le(){g(W,!t(W))}var ve=_s(),ge=ke(ve),J=o(ge),ae=l(o(J),2),P=o(ae);{var xe=i=>{var c=is(),u=l(o(c),2);u.__change=me,we(u,21,()=>We,ye,(B,_e)=>{var pe=os(),Ae=o(pe,!0);s(pe);var Ie={};H(()=>{C(Ae,t(_e)),Ie!==(Ie=t(_e))&&(pe.value=(pe.__value=t(_e))??"")}),y(B,pe)}),s(u);var D;ia(u),s(c),H(()=>{D!==(D=t(h))&&(u.value=(u.__value=t(h))??"",la(u,t(h)))}),y(i,c)};z(P,i=>{n()||i(xe)})}var de=l(P,2);{var Rt=i=>{var c=ds(),u=ke(c),D=l(o(u),2);let B;D.__click=le;var _e=o(D,!0);s(D),s(u);var pe=l(u,2);{var Ae=Ie=>{var Qe=ls(),Jt=o(Qe);fa(Jt,{onTick:oe}),s(Qe),y(Ie,Qe)};z(pe,Ie=>{t(W)&&Ie(Ae)})}H(()=>{B=Se(D,1,"toggle-btn svelte-w7gj7d",null,B,{active:t(W)}),C(_e,t(W)?`${k()} âœ“`:k())}),y(i,c)};z(de,i=>{v()&&i(Rt)})}var dt=l(de,2);{var Ot=i=>{var c=cs(),u=l(o(c),2);u.__click=()=>g(q,!t(q));let D;var B=o(u,!0);s(u),s(c),H(()=>{D=Se(u,1,"toggle-btn svelte-w7gj7d",null,D,{active:t(q)}),C(B,t(q)?"Stop on Mistake":"Free Play")}),y(i,c)};z(dt,i=>{_()&&i(Ot)})}var qe=l(dt,2),Ve=l(o(qe),2);Ve.__click=G;let ct;var Dt=o(Ve,!0);s(Ve),s(qe);var Ht=l(qe,4);Ht.__click=$,s(ae),s(J);var vt=l(J,2),Ye=o(vt),Xe=o(Ye),ut=o(Xe);{var Ft=i=>{var c=vs(),u=o(c),D=l(o(u)),B=o(D,!0);s(D),s(u),s(c),H(()=>C(B,e.description)),y(i,c)};z(ut,i=>{e.description&&i(Ft)})}var ft=l(ut,2),Lt=o(ft,!0);s(ft),s(Xe);var ht=l(Xe,2),Pe=o(ht);let mt;var gt=l(o(Pe),2),Kt=o(gt,!0);s(gt),s(Pe);var _t=l(Pe,2),bt=l(o(_t),2),Vt=o(bt);s(bt),s(_t),s(ht),s(Ye);var pt=l(Ye,2);{var Pt=i=>{var c=us(),u=o(c,!0);s(c),H(()=>C(u,t(V))),Ue(3,c,()=>tt),y(i,c)};z(pt,i=>{t(V)&&i(Pt)})}var Je=l(pt,2),wt=o(Je);{var Bt=i=>{var c=fs(),u=o(c),D=o(u,!0);s(u),s(c),H(()=>C(D,e.prompt)),y(i,c)};z(wt,i=>{e.prompt&&i(Bt)})}var yt=l(wt,2);{var zt=i=>{var c=hs(),u=o(c);as(u,at(()=>t(Ke))),s(c),Ue(1,c,()=>tt),y(i,c)};z(yt,i=>{t(F)&&i(zt)})}var Mt=l(yt,2);{var Wt=i=>{var c=ms(),u=o(c,!0);s(c),H(()=>C(u,t(ne))),y(i,c)};z(Mt,i=>{t(ne)&&i(Wt)})}var Be=l(Mt,2);let Nt;var Ut=o(Be);es(Ut,at(()=>t(X))),s(Be);var xt=l(Be,2),Gt=o(xt);ra(Gt,()=>e.children??ta,()=>t(fe)),s(xt),s(Je);var St=l(Je,2);{var qt=i=>{var c=gs(),u=o(c);{let D=S(()=>Re.getVirtualMidi()??void 0);Xa(u,{get noteEvents(){return t(I)},get expectedNotes(){return t(se)},get currentNotes(){return t(Ne)},get debugMode(){return t(E)},onToggleDebugMode:G,get virtualMidi(){return t(D)}})}s(c),y(i,c)};z(St,i=>{t(E)&&i(qt)})}var kt=l(St,2),Et=o(kt),Yt=o(Et);s(Et),s(kt),s(vt),s(ge);var Xt=l(ge,2);ns(Xt,{get isOpen(){return t(Ce)},get stars(){return t(Te)},get accuracy(){return t(Oe)},get xp(){return t(je)},onContinue:K,onRetry:te}),H(i=>{ct=Se(Ve,1,"toggle-btn svelte-w7gj7d",null,ct,{active:t(E)}),C(Dt,t(E)?"Visible":"Hidden"),C(Lt,i),mt=Se(Pe,1,"stat-pill svelte-w7gj7d",null,mt,{neutral:t(p)===0,warn:t(p)>0}),C(Kt,t(p)),C(Vt,`${t(re)??""}%`),Nt=Se(Be,1,"keyboard-container svelte-w7gj7d",null,Nt,{hidden:!t(Ge)}),It(Yt,`width: ${t(re)??""}%`)},[()=>r()?.toUpperCase()||"PRACTICE"]),y(a,ve),Fe()}rt(["change","click"]);export{Vs as B,lt as a,Ea as b,Ks as c,Ia as d,Ls as e,Ra as f,Fs as g};
