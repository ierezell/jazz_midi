import{M as T}from"./CXrKfc7O.js";import{w as K}from"./C4peLJJm.js";import{_ as V}from"./PPVm8Dsz.js";import{c as F,a as S,f as G}from"./Bdvgn338.js";import{f as Q,p as q,c as g,k as u,U as E,r as v,s as O,t as z,a as j,Z as f}from"./ZtE6Gyvq.js";import{d as U,s as W}from"./BnZ86L-c.js";import{i as Z}from"./CdTPX8-T.js";import{r as J,b as X,g as Y}from"./U2hmf67d.js";import"./BUbxQ3bP.js";import{I as ee,s as te}from"./BFmSp7VO.js";import{l as se,s as ie}from"./-nZJNBOr.js";import{P as ne}from"./DVdHlkhT.js";function oe(a,e){const t=se(e,["children","$$slots","$$events","$$legacy"]);const s=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1"}]];ee(a,ie({name:"pause"},()=>t,{get iconNode(){return s},children:(i,o)=>{var n=F(),r=Q(n);te(r,e,"default",{}),S(i,n)},$$slots:{default:!0}}))}class re{constructor(e={}){this.options=e,this.options={velocity:100,channel:0,...e}}listeners=[];activeNotes=new Set;currentOctave=4;rootNoteOffset=0;rootNoteName="C";addEventListener(e,t){e==="midimessage"&&this.listeners.push(t)}removeEventListener(e,t){if(e==="midimessage"){const s=this.listeners.indexOf(t);s>-1&&this.listeners.splice(s,1)}}pressKey(e,t=this.options.velocity||100){if(this.activeNotes.has(e))return;this.activeNotes.add(e);const s=this.createMidiMessage(144,e,t);this.dispatchMidiEvent(s)}releaseKey(e){if(!this.activeNotes.has(e))return;this.activeNotes.delete(e);const t=this.createMidiMessage(128,e,0);this.dispatchMidiEvent(t)}releaseAllKeys(){for(const e of this.activeNotes)this.releaseKey(e)}getActiveNotes(){return Array.from(this.activeNotes)}playChord(e,t=this.options.velocity||100){e.forEach(s=>this.pressKey(s,t))}setOctave(e){this.currentOctave=Math.max(0,Math.min(8,e))}getOctave(){return this.currentOctave}setRootNote(e){const t={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};this.rootNoteOffset=t[e]||0,this.rootNoteName=e}getRootNote(){return this.rootNoteName}createMidiMessage(e,t,s){return new Uint8Array([e|(this.options.channel||0),t,s])}dispatchMidiEvent(e){const t={data:e,timeStamp:performance.now(),type:"midimessage"};this.listeners.forEach(s=>s(t))}}function ae(a="Virtual MIDI Keyboard"){const e=new re,t={id:"virtual-midi-input",manufacturer:"Virtual",name:a,type:"input",version:"1.0.0",state:"connected",connection:"open",onmidimessage:null,onstatechange:null,addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e),dispatchEvent:()=>!1,open:()=>Promise.resolve(t),close:()=>Promise.resolve(t),_virtualInput:e};return Object.defineProperty(t,"onmidimessage",{get(){return this._onmidimessage},set(n){this._onmidimessage=n,n&&e.addEventListener("midimessage",n)}}),{inputs:new Map([["virtual-midi-input",t]]),outputs:new Map,sysexEnabled:!1,onstatechange:null,addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1,getVirtualInput:()=>e}}const L={z:0,x:2,c:4,v:5,f:5,b:7,n:9,m:11,",":12,".":14,"/":16,s:1,d:3,g:6,h:8,j:10,l:13,";":15,"'":17,q:12,w:14,e:16,r:17,t:19,y:21,u:23,i:24,o:26,p:28,"[":29,"]":31,2:1,3:3,5:6,6:8,7:10,9:13,0:15,"=":20};function x(a,e){const t={},s=a*12+12;let i=0;e&&(i={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11}[e]||0);for(const[o,n]of Object.entries(L)){const r=s+i+n;r>=24&&r<=127&&(t[o]=r)}return t}function _(a,e=!1){const t=new Set;function s(o){if(!e)return;const n=o.key.toLowerCase();console.debug("Key pressed:",n);const r=x(a.getOctave(),a.getRootNote());if(r[n]&&!t.has(n)){t.add(n);const c=r[n];console.debug(`Pressing MIDI note ${c} for key '${n}' (octave ${a.getOctave()})`),a.pressKey(c),o.preventDefault()}}function i(o){if(!e)return;const n=o.key.toLowerCase(),r=x(a.getOctave(),a.getRootNote());if(r[n]&&t.has(n)){t.delete(n);const c=r[n];console.debug(`Releasing MIDI note ${c} for key '${n}' (octave ${a.getOctave()})`),a.releaseKey(c),o.preventDefault()}}return e?console.debug("Virtual keyboard input setup complete. Available keys:",Object.keys(L),"Base octave:",a.getOctave()):console.debug("Virtual keyboard input setup (keyboard disabled)"),document.addEventListener("keydown",s),document.addEventListener("keyup",i),()=>{console.debug("Virtual keyboard input cleanup"),document.removeEventListener("keydown",s),document.removeEventListener("keyup",i)}}class p{static instance;basicPitch=null;audioContext=null;isRecording=!1;listeners=[];stream=null;sourceNode=null;processorNode=null;audioBufferQueue=[];isProcessing=!1;currentNote=null;noteConfidence=0;CONFIDENCE_THRESHOLD=3;SILENCE_THRESHOLD=5;silenceCounter=0;constructor(){}static getInstance(){return p.instance||(p.instance=new p),p.instance}isStarting=!1;async start(){if(!(this.isRecording||this.isStarting)){this.isStarting=!0;try{if(!this.basicPitch){const{BasicPitch:s}=await V(async()=>{const{BasicPitch:i}=await import("./CAYENW2a.js");return{BasicPitch:i}},[],import.meta.url);this.basicPitch=new s("https://unpkg.com/@spotify/basic-pitch@1.0.1/model/model.json")}const e=new AudioContext({sampleRate:22050});await e.resume();const t=await navigator.mediaDevices.getUserMedia({audio:!0});if(!this.isStarting){console.debug("AudioInputService: start() aborted"),t.getTracks().forEach(s=>s.stop()),e.close();return}this.audioContext=e,this.stream=t,this.sourceNode=this.audioContext.createMediaStreamSource(this.stream),this.processorNode=this.audioContext.createScriptProcessor(4096,1,1),this.processorNode.onaudioprocess=s=>{const i=s.inputBuffer.getChannelData(0);this.audioBufferQueue.push(new Float32Array(i)),this.processQueue()},this.sourceNode.connect(this.processorNode),this.processorNode.connect(this.audioContext.destination),this.isRecording=!0,console.log("AudioInputService started")}catch(e){throw console.error("Error starting audio input:",e),this.stop(),e}finally{this.isStarting=!1}}}stop(){this.isStarting=!1,this.isRecording&&(this.isRecording=!1,this.processorNode&&(this.processorNode.disconnect(),this.processorNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.currentNote=null,this.noteConfidence=0,this.silenceCounter=0,this.audioBufferQueue=[])}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}async processQueue(){if(!(this.isProcessing||this.audioBufferQueue.length===0||!this.basicPitch||!this.audioContext)){this.isProcessing=!0;try{for(;this.audioBufferQueue.length>0;){const e=this.audioBufferQueue.shift();if(!e)continue;const t=this.audioContext.createBuffer(1,e.length,this.audioContext.sampleRate);t.copyToChannel(e,0),await this.basicPitch.evaluateModel(t,(s,i,o)=>{let n=0,r=-1;for(let c=0;c<s.length;c++)for(let d=0;d<s[c].length;d++)s[c][d]>n&&(n=s[c][d],r=d);if(n>.3){const c=r+21;this.handleDetectedNote(c)}else this.handleSilence()},()=>{})}}catch(e){console.error("Error processing audio chunk:",e)}finally{this.isProcessing=!1}}}handleSilence(){this.silenceCounter++,this.silenceCounter>this.SILENCE_THRESHOLD&&(this.activeNote!==null&&this.sendNoteOff(this.activeNote),this.currentNote=null,this.noteConfidence=0)}handleDetectedNote(e){const t=Math.round(e);t===this.currentNote?(this.noteConfidence++,this.silenceCounter=0):this.currentNote===null?(this.currentNote=t,this.noteConfidence=1):(this.currentNote=t,this.noteConfidence=1),this.noteConfidence>=this.CONFIDENCE_THRESHOLD&&this.sendNoteOn(t)}activeNote=null;sendNoteOn(e){this.activeNote!==e&&(this.activeNote!==null&&this.sendNoteOff(this.activeNote),this.activeNote=e,this.notifyListeners(e,100,!0))}sendNoteOff(e){this.activeNote===e&&(this.activeNote=null,this.notifyListeners(e,0,!1))}notifyListeners(e,t,s){const i=s?144:128,o=new Uint8Array([i,e,t]),n=new MIDIMessageEvent("midimessage",{data:o});this.listeners.forEach(r=>r(n))}}const y=p.getInstance();class ce{midiAccess=null;virtualMidi=null;keyboardCleanup=null;eventHandlers={};errorCallbacks=[];debugMode=!1;audioInputEnabled=!1;midiState=K({inputs:[],outputs:[]});constructor(){y.addListener(e=>{this.handleMIDIMessage(e)})}async initialize(){try{return await this.connectMIDI(),this.setupAudioInput(),!0}catch(e){return this.handleError(e),!1}}async connectMIDI(){try{return this.midiAccess=await this.safeRequestMidiAccess({sysex:!1}),this.midiAccess?(this.safeSetupMidiCallback(this.midiAccess,this.handleMIDIMessage.bind(this),this.handleError.bind(this)),console.debug("MIDI Manager: Connected to physical MIDI devices"),this.updateMidiState(),!0):(this.midiState.set({inputs:[],outputs:[]}),console.info("MIDI unavailable. Running in fallback mode (virtual keyboard/audio only)."),!1)}catch(e){return console.warn("Could not initialize MIDI devices. Fallback mode enabled.",e),!1}}async safeRequestMidiAccess(e){try{if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser"),null;const t=await navigator.requestMIDIAccess(e||{sysex:!1});return console.debug("MIDI Access obtained successfully"),t}catch(t){return console.warn("Failed to obtain MIDI access:",t),null}}safeSetupMidiCallback(e,t,s){try{e.inputs.forEach(i=>{const o=`Input port [type:'${i.type}'] id:'${i.id}' manufacturer:'${i.manufacturer}' name:'${i.name}' version:'${i.version}'`;console.debug(`Setting up MIDI input: ${o}`),i.onmidimessage=n=>{try{t(n)}catch(r){console.error("Error in MIDI message callback:",r),s&&s(r)}}}),e.onstatechange=i=>{const o=i.port;console.debug(`MIDI port state changed: ${o.name} is now ${o.state}`),this.updateMidiState()}}catch(i){console.error("Error setting up MIDI callback:",i),s&&s(i)}}setupVirtualKeyboard(){try{const e=ae("Virtual Debug Keyboard");this.virtualMidi=e.getVirtualInput(),this.keyboardCleanup=_(this.virtualMidi,this.debugMode);const t=Array.from(e.inputs.values())[0];t&&(t.onmidimessage=this.handleMIDIMessage.bind(this)),console.debug("MIDI Manager: Virtual keyboard enabled")}catch(e){this.handleError(e)}}setDebugMode(e){this.debugMode=e,this.virtualMidi&&(this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.keyboardCleanup=_(this.virtualMidi,this.debugMode),console.debug(`MIDI Manager: Debug mode ${e?"enabled":"disabled"}`))}setupAudioInput(){y.addListener(e=>{this.audioInputEnabled&&this.handleMIDIMessage(e)})}async setAudioInput(e){this.audioInputEnabled=e,e?(await y.start(),console.debug("MIDI Manager: Audio input enabled")):(y.stop(),console.debug("MIDI Manager: Audio input disabled"))}getVirtualMidi(){return this.virtualMidi}safeGetMidiNote(e){try{if(!e.data||e.data.length<3)return console.warn("Invalid MIDI message data"),null;const[t,s,i]=e.data,o=t&240,n=t&15;if(o!==144&&o!==128)return null;if(s<24||s>127)return console.warn(`MIDI note ${s} out of valid range (24-127)`),null;const r=s,c=T[r];if(!c)return console.error(`No note name found for MIDI note ${r}`),null;const d=o===144&&i>0;return{noteNumber:r,type:d?"on":"off",noteFullName:c,noteName:c.slice(0,-1),velocity:i||0,timestamp:e.timeStamp||performance.now(),channel:n}}catch(t){return console.error("Error parsing MIDI message:",t),null}}handleMIDIMessage(e){try{const t=this.safeGetMidiNote(e);if(!t)return;t.type==="on"&&this.eventHandlers.onNoteOn?this.eventHandlers.onNoteOn(t):t.type==="off"&&this.eventHandlers.onNoteOff&&this.eventHandlers.onNoteOff(t)}catch(t){this.handleError(t)}}setEventHandlers(e){this.eventHandlers={...this.eventHandlers,...e}}handleError(e){console.error("MIDI Manager Error:",e),this.errorCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in error callback:",s)}}),this.eventHandlers.onError&&this.eventHandlers.onError(e)}getMIDIDevices(){return this.midiAccess?{inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())}:{inputs:[],outputs:[]}}cleanup(){this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.virtualMidi&&(this.virtualMidi.releaseAllKeys(),this.virtualMidi=null),this.midiAccess&&(this.midiAccess.inputs.forEach(e=>{e.onmidimessage=null}),this.midiAccess.onstatechange=null),this.eventHandlers={},this.errorCallbacks=[],console.debug("MIDI Manager: Cleaned up all connections")}updateMidiState(){this.midiAccess&&this.midiState.set({inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())})}}const Ne=new ce;var le=G('<div class="metronome svelte-1lsk5dc"><div class="controls svelte-1lsk5dc"><button><!></button> <div class="bpm-control svelte-1lsk5dc"><span class="bpm-display svelte-1lsk5dc"> </span> <input type="range" min="40" max="240" class="bpm-slider svelte-1lsk5dc"/></div></div></div>');function Ee(a,e){q(e,!0);let t=E(120),s=E(!1),i=null,o=null,n=4,r=E(1);function c(){u(s)?D():d()}function d(){o||(o=new AudioContext),f(s,!0),f(r,1);const l=60/u(t)*1e3;C(),i=window.setInterval(C,l)}function D(){f(s,!1),i&&(clearInterval(i),i=null),f(r,1)}function C(){if(!o)return;const l=o.createOscillator(),h=o.createGain();l.connect(h),h.connect(o.destination);const N=u(r)===1;l.frequency.value=N?1200:1e3,h.gain.value=N?.7:.5,l.start(),h.gain.exponentialRampToValueAtTime(.001,o.currentTime+.1),l.stop(o.currentTime+.1),e.onTick?.(Date.now(),u(r),N),f(r,u(r)>=n?1:u(r)+1,!0)}function P(l){const h=l.target;f(t,parseInt(h.value),!0),u(s)&&(D(),d())}var b=le(),k=g(b),m=g(k);let A;m.__click=c;var $=g(m);{var R=l=>{oe(l,{size:20})},B=l=>{ne(l,{size:20})};Z($,l=>{u(s)?l(R):l(B,!1)})}v(m);var w=O(m,2),I=g(w),H=g(I);v(I);var M=O(I,2);J(M),M.__input=P,v(w),v(k),v(b),z(()=>{A=X(m,1,"toggle-btn svelte-1lsk5dc",null,A,{playing:u(s)}),W(H,`${u(t)??""} BPM`),Y(M,u(t))}),S(a,b),j()}U(["click","input"]);export{Ee as M,x as g,Ne as m};
