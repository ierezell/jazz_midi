import{M as R}from"./CXrKfc7O.js";import{w as H}from"./C4peLJJm.js";import{_ as B}from"./PPVm8Dsz.js";import{c as T,a as O,f as K}from"./Bdvgn338.js";import{f as V,p as F,c as m,k as d,U as C,r as g,s as k,t as G,a as Q,Z as M}from"./ZtE6Gyvq.js";import{d as q,s as j}from"./BnZ86L-c.js";import{i as z}from"./CdTPX8-T.js";import{r as U,c as W,f as Z}from"./DCl1R5v8.js";import"./BUbxQ3bP.js";import{I as J,s as X}from"./D2DpM-zo.js";import{l as Y,s as ee}from"./-nZJNBOr.js";import{P as te}from"./BgcQp6Yp.js";function se(c,e){const t=Y(e,["children","$$slots","$$events","$$legacy"]);const s=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1"}]];J(c,ee({name:"pause"},()=>t,{get iconNode(){return s},children:(i,o)=>{var n=T(),r=V(n);X(r,e,"default",{}),O(i,n)},$$slots:{default:!0}}))}class ie{constructor(e={}){this.options=e,this.options={velocity:100,channel:0,...e}}listeners=[];activeNotes=new Set;currentOctave=4;rootNoteOffset=0;rootNoteName="C";addEventListener(e,t){e==="midimessage"&&this.listeners.push(t)}removeEventListener(e,t){if(e==="midimessage"){const s=this.listeners.indexOf(t);s>-1&&this.listeners.splice(s,1)}}pressKey(e,t=this.options.velocity||100){if(this.activeNotes.has(e))return;this.activeNotes.add(e);const s=this.createMidiMessage(144,e,t);this.dispatchMidiEvent(s)}releaseKey(e){if(!this.activeNotes.has(e))return;this.activeNotes.delete(e);const t=this.createMidiMessage(128,e,0);this.dispatchMidiEvent(t)}releaseAllKeys(){for(const e of this.activeNotes)this.releaseKey(e)}getActiveNotes(){return Array.from(this.activeNotes)}playChord(e,t=this.options.velocity||100){e.forEach(s=>this.pressKey(s,t))}setOctave(e){this.currentOctave=Math.max(0,Math.min(8,e))}getOctave(){return this.currentOctave}setRootNote(e){const t={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};this.rootNoteOffset=t[e]||0,this.rootNoteName=e}getRootNote(){return this.rootNoteName}createMidiMessage(e,t,s){return new Uint8Array([e|(this.options.channel||0),t,s])}dispatchMidiEvent(e){const t={data:e,timeStamp:performance.now(),type:"midimessage"};this.listeners.forEach(s=>s(t))}}function ne(c="Virtual MIDI Keyboard"){const e=new ie,t={id:"virtual-midi-input",manufacturer:"Virtual",name:c,type:"input",version:"1.0.0",state:"connected",connection:"open",onmidimessage:null,onstatechange:null,addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e),dispatchEvent:()=>!1,open:()=>Promise.resolve(t),close:()=>Promise.resolve(t),_virtualInput:e};return Object.defineProperty(t,"onmidimessage",{get(){return this._onmidimessage},set(n){this._onmidimessage=n,n&&e.addEventListener("midimessage",n)}}),{inputs:new Map([["virtual-midi-input",t]]),outputs:new Map,sysexEnabled:!1,onstatechange:null,addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1,getVirtualInput:()=>e}}const x={z:0,x:2,c:4,v:5,f:5,b:7,n:9,m:11,",":12,".":14,"/":16,s:1,d:3,g:6,h:8,j:10,l:13,";":15,"'":17,q:12,w:14,e:16,r:17,t:19,y:21,u:23,i:24,o:26,p:28,"[":29,"]":31,2:1,3:3,5:6,6:8,7:10,9:13,0:15,"=":20};function A(c,e){const t={},s=c*12+12;let i=0;e&&(i={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11}[e]||0);for(const[o,n]of Object.entries(x)){const r=s+i+n;r>=24&&r<=127&&(t[o]=r)}return t}function w(c,e=!1){const t=new Set;function s(o){if(!e)return;const n=o.key.toLowerCase();console.debug("Key pressed:",n);const r=A(c.getOctave(),c.getRootNote());if(r[n]&&!t.has(n)){t.add(n);const a=r[n];console.debug(`Pressing MIDI note ${a} for key '${n}' (octave ${c.getOctave()})`),c.pressKey(a),o.preventDefault()}}function i(o){if(!e)return;const n=o.key.toLowerCase(),r=A(c.getOctave(),c.getRootNote());if(r[n]&&t.has(n)){t.delete(n);const a=r[n];console.debug(`Releasing MIDI note ${a} for key '${n}' (octave ${c.getOctave()})`),c.releaseKey(a),o.preventDefault()}}return e?console.debug("Virtual keyboard input setup complete. Available keys:",Object.keys(x),"Base octave:",c.getOctave()):console.debug("Virtual keyboard input setup (keyboard disabled)"),document.addEventListener("keydown",s),document.addEventListener("keyup",i),()=>{console.debug("Virtual keyboard input cleanup"),document.removeEventListener("keydown",s),document.removeEventListener("keyup",i)}}class f{static instance;basicPitch=null;audioContext=null;isRecording=!1;listeners=[];stream=null;sourceNode=null;processorNode=null;audioBufferQueue=[];isProcessing=!1;currentNote=null;noteConfidence=0;CONFIDENCE_THRESHOLD=3;SILENCE_THRESHOLD=5;silenceCounter=0;constructor(){}static getInstance(){return f.instance||(f.instance=new f),f.instance}isStarting=!1;async start(){if(!(this.isRecording||this.isStarting)){this.isStarting=!0;try{if(!this.basicPitch){const{BasicPitch:s}=await B(async()=>{const{BasicPitch:i}=await import("./CAYENW2a.js");return{BasicPitch:i}},[],import.meta.url);this.basicPitch=new s("https://unpkg.com/@spotify/basic-pitch@1.0.1/model/model.json")}const e=new AudioContext({sampleRate:22050});await e.resume();const t=await navigator.mediaDevices.getUserMedia({audio:!0});if(!this.isStarting){console.debug("AudioInputService: start() aborted"),t.getTracks().forEach(s=>s.stop()),e.close();return}this.audioContext=e,this.stream=t,this.sourceNode=this.audioContext.createMediaStreamSource(this.stream),this.processorNode=this.audioContext.createScriptProcessor(4096,1,1),this.processorNode.onaudioprocess=s=>{const i=s.inputBuffer.getChannelData(0);this.audioBufferQueue.push(new Float32Array(i)),this.processQueue()},this.sourceNode.connect(this.processorNode),this.processorNode.connect(this.audioContext.destination),this.isRecording=!0,console.log("AudioInputService started")}catch(e){throw console.error("Error starting audio input:",e),this.stop(),e}finally{this.isStarting=!1}}}stop(){this.isStarting=!1,this.isRecording&&(this.isRecording=!1,this.processorNode&&(this.processorNode.disconnect(),this.processorNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.currentNote=null,this.noteConfidence=0,this.silenceCounter=0,this.audioBufferQueue=[])}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}async processQueue(){if(!(this.isProcessing||this.audioBufferQueue.length===0||!this.basicPitch||!this.audioContext)){this.isProcessing=!0;try{for(;this.audioBufferQueue.length>0;){const e=this.audioBufferQueue.shift();if(!e)continue;const t=this.audioContext.createBuffer(1,e.length,this.audioContext.sampleRate);t.copyToChannel(e,0),await this.basicPitch.evaluateModel(t,(s,i,o)=>{let n=0,r=-1;for(let a=0;a<s.length;a++)for(let u=0;u<s[a].length;u++)s[a][u]>n&&(n=s[a][u],r=u);if(n>.3){const a=r+21;this.handleDetectedNote(a)}else this.handleSilence()},s=>{})}}catch(e){console.error("Error processing audio chunk:",e)}finally{this.isProcessing=!1}}}handleSilence(){this.silenceCounter++,this.silenceCounter>this.SILENCE_THRESHOLD&&(this.activeNote!==null&&this.sendNoteOff(this.activeNote),this.currentNote=null,this.noteConfidence=0)}handleDetectedNote(e){const t=Math.round(e);t===this.currentNote?(this.noteConfidence++,this.silenceCounter=0):this.currentNote===null?(this.currentNote=t,this.noteConfidence=1):(this.currentNote=t,this.noteConfidence=1),this.noteConfidence>=this.CONFIDENCE_THRESHOLD&&this.sendNoteOn(t)}activeNote=null;sendNoteOn(e){this.activeNote!==e&&(this.activeNote!==null&&this.sendNoteOff(this.activeNote),this.activeNote=e,this.notifyListeners(e,100,!0))}sendNoteOff(e){this.activeNote===e&&(this.activeNote=null,this.notifyListeners(e,0,!1))}notifyListeners(e,t,s){const i=s?144:128,o=new Uint8Array([i,e,t]),n=new MIDIMessageEvent("midimessage",{data:o});this.listeners.forEach(r=>r(n))}}const v=f.getInstance();class oe{midiAccess=null;virtualMidi=null;keyboardCleanup=null;eventHandlers={};errorCallbacks=[];debugMode=!1;audioInputEnabled=!1;midiState=H({inputs:[],outputs:[]});constructor(){v.addListener(e=>{this.handleMIDIMessage(e)})}async initialize(){try{return await this.connectMIDI(),this.setupAudioInput(),!0}catch(e){return this.handleError(e),!1}}async connectMIDI(){try{if(this.midiAccess=await this.safeRequestMidiAccess({sysex:!1}),!this.midiAccess)throw new Error("Failed to obtain MIDI access");return this.safeSetupMidiCallback(this.midiAccess,this.handleMIDIMessage.bind(this),this.handleError.bind(this)),console.debug("MIDI Manager: Connected to physical MIDI devices"),this.updateMidiState(),!0}catch(e){return this.handleError(e),!1}}async safeRequestMidiAccess(e){try{if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser"),null;const t=await navigator.requestMIDIAccess(e||{sysex:!1});return console.debug("MIDI Access obtained successfully"),t}catch(t){return console.error("Failed to obtain MIDI access:",t),null}}safeSetupMidiCallback(e,t,s){try{e.inputs.forEach(i=>{const o=`Input port [type:'${i.type}'] id:'${i.id}' manufacturer:'${i.manufacturer}' name:'${i.name}' version:'${i.version}'`;console.debug(`Setting up MIDI input: ${o}`),i.onmidimessage=n=>{try{t(n)}catch(r){console.error("Error in MIDI message callback:",r),s&&s(r)}}}),e.onstatechange=i=>{const o=i.port;console.debug(`MIDI port state changed: ${o.name} is now ${o.state}`),this.updateMidiState()}}catch(i){console.error("Error setting up MIDI callback:",i),s&&s(i)}}setupVirtualKeyboard(){try{const e=ne("Virtual Debug Keyboard");this.virtualMidi=e.getVirtualInput(),this.keyboardCleanup=w(this.virtualMidi,this.debugMode);const t=Array.from(e.inputs.values())[0];t&&(t.onmidimessage=this.handleMIDIMessage.bind(this)),console.debug("MIDI Manager: Virtual keyboard enabled")}catch(e){this.handleError(e)}}setDebugMode(e){this.debugMode=e,this.virtualMidi&&(this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.keyboardCleanup=w(this.virtualMidi,this.debugMode),console.debug(`MIDI Manager: Debug mode ${e?"enabled":"disabled"}`))}setupAudioInput(){v.addListener(e=>{this.audioInputEnabled&&this.handleMIDIMessage(e)})}async setAudioInput(e){this.audioInputEnabled=e,e?(await v.start(),console.debug("MIDI Manager: Audio input enabled")):(v.stop(),console.debug("MIDI Manager: Audio input disabled"))}getVirtualMidi(){return this.virtualMidi}safeGetMidiNote(e){try{if(!e.data||e.data.length<3)return console.warn("Invalid MIDI message data"),null;const[t,s,i]=e.data,o=t&240,n=t&15;if(o!==144&&o!==128)return null;if(s<24||s>127)return console.warn(`MIDI note ${s} out of valid range (24-127)`),null;const r=s,a=R[r];if(!a)return console.error(`No note name found for MIDI note ${r}`),null;const u=o===144&&i>0;return{noteNumber:r,type:u?"on":"off",noteFullName:a,noteName:a.slice(0,-1),velocity:i||0,timestamp:e.timeStamp||performance.now(),channel:n}}catch(t){return console.error("Error parsing MIDI message:",t),null}}handleMIDIMessage(e){try{const t=this.safeGetMidiNote(e);if(!t)return;t.type==="on"&&this.eventHandlers.onNoteOn?this.eventHandlers.onNoteOn(t):t.type==="off"&&this.eventHandlers.onNoteOff&&this.eventHandlers.onNoteOff(t)}catch(t){this.handleError(t)}}setEventHandlers(e){this.eventHandlers={...this.eventHandlers,...e}}handleError(e){console.error("MIDI Manager Error:",e),this.errorCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in error callback:",s)}}),this.eventHandlers.onError&&this.eventHandlers.onError(e)}getMIDIDevices(){return this.midiAccess?{inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())}:{inputs:[],outputs:[]}}cleanup(){this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.virtualMidi&&(this.virtualMidi.releaseAllKeys(),this.virtualMidi=null),this.midiAccess&&(this.midiAccess.inputs.forEach(e=>{e.onmidimessage=null}),this.midiAccess.onstatechange=null),this.eventHandlers={},this.errorCallbacks=[],console.debug("MIDI Manager: Cleaned up all connections")}updateMidiState(){this.midiAccess&&this.midiState.set({inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())})}}const be=new oe;var re=K('<div class="metronome svelte-1lsk5dc"><div class="controls svelte-1lsk5dc"><button><!></button> <div class="bpm-control svelte-1lsk5dc"><span class="bpm-display svelte-1lsk5dc"> </span> <input type="range" min="40" max="240" class="bpm-slider svelte-1lsk5dc"/></div></div></div>');function Ie(c,e){F(e,!0);let t=C(120),s=C(!1),i=null,o=null;function n(){d(s)?a():r()}function r(){o||(o=new AudioContext),M(s,!0);const l=60/d(t)*1e3;u(),i=window.setInterval(u,l)}function a(){M(s,!1),i&&(clearInterval(i),i=null)}function u(){if(!o)return;const l=o.createOscillator(),h=o.createGain();l.connect(h),h.connect(o.destination),l.frequency.value=1e3,h.gain.value=.5,l.start(),h.gain.exponentialRampToValueAtTime(.001,o.currentTime+.1),l.stop(o.currentTime+.1),e.onTick?.(Date.now())}function _(l){const h=l.target;M(t,parseInt(h.value),!0),d(s)&&(a(),r())}var y=re(),N=m(y),p=m(N);let E;p.__click=n;var L=m(p);{var S=l=>{se(l,{size:20})},P=l=>{te(l,{size:20})};z(L,l=>{d(s)?l(S):l(P,!1)})}g(p);var D=k(p,2),b=m(D),$=m(b);g(b);var I=k(b,2);U(I),I.__input=_,g(D),g(N),g(y),G(()=>{E=W(p,1,"toggle-btn svelte-1lsk5dc",null,E,{playing:d(s)}),j($,`${d(t)??""} BPM`),Z(I,d(t))}),O(c,y),Q()}q(["click","input"]);export{Ie as M,A as g,be as m};
