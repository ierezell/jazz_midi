import{M as p}from"./Cxn_sF4j.js";class m{constructor(e={}){this.options=e,this.options={velocity:100,channel:0,...e}}listeners=[];activeNotes=new Set;currentOctave=4;addEventListener(e,t){e==="midimessage"&&this.listeners.push(t)}removeEventListener(e,t){if(e==="midimessage"){const s=this.listeners.indexOf(t);s>-1&&this.listeners.splice(s,1)}}pressKey(e,t=this.options.velocity||100){if(this.activeNotes.has(e))return;this.activeNotes.add(e);const s=this.createMidiMessage(144,e,t);this.dispatchMidiEvent(s)}releaseKey(e){if(!this.activeNotes.has(e))return;this.activeNotes.delete(e);const t=this.createMidiMessage(128,e,0);this.dispatchMidiEvent(t)}releaseAllKeys(){for(const e of this.activeNotes)this.releaseKey(e)}getActiveNotes(){return Array.from(this.activeNotes)}playChord(e,t=this.options.velocity||100){e.forEach(s=>this.pressKey(s,t))}setOctave(e){this.currentOctave=Math.max(0,Math.min(8,e))}getOctave(){return this.currentOctave}createMidiMessage(e,t,s){return new Uint8Array([e|(this.options.channel||0),t,s])}dispatchMidiEvent(e){const t={data:e,timeStamp:performance.now(),type:"midimessage"};this.listeners.forEach(s=>s(t))}}function f(o="Virtual MIDI Keyboard"){const e=new m,t={id:"virtual-midi-input",manufacturer:"Virtual",name:o,type:"input",version:"1.0.0",state:"connected",connection:"open",onmidimessage:null,onstatechange:null,addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e),dispatchEvent:()=>!1,open:()=>Promise.resolve(t),close:()=>Promise.resolve(t),_virtualInput:e};return Object.defineProperty(t,"onmidimessage",{get(){return this._onmidimessage},set(i){this._onmidimessage=i,i&&e.addEventListener("midimessage",i)}}),{inputs:new Map([["virtual-midi-input",t]]),outputs:new Map,sysexEnabled:!1,onstatechange:null,addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1,getVirtualInput:()=>e}}const u={z:0,x:2,c:4,v:5,b:7,n:9,m:11,",":12,".":14,"/":16,s:1,d:3,g:6,h:8,j:10,l:13,";":15,"'":17,q:12,w:14,e:16,r:17,t:19,y:21,u:23,i:24,o:26,p:28,"[":29,"]":31,2:1,3:3,5:6,6:8,7:10,9:13,0:15,"=":20};function l(o){const e={},t=o*12+12;for(const[s,n]of Object.entries(u)){const r=t+n;r>=24&&r<=127&&(e[s]=r)}return e}function d(o,e=!1){const t=new Set;function s(r){if(!e)return;const i=r.key.toLowerCase();console.debug("Key pressed:",i);const a=l(o.getOctave());if(a[i]&&!t.has(i)){t.add(i);const c=a[i];console.debug(`Pressing MIDI note ${c} for key '${i}' (octave ${o.getOctave()})`),o.pressKey(c),r.preventDefault()}}function n(r){if(!e)return;const i=r.key.toLowerCase(),a=l(o.getOctave());if(a[i]&&t.has(i)){t.delete(i);const c=a[i];console.debug(`Releasing MIDI note ${c} for key '${i}' (octave ${o.getOctave()})`),o.releaseKey(c),r.preventDefault()}}return e?console.debug("Virtual keyboard input setup complete. Available keys:",Object.keys(u),"Base octave:",o.getOctave()):console.debug("Virtual keyboard input setup (keyboard disabled)"),document.addEventListener("keydown",s),document.addEventListener("keyup",n),()=>{console.debug("Virtual keyboard input cleanup"),document.removeEventListener("keydown",s),document.removeEventListener("keyup",n)}}class v{midiAccess=null;virtualMidi=null;keyboardCleanup=null;eventHandlers={};errorCallbacks=[];debugMode=!1;constructor(){}async initialize(){try{return await this.connectMIDI(),!0}catch(e){return this.handleError(e),!1}}async connectMIDI(){try{if(this.midiAccess=await this.safeRequestMidiAccess({sysex:!1}),!this.midiAccess)throw new Error("Failed to obtain MIDI access");return this.safeSetupMidiCallback(this.midiAccess,this.handleMIDIMessage.bind(this),this.handleError.bind(this)),console.debug("MIDI Manager: Connected to physical MIDI devices"),!0}catch(e){return this.handleError(e),!1}}async safeRequestMidiAccess(e){try{if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser"),null;const t=await navigator.requestMIDIAccess(e||{sysex:!1});return console.debug("MIDI Access obtained successfully"),t}catch(t){return console.error("Failed to obtain MIDI access:",t),null}}safeSetupMidiCallback(e,t,s){try{e.inputs.forEach(n=>{const r=`Input port [type:'${n.type}'] id:'${n.id}' manufacturer:'${n.manufacturer}' name:'${n.name}' version:'${n.version}'`;console.debug(`Setting up MIDI input: ${r}`),n.onmidimessage=i=>{try{t(i)}catch(a){console.error("Error in MIDI message callback:",a),s&&s(a)}}}),e.onstatechange=n=>{const r=n.port;console.debug(`MIDI port state changed: ${r.name} is now ${r.state}`)}}catch(n){console.error("Error setting up MIDI callback:",n),s&&s(n)}}setupVirtualKeyboard(){try{const e=f("Virtual Debug Keyboard");this.virtualMidi=e.getVirtualInput(),this.keyboardCleanup=d(this.virtualMidi,this.debugMode);const t=Array.from(e.inputs.values())[0];t&&(t.onmidimessage=this.handleMIDIMessage.bind(this)),console.debug("MIDI Manager: Virtual keyboard enabled")}catch(e){this.handleError(e)}}setDebugMode(e){this.debugMode=e,this.virtualMidi&&(this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.keyboardCleanup=d(this.virtualMidi,this.debugMode),console.debug(`MIDI Manager: Debug mode ${e?"enabled":"disabled"}`))}getVirtualMidi(){return this.virtualMidi}safeGetMidiNote(e){try{if(!e.data||e.data.length<3)return console.warn("Invalid MIDI message data"),null;const[t,s,n]=e.data,r=t&240,i=t&15;if(r!==144&&r!==128)return null;if(s<24||s>127)return console.warn(`MIDI note ${s} out of valid range (24-127)`),null;const a=s,c=p[a];if(!c)return console.error(`No note name found for MIDI note ${a}`),null;const h=r===144&&n>0;return{noteNumber:a,type:h?"on":"off",noteFullName:c,noteName:c.slice(0,-1),velocity:n||0,timestamp:e.timeStamp||performance.now(),channel:i}}catch(t){return console.error("Error parsing MIDI message:",t),null}}handleMIDIMessage(e){try{const t=this.safeGetMidiNote(e);if(!t)return;t.type==="on"&&this.eventHandlers.onNoteOn?this.eventHandlers.onNoteOn(t):t.type==="off"&&this.eventHandlers.onNoteOff&&this.eventHandlers.onNoteOff(t)}catch(t){this.handleError(t)}}setEventHandlers(e){this.eventHandlers={...this.eventHandlers,...e}}handleError(e){console.error("MIDI Manager Error:",e),this.errorCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in error callback:",s)}}),this.eventHandlers.onError&&this.eventHandlers.onError(e)}getMIDIDevices(){return this.midiAccess?{inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())}:{inputs:[],outputs:[]}}cleanup(){this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.virtualMidi&&(this.virtualMidi.releaseAllKeys(),this.virtualMidi=null),this.midiAccess&&(this.midiAccess.inputs.forEach(e=>{e.onmidimessage=null}),this.midiAccess.onstatechange=null),this.eventHandlers={},this.errorCallbacks=[],console.debug("MIDI Manager: Cleaned up all connections")}}const g=new v;export{l as g,g as m};
