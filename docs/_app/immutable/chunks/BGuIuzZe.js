import{c as At,a as y,f as S}from"./Bdvgn338.js";import{o as $e,a as Jt}from"./BRJReVLM.js";import{e as Qt,h as Zt,f as Ee,p as De,g as at,k as t,U as I,c as o,s as l,r as s,t as D,a as He,Z as b,X as E,_ as $t,V as Qe,W as ea,Y as Et}from"./ZtE6Gyvq.js";import{d as st,s as C}from"./BnZ86L-c.js";import{I as ta,s as aa,e as Ne,i as xe}from"./BiYp4j9H.js";import{i as V}from"./CdTPX8-T.js";import{s as sa}from"./C1phzpXo.js";import{b as ke,j as Ze,e as ra,C as na,h as Rt,i as oa,s as ia,a as la}from"./DhWXMPZY.js";import{t as We,s as da,f as et,u as Ct}from"./BEryLFqn.js";import{l as ca,s as tt,p as $}from"./-nZJNBOr.js";import{g as va,m as Te,M as ua}from"./Db0A3unl.js";import{D as rt,M as be,g as fa,N as nt,f as ha,A as Be,b as ma,h as ga}from"./CXrKfc7O.js";import{p as Tt}from"./BciydY-1.js";import{g as _a}from"./DWVIRhTo.js";import{j as ba}from"./DJn4_ZD4.js";import{_ as pa}from"./PPVm8Dsz.js";import{S as wa}from"./BMDMuo3y.js";import"./BUbxQ3bP.js";import{A as ya}from"./D2bNNvD8.js";class ot{#e=new WeakMap;#t;#a;static entries=new WeakMap;constructor(e){this.#a=e}observe(e,r){var n=this.#e.get(e)||new Set;return n.add(r),this.#e.set(e,n),this.#s().observe(e,this.#a),()=>{var d=this.#e.get(e);d.delete(r),d.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#s(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var r of e){ot.entries.set(r.target,r);for(var n of this.#e.get(r.target)||[])n(r)}}))}}var Ma=new ot({box:"border-box"});function jt(a,e,r){var n=Ma.observe(a,()=>r(a[e]));Qt(()=>(Zt(()=>r(a[e])),n))}function Na(a,e){const r=ca(e,["children","$$slots","$$events","$$legacy"]);const n=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];ta(a,tt({name:"rotate-ccw"},()=>r,{get iconNode(){return n},children:(d,v)=>{var p=At(),N=Ee(p);aa(N,e,"default",{}),y(d,p)},$$slots:{default:!0}}))}class xa{audioElements=new Map;enabled=!0;unlocked=!1;volume=.7;constructor(){this.preloadSounds()}async preloadSounds(){try{await this.loadSound("success","/src/lib/sounds/ok.mp3"),await this.loadSound("error","/src/lib/sounds/error.mp3")}catch(e){console.warn("Failed to preload some audio files:",e)}}async loadSound(e,r){return new Promise((n,d)=>{if(typeof Audio>"u"){n();return}const v=new Audio;v.addEventListener("canplaythrough",()=>{this.audioElements.set(e,v),n()}),v.addEventListener("error",p=>{console.warn(`Failed to load sound "${e}" from ${r}:`,p),d(p)}),v.preload="auto",v.volume=this.volume,v.src=r})}async playSound(e,r){if(!this.enabled)return;if(!this.unlocked){console.warn("Audio playback blocked: user gesture required to enable sound. Call audioManager.unlock() from a user interaction.");return}const n=this.audioElements.get(e);if(!n){console.warn(`Sound "${e}" not found`);return}try{n.currentTime=0,r!==void 0?n.volume=Math.max(0,Math.min(1,r)):n.volume=this.volume,await n.play()}catch(d){console.warn(`Failed to play sound "${e}":`,d)}}async playSuccess(){await this.playSound("success",.8)}async playError(){await this.playSound("error",.6)}async unlock(){if(this.unlocked)return!0;try{const e=this.audioElements.get("success")??Array.from(this.audioElements.values())[0];if(!e)return this.unlocked=!0,!0;const r=e.volume;return e.volume=0,await e.play(),e.pause(),e.currentTime=0,e.volume=r,this.unlocked=!0,this.enabled=!0,console.debug("AudioManager: audio unlocked by user gesture"),!0}catch(e){return console.warn("AudioManager: unlock failed (user gesture required):",e),this.enabled=!1,this.unlocked=!1,!1}}needsUserGesture(){return!this.unlocked}}const Oe=new xa;function Sa(a,e,r,n){const d=a.timestamp,v=60/n*1e3,p=d-e.timestamp,N=v-p,w=Math.min(p,N);return r.requireDownbeat&&!e.isDownbeat?"Play chords on the first beat of each measure!":w>r.toleranceMs?"Off beat! Try to play on the beat.":null}function ka(a,e){return a.length===0||e.length===0?1/0:e.reduce((r,n)=>{const d=Math.min(...a.map(v=>Math.abs(n-v)));return r+d},0)}const Ea=(a,e,r)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:r};case 1:return{root:a[1],third:a[2],fifth:a[0]+12,inversion:1,chordType:r};case 2:return{root:a[2],third:a[0]+12,fifth:a[1]+12,inversion:2,chordType:r};case 3:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:r}}},Ca=(a,e,r)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],seventh:a[3],inversion:0,chordType:r};case 1:return{root:a[1],third:a[2],fifth:a[3],seventh:a[0]+12,inversion:1,chordType:r};case 2:return{root:a[2],third:a[3],fifth:a[0]+12,seventh:a[1]+12,inversion:2,chordType:r};case 3:return{root:a[3],third:a[0]+12,fifth:a[1]+12,seventh:a[2]+12,inversion:3,chordType:r}}},k={second:a=>a+2,minorThird:a=>a+3,majorThird:a=>a+4,fourth:a=>a+5,flatFifth:a=>a+6,perfectFifth:a=>a+7,augmentedFifth:a=>a+8,diminishedSeventh:a=>a+9,minorSeventh:a=>a+10,majorSeventh:a=>a+11},Ta={major:[k.majorThird,k.perfectFifth],minor:[k.minorThird,k.perfectFifth],maj7:[k.majorThird,k.perfectFifth,k.majorSeventh],min7:[k.minorThird,k.perfectFifth,k.minorSeventh],7:[k.majorThird,k.perfectFifth,k.minorSeventh],dom7:[k.majorThird,k.perfectFifth,k.minorSeventh],diminished:[k.minorThird,k.flatFifth],augmented:[k.majorThird,k.augmentedFifth],sus2:[k.second,k.perfectFifth],sus4:[k.fourth,k.perfectFifth],dim7:[k.minorThird,k.flatFifth,k.diminishedSeventh],"half-dim7":[k.minorThird,k.flatFifth,k.minorSeventh]};function ja(a){let e=a;for(;e>60;)e=e-12;for(;e<48;)e=e+12;return e}function it(a,e,r=0){const n=ja(a),d=Ta[e]??[],v=[n,...d.map(p=>p(n))];if(v.length===3&&r===3)throw new Error(`Triad ${e} chords do not have a 3rd inversion`);return v.length===3?Ea(v,r,e):Ca(v,r,e)}function Aa(a,e){const r=[a.root,a.third,a.fifth,a.seventh].filter(d=>d!==void 0),n=a.root+14;switch(e){case"full-right":return r;case"full-left":return r.map(d=>d-12).filter(d=>d>=24);case"1735":return[a.root-12,(a.seventh||a.root)-12,a.third,a.fifth].filter(d=>d!==void 0&&d>=24);case"1537":return[a.root-12,a.fifth-12,a.third,a.seventh||a.root].filter(d=>d!==void 0&&d>=24);case"rootless-a":return[a.third,a.fifth,a.seventh,n].filter(d=>d!==void 0);case"rootless-b":return[a.seventh,n,a.third+12,a.fifth+12].filter(d=>d!==void 0);default:return r}}function Ra(a,e){const r=Aa(a,e);switch(e){case"full-right":return{leftHand:[],rightHand:[r.map(n=>be[n])]};case"full-left":return{leftHand:[r.map(n=>be[n])],rightHand:[]};case"1735":case"1537":{const n=r.slice(0,2),d=r.slice(2);return{leftHand:[n.map(v=>be[v])],rightHand:[d.map(v=>be[v])]}}case"rootless-a":case"rootless-b":return{leftHand:[],rightHand:[r.map(n=>be[n])]};default:return{leftHand:[],rightHand:[r.map(n=>be[n])]}}}function Hs(a,e,r,n){const d=a+rt,v=nt[d],p=it(v,e,r);return Ra(p,n)}function Ia(a,e=2,r=7){if(a.length===0)return{middleC:fa,octaves:e};const n=Math.min(...a),d=Math.max(...a),v=d-n,p=Math.ceil(v/12)+1,N=Math.max(e,Math.min(r,p)),F=(n+d)/2-N*12/2,M=Math.floor(F/12)*12+Math.floor(N/2)*12;return{middleC:Math.max(24,M),octaves:N}}function Oa(a,e){switch((a%12-e%12+12)%12){case 0:return"root";case 4:return"third";case 7:return"fifth";case 11:return"seventh";case 2:return"ninth";case 5:return"eleventh";case 9:return"thirteenth";default:return"unknown"}}function Fs(a,e,r){if(r.length===0)return 0;const n=e.includes("7")?[0,1,2,3]:[0,1,2];let d=0,v=1/0;for(const p of n)try{const N=it(a,e,p),w=[N.root,N.third,N.fifth,N.seventh].filter(m=>m!==void 0),F=ka(r,w);F<v&&(v=F,d=p)}catch{continue}return d}function Ls(a,e,r=rt){const n=a+r,d=nt[n],v=ha[e];return d+v}var Da=S("<option> </option>"),Ha=S("<option> </option>"),Fa=S("<option> </option>"),La=S('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Virtual MIDI Controls</h4> <div class="control-group svelte-pmsc4d"><label class="svelte-pmsc4d">Root Note: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Keyboard Octave: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Chord Type: <select class="svelte-pmsc4d"></select></label></div></div> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Quick Actions</h4> <div class="button-group svelte-pmsc4d"><button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn stop svelte-pmsc4d">Stop All Notes</button> <button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn svelte-pmsc4d">Random Note</button></div></div>',1),Ka=S('<div class="svelte-pmsc4d"> </div>'),Va=S('<div class="svelte-pmsc4d"> </div>'),Pa=S('<div class="svelte-pmsc4d"> </div>'),Ba=S('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Exercise Status</h4> <div class="status-info svelte-pmsc4d"><!> <!> <!></div></div>'),Wa=S('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),za=S('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Ua=S('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d"> </h4> <div class="shortcuts svelte-pmsc4d"><div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">White Keys:</strong><br/> <!></div> <div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">Black Keys:</strong><br/> <!></div></div></div>'),Ga=S('<div class="debug-content svelte-pmsc4d"><!> <!> <!> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Status</h4> <div class="status svelte-pmsc4d"><p class="svelte-pmsc4d">Active Notes: <span class="count svelte-pmsc4d"> </span></p> <p class="svelte-pmsc4d">Virtual MIDI: <span class="status-good svelte-pmsc4d"> </span></p></div></div></div>'),qa=S('<div><div class="debug-header svelte-pmsc4d"><h3 class="svelte-pmsc4d">ðŸŽ¹ Debug Panel</h3> <button class="toggle-btn svelte-pmsc4d"> </button></div> <!></div>');function Ya(a,e){De(e,!0);let r=$(e,"debugMode",3,!0),n=$(e,"noteEvents",19,()=>[]),d=$(e,"expectedNotes",19,()=>[]),v=$(e,"currentNotes",19,()=>[]),p=E(()=>d().map(x=>be[x])),N=E(()=>v().map(x=>be[x])),w=I("C"),F=I("maj7"),m=I(4),M=E(()=>{const x=va(t(m),t(w)),j=X=>X.map(R=>({key:R.toUpperCase(),note:be[x[R.toLowerCase()]]})).filter(R=>R.note);return{white:j(["z","x","c","v","b","n","m"]),black:j(["s","d","g","h","j"])}});at(()=>{e.virtualMidi&&(e.virtualMidi.setOctave(t(m)),e.virtualMidi.setRootNote(t(w)))});function f(){if(!e.virtualMidi)return;const x=t(m)*12+12,j=Be.indexOf(t(w));if(j===-1)return;const X=x+j,R=it(X,t(F)),T=[R.root,R.third,R.fifth,R.seventh].filter(G=>G!=null&&G!=null);e.virtualMidi.playChord(T)}function U(){e.virtualMidi&&e.virtualMidi.releaseAllKeys()}let _=[];function g(){if(!e.virtualMidi)return;_.forEach(T=>clearTimeout(T)),_=[];const x=t(m)*12+12,j=Be.indexOf(t(w));if(j===-1)return;const X=x+j;[0,2,4,5,7,9,11,12].map(T=>X+T).forEach((T,G)=>{const he=setTimeout(()=>{e.virtualMidi.pressKey(T),setTimeout(()=>e.virtualMidi.releaseKey(T),300)},G*400);_.push(he)})}function h(){if(!e.virtualMidi)return;const x=72+Math.floor(Math.random()*24);e.virtualMidi.pressKey(x),setTimeout(()=>e.virtualMidi.releaseKey(x),500)}var A=qa();let q;var ee=o(A),P=l(o(ee),2);P.__click=function(...x){e.onToggleDebugMode?.apply(this,x)};var ne=o(P);s(P),s(ee);var Y=l(ee,2);{var pe=x=>{var j=Ga(),X=o(j);{var R=B=>{var ae=La(),oe=Ee(ae),me=l(o(oe),2),ce=o(me),ie=l(o(ce));Ne(ie,21,()=>Be,xe,(Q,Z)=>{var K=Da(),ye=o(K,!0);s(K);var ue={};D(()=>{C(ye,t(Z)),ue!==(ue=t(Z))&&(K.value=(K.__value=t(Z))??"")}),y(Q,K)}),s(ie),s(ce);var se=l(ce,2),W=l(o(se));Ne(W,20,()=>[2,3,4,5,6],xe,(Q,Z)=>{var K=Ha(),ye=o(K,!0);s(K);var ue={};D(()=>{C(ye,Z),ue!==(ue=Z)&&(K.value=(K.__value=Z)??"")}),y(Q,K)}),s(W),s(se);var ge=l(se,2),L=l(o(ge));Ne(L,21,()=>ma,xe,(Q,Z)=>{var K=Fa(),ye=o(K,!0);s(K);var ue={};D(()=>{C(ye,t(Z)),ue!==(ue=t(Z))&&(K.value=(K.__value=t(Z))??"")}),y(Q,K)}),s(L),s(ge),s(me),s(oe);var H=l(oe,2),z=l(o(H),2),J=o(z);J.__click=f;var ve=o(J);s(J);var re=l(J,2);re.__click=U;var le=l(re,2);le.__click=g;var de=o(le);s(le);var _e=l(le,2);_e.__click=h,s(z),s(H),D(()=>{C(ve,`Play ${t(w)??""}${t(F)??""}`),C(de,`Play ${t(w)??""} Scale`)}),Ze(ie,()=>t(w),Q=>b(w,Q)),Ze(W,()=>t(m),Q=>b(m,Q)),Ze(L,()=>t(F),Q=>b(F,Q)),y(B,ae)};V(X,B=>{e.virtualMidi&&B(R)})}var T=l(X,2);{var G=B=>{var ae=Ba(),oe=l(o(ae),2),me=o(oe);{var ce=L=>{var H=Ka(),z=o(H);s(H),D(J=>C(z,`Expected Notes: ${J??""}`),[()=>t(p).join(", ")]),y(L,H)};V(me,L=>{d().length>0&&L(ce)})}var ie=l(me,2);{var se=L=>{var H=Va(),z=o(H);s(H),D(J=>C(z,`Current Notes: ${J??""}`),[()=>t(N).join(", ")]),y(L,H)};V(ie,L=>{v().length>0&&L(se)})}var W=l(ie,2);{var ge=L=>{var H=Pa(),z=o(H);s(H),D(()=>C(z,`Recent Events: ${n().length??""}`)),y(L,H)};V(W,L=>{n().length>0&&L(ge)})}s(oe),s(ae),y(B,ae)};V(T,B=>{(d().length>0||v().length>0)&&B(G)})}var he=l(T,2);{var je=B=>{var ae=Ua(),oe=o(ae),me=o(oe);s(oe);var ce=l(oe,2),ie=o(ce),se=l(o(ie),3);Ne(se,17,()=>t(M).white,xe,(L,H)=>{let z=()=>t(H).key,J=()=>t(H).note;var ve=Wa(),re=Ee(ve),le=o(re,!0);s(re);var de=l(re,2),_e=o(de,!0);s(de),D(()=>{C(le,z()),C(_e,J())}),y(L,ve)}),s(ie);var W=l(ie,2),ge=l(o(W),3);Ne(ge,17,()=>t(M).black,xe,(L,H)=>{let z=()=>t(H).key,J=()=>t(H).note;var ve=za(),re=Ee(ve),le=o(re,!0);s(re);var de=l(re,2),_e=o(de,!0);s(de),D(()=>{C(le,z()),C(_e,J())}),y(L,ve)}),s(W),s(ce),s(ae),D(()=>C(me,`Keyboard Shortcuts (Octave ${t(m)??""})`)),y(B,ae)};V(he,B=>{e.virtualMidi&&B(je)})}var Ae=l(he,2),Re=l(o(Ae),2),Ie=o(Re),we=l(o(Ie)),te=o(we,!0);s(we),s(Ie);var Fe=l(Ie,2),Le=l(o(Fe)),ze=o(Le,!0);s(Le),s(Fe),s(Re),s(Ae),s(j),D(B=>{C(te,B),C(ze,e.virtualMidi?"Connected":"Disconnected")},[()=>e.virtualMidi?e.virtualMidi.getActiveNotes().length:0]),y(x,j)};V(Y,x=>{r()&&x(pe)})}s(A),D(()=>{q=ke(A,1,"debug-panel svelte-pmsc4d",null,q,{visible:r()}),C(ne,`${r()?"Hide":"Show"} Debug`)}),y(a,A),He()}st(["click"]);var Xa=S('<div><div class="note-role-dot svelte-ouqkuv"></div></div>'),Ja=S("<div><!></div>");function Qa(a,e){De(e,!0);let r=$(e,"interactive",3,!1),n=$(e,"noteRoleColor",3,"transparent"),d=$(e,"isWrongNote",3,!1),v=![1,3,6,8,10].includes(e.noteNum%12),p=I(0);v||([1,6].includes(e.noteNum%12)?b(p,-e.keyWidth/12):[3,10].includes(e.noteNum%12)&&b(p,e.keyWidth/12));function N(){r()&&e.onclick&&e.onclick()}function w(g){r()&&e.onmousedown&&(e.onmousedown(),g.preventDefault())}function F(g){r()&&e.onmouseup&&(e.onmouseup(),g.preventDefault())}function m(g){r()&&e.onmousedown&&(e.onmousedown(),g.preventDefault())}function M(g){r()&&e.onmouseup&&(e.onmouseup(),g.preventDefault())}var f=Ja();ra(f,()=>({style:`--width: ${e.keyWidth-e.keyWidth*.47*(v?0:1)}px; --height: ${e.keyHeight??""}px; --note-role-color: ${n()??""}; transform: translate(${t(p)??""}px);`,draggable:"false",onclick:N,onmousedown:w,onmouseup:F,ontouchstart:m,ontouchend:M,role:r()?"button":void 0,...r()?{tabindex:0}:{},[na]:{accidental:!v,natural:v,pressed:e.pressed,interactive:r(),"wrong-note":d()}}),void 0,void 0,void 0,"svelte-ouqkuv");var U=o(f);{var _=g=>{var h=Xa();let A;D(()=>A=ke(h,1,"note-role-indicator svelte-ouqkuv",null,A,{"natural-indicator":v,"accidental-indicator":!v})),y(g,h)};V(U,g=>{n()&&g(_)})}s(f),y(a,f),He()}var Za=S('<div class="keyboard svelte-1dlz8xf"></div>');function $a(a,e){De(e,!0);let r=$(e,"expectedNotes",19,()=>[]),n=$(e,"showExpected",3,!1),d=I(10),v=I(10),p=E(()=>Math.max(1,Math.min(10,e.octaves||2))),N=E(()=>Math.max(24,Math.min(108,e.middleC||60))),w=E(()=>[...Array(t(p)*12+1).keys()].map(M=>M+(t(N)-Math.floor(t(p)/2)*12))),F=E(()=>t(w).filter(M=>![1,3,6,8,10].includes(M%12)).length);var m=Za();Ne(m,21,()=>t(w),xe,(M,f)=>{const U=E(()=>n()&&r().includes(t(f))?"#2ecc71":ga[e.noteRoles[t(f)]]),_=E(()=>e.midiNotes.includes(t(f))),g=E(()=>t(_)&&r().length>0&&!r().includes(t(f)));{let h=E(()=>t(d)/t(F));Qa(M,{get noteNum(){return t(f)},get pressed(){return t(_)},get keyWidth(){return t(h)},get keyHeight(){return t(v)},get noteRoleColor(){return t(U)},get isWrongNote(){return t(g)}})}}),s(m),jt(m,"clientWidth",M=>b(d,M)),jt(m,"clientHeight",M=>b(v,M)),y(a,m),He()}var es=S('<div id="score-container" class="svelte-25wfcq"><canvas id="output" class="svelte-25wfcq"></canvas></div>');function ts(a,e){De(e,!0);let r=null,n=I(!1);$e(async()=>{r=await pa(()=>import("./wr6S8XWn.js"),[],import.meta.url),b(n,!0)});const d=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]),v={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","E#":"F","B#":"C"};function p(_){return _.includes("b")?!0:d.has(_)}function N(_){return{"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"}[_]||_}function w(_){const g=/(.*?)(\d+)$/.exec(_);if(!g)return _;let h=g[1];const A=parseInt(g[2],10);return(h==="A#"||h==="D#"||h==="G#"||p(e.selectedNote)&&h.includes("#"))&&(h=v[h]??h),`${h}${A+1}`}const F=_=>_?.map(g=>g.length>1?`(${g.map(h=>w(h)).join(" ")})`:w(g[0])).join(", ")||"";let m=E(()=>F(e.rightHand)),M=E(()=>F(e.leftHand));function f(_){if(!r||!t(n))return;const{Factory:g,Renderer:h,Voice:A}=r,q=_<768,ee=_<480,P=_<360;let ne;P?ne=200:ee?ne=240:q?ne=280:ne=340;const Y=document.getElementById("output");if(!Y)return;const pe=Y.getContext("2d");if(!pe)return;pe.clearRect(0,0,Y.width,Y.height);const x=new g({renderer:{elementId:"output",backend:h.Backends.CANVAS,width:Math.max(300,_),height:Math.max(200,ne)}}),j=x.EasyScore({throwOnError:!1}),X=q?10:20,R=x.System({width:Math.max(300,_),spaceBetweenStaves:X,noPadding:q,noJustification:q,formatOptions:{alignRests:!0,autoBeam:!0}});if((!e.rightHand||e.rightHand.length===0)&&(!e.leftHand||e.leftHand.length===0)){console.debug("No notes to render, rendering test chord");const T=`${w("C3")}, ${w("E3")}, ${w("G3")}`;try{const G=R.addStave({voices:[j.voice(j.notes(T,{clef:"treble",stem:"up"})).setMode(A.Mode.SOFT)]});G.addClef("treble"),e.selectedNote&&G.addKeySignature(N(e.selectedNote)),x.draw()}catch(G){console.error("Error rendering test chord:",G)}return}console.debug("Rendering score with notes:",{stringLeftHand:t(M),stringRightHand:t(m)}),console.debug("Selected note for key signature:",e.selectedNote);try{if(e.rightHand&&e.rightHand.length>0&&t(m)){const T=R.addStave({voices:[j.voice(j.notes(t(m),{clef:"treble",stem:"up"})).setMode(A.Mode.SOFT)]});T.addClef("treble"),e.selectedNote&&T.addKeySignature(N(e.selectedNote))}if(e.leftHand&&e.leftHand.length>0&&t(M)){const T=R.addStave({voices:[j.voice(j.notes(t(M),{clef:"bass",stem:"down"})).setMode(A.Mode.SOFT)]});T.addClef("bass"),e.selectedNote&&T.addKeySignature(N(e.selectedNote))}e.rightHand&&e.rightHand.length>0&&e.leftHand&&e.leftHand.length>0&&(R.addConnector("brace"),R.addConnector("single")),x.draw()}catch(T){console.error("Error rendering VexFlow score:",T)}}at(()=>{t(n)&&(console.debug("Score $effect triggered with props:",{leftHand:e.leftHand,rightHand:e.rightHand,selectedNote:e.selectedNote}),setTimeout(()=>{const _=document.getElementById("score-container");if(_){const g=_.getBoundingClientRect().width;g>0&&f(g)}},100))}),$e(()=>{const _=()=>{const g=document.getElementById("score-container");if(g){const h=g.getBoundingClientRect().width;console.debug(`Container width: ${h}`),h>0&&f(h)}};return window.addEventListener("resize",_),()=>{window.removeEventListener("resize",_)}});var U=es();y(a,U),He()}var as=S('<div class="star-wrapper svelte-h6yjv8"><!></div>'),ss=S('<div class="modal-overlay svelte-h6yjv8"><div class="modal-content svelte-h6yjv8"><div class="modal-header"><h2 class="svelte-h6yjv8">Lesson Complete!</h2> <div class="stars-container svelte-h6yjv8"></div></div> <div class="stats-grid svelte-h6yjv8"><div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">Accuracy</span> <span class="stat-value svelte-h6yjv8"> </span></div> <div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">XP Gained</span> <span class="stat-value svelte-h6yjv8"> </span></div></div> <div class="modal-actions svelte-h6yjv8"><button class="retry-btn svelte-h6yjv8"><!> Retry</button> <button class="continue-btn svelte-h6yjv8">Continue <!></button></div></div></div>');function rs(a,e){var r=At(),n=Ee(r);{var d=v=>{var p=ss(),N=o(p),w=o(N),F=l(o(w),2);Ne(F,20,()=>Array(3),xe,(Y,pe,x)=>{var j=as();Rt(j,`animation-delay: ${x*200}ms`);var X=o(j);{let R=E(()=>x<e.stars?"star-filled":"star-empty"),T=E(()=>x<e.stars?"#ffd700":"none"),G=E(()=>x<e.stars?"#ffd700":"currentColor");wa(X,{size:48,get class(){return t(R)},get fill(){return t(T)},get stroke(){return t(G)}})}s(j),y(Y,j)}),s(F),s(w);var m=l(w,2),M=o(m),f=l(o(M),2),U=o(f);s(f),s(M);var _=l(M,2),g=l(o(_),2),h=o(g);s(g),s(_),s(m);var A=l(m,2),q=o(A);q.__click=function(...Y){e.onRetry?.apply(this,Y)};var ee=o(q);Na(ee,{size:20}),$t(),s(q);var P=l(q,2);P.__click=function(...Y){e.onContinue?.apply(this,Y)};var ne=l(o(P));ya(ne,{size:20}),s(P),s(A),s(N),s(p),D(()=>{C(U,`${e.accuracy??""}%`),C(h,`+${e.xp??""}`)}),We(3,N,()=>da),We(3,p,()=>et),y(v,p)};V(n,v=>{e.isOpen&&v(d)})}y(a,r)}st(["click"]);var ns=S("<option> </option>"),os=S('<div class="control-group svelte-w7gj7d"><label for="note-select" class="svelte-w7gj7d">Root Key</label> <select id="note-select" class="svelte-w7gj7d"></select></div>'),is=S('<div class="control-group svelte-w7gj7d"><!></div>'),ls=S('<div class="control-group svelte-w7gj7d"><label for="tempo-toggle" class="svelte-w7gj7d">Tempo Mode</label> <button id="tempo-toggle"> </button></div> <!>',1),ds=S('<div class="control-group svelte-w7gj7d"><label for="training-mode-toggle" class="svelte-w7gj7d">Training Mode</label> <button id="training-mode-toggle" title="If enabled, mistakes will stop the lesson until you correct it"> </button></div>'),cs=S('<div class="exercise-description svelte-w7gj7d"><span class="info-icon svelte-w7gj7d">? <span class="desc-tooltip svelte-w7gj7d"> </span></span></div>'),vs=S('<div class="feedback-toast svelte-w7gj7d"> </div>'),us=S('<div class="prompt-card card-premium svelte-w7gj7d"><div class="prompt-text svelte-w7gj7d"> </div></div>'),fs=S('<div class="score-container card-premium svelte-w7gj7d"><!></div>'),hs=S('<div class="adaptive-help-text"> </div>'),ms=S('<div class="debug-panel-wrapper"><!></div>'),gs=S('<div class="exercise-layout"><aside class="sidebar glass svelte-w7gj7d"><div class="sidebar-header svelte-w7gj7d"><h3 class="svelte-w7gj7d">Exercise Controls</h3></div> <div class="sidebar-content"><!> <!> <!> <div class="control-group svelte-w7gj7d"><label for="debug-toggle" class="svelte-w7gj7d">Virtual Keyboard</label> <button id="debug-toggle"> </button></div> <div class="sidebar-spacer"></div> <button class="reset-btn svelte-w7gj7d">Reset Session</button></div></aside> <main class="exercise-main svelte-w7gj7d"><header class="exercise-header svelte-w7gj7d"><div class="info-group svelte-w7gj7d"><!> <h1 class="svelte-w7gj7d"> </h1></div> <div class="performance-strip svelte-w7gj7d"><div><span class="label">Mistakes:</span> <span class="value"> </span></div> <div class="stat-pill success svelte-w7gj7d"><span class="label">Progress:</span> <span class="value"> </span></div></div></header> <!> <div class="focus-area svelte-w7gj7d"><!> <!> <!> <div><!></div> <div class="exercise-custom-content"><!></div></div> <!> <footer class="exercise-footer svelte-w7gj7d"><div class="progress-track svelte-w7gj7d"><div class="progress-fill svelte-w7gj7d"></div></div></footer></main></div> <!>',1);function Ks(a,e){De(e,!0);let r=$(e,"randomMode",3,!1),n=$(e,"exerciseType",3,"chord"),d=$(e,"progressiveHints",3,!0),v=$(e,"showTempoControl",3,!0),p=$(e,"showTrainingControl",3,!0);const N=1,w=3,F=3;let m=I(Qe(e.initialNote??"C"));at(()=>{e.initialNote!==void 0&&e.initialNote!==t(m)&&(b(m,e.initialNote,!0),se())});let M=I(Qe([])),f=I(0),U=I(Qe(new Set)),_=I(0),g=I(!1),h=I(!1),A=I(""),q=!1,ee=I(!1),P=I(!1),ne=I(0),Y=120,pe=I(0),x=I(!1);const j=150;let X=E(()=>e.showScore===!1?!1:n()==="partition"?!0:d()?t(f)>=N:e.showScore??!0);const R=E(()=>Tt.url.searchParams.get("unitId")),T=E(()=>Tt.url.searchParams.get("lessonId")),G=E(()=>!!t(R)&&!!t(T));let he=I(!1),je=I(0),Ae=I(0),Re=I(0),Ie=E(()=>t(f)>=F),we=E(()=>t(M).map(i=>i.noteNumber)),te=E(()=>e.generateExpectedNotes(t(m))),Fe=E(()=>e.generateScoreProps(t(m))),Le=E(()=>t(h)||d()&&t(f)>=w),ze=E(()=>({...Ia(t(te)),midiNotes:t(we),debugMode:t(h),noteRoles:Object.fromEntries(t(te).map(i=>[i,Oa(i,nt[`${t(m)}${rt}`])])),expectedNotes:t(te),showExpected:t(Ie)})),B=E(()=>{if(t(te).length===0)return 0;const i=[...new Set(t(te))];return Math.round(t(U).size/i.length*100)}),ae=E(()=>{if(!d()||t(g)||n()==="partition")return"";if(t(f)<N){let i=`correct ${n()||"note"}`;if(e.prompt){const c=n()==="II-V-I"?"progression":n()==="note"?"note":n();i=`${e.prompt} ${c}`}return`Play the ${i}. After ${N-t(f)} more mistake${N-t(f)===1?"":"s"} the score will appear.`}return t(f)<w?`Reference keyboard will appear after ${w-t(f)} more mistake${w-t(f)===1?"":"s"}.`:"Adaptive help is active. Use the score and keyboard for reference."});const oe=E(()=>({selectedNote:t(m),currentNotes:t(we),expectedNotes:t(te),mistakes:t(f),completed:t(g),collectedNotes:t(U),debugMode:t(h),feedbackMessage:t(A),showNotesRoles:q,tempoMode:t(P),toggleDebug:z,showFeedback:W,toggleTempoMode:re,handleTick:ve,completeExercise:i=>ge(i)}));Jt(()=>{Te.cleanup()}),$e(async()=>{await Te.initialize(),Te.setupVirtualKeyboard(),Te.setEventHandlers({onNoteOn:me,onNoteOff:ce}),b(_,Date.now(),!0);const i=async()=>{if(Oe.needsUserGesture()){const c=await Oe.unlock();W(c?"Audio enabled":"Click or press any key to enable audio","info")}};window.addEventListener("pointerdown",i,{once:!0}),window.addEventListener("keydown",i,{once:!0})});function me(i){t(h)&&console.debug(`MIDI Note ON: ${i.noteNumber} (${i.noteFullName}) velocity=${i.velocity} channel=${i.channel}`);let c=!1;if(t(P)){const O={timestamp:t(ne),beatNumber:t(pe),isDownbeat:t(x)},fe={toleranceMs:j,requireDownbeat:n()==="chord"||n()==="progression"||n()==="II-V-I"},Me=Sa(i,O,fe,Y);Me&&(W(Me,"error"),Et(f),c=!0,Oe.playError())}b(M,[...t(M),i],!0);const u=e.validateNoteEvent(t(m),i,t(te),t(we));if(u.resetCollected&&b(U,new Set,!0),"resetMistakes"in u&&u.resetMistakes&&b(f,0),u.collected&&!c&&t(U).add(i.noteNumber),u.isCorrect)c||W(u.message,"success");else if(c||(Et(f),W(u.message,"error"),Oe.playError()),t(ee)){b(A,"error : Mistake! Take your time...");return}if(n()){const O=n()==="II-V-I"?"progression":n()==="note"||n()==="interval"?"chord":n();Ct.updateNoteProgress(i.noteName,O,void 0,u.isCorrect,0,u.isCorrect?100:0)}e.isCompleted(t(we),t(te))&&ge()}function ce(i){t(h)&&console.debug(`MIDI Note OFF: ${i.noteNumber} (${i.noteFullName}) channel=${i.channel}`),b(M,t(M).filter(c=>c.noteNumber!==i.noteNumber),!0)}function ie(i){b(m,i,!0),se()}function se(){b(M,[],!0),b(f,0),b(g,!1),b(A,""),b(_,Date.now(),!0),b(m,t(m),!0),b(U,new Set,!0),e.onReset?.()}function W(i,c){b(A,`${c} : ${i}`),setTimeout(()=>{b(A,"")},5e3)}function ge(i){console.log("Exercise Completed!",{exerciseType:n(),mistakes:t(f),startTime:t(_)}),b(g,!0);const c=Date.now()-t(_),u=Math.round((t(te).length-t(f))/t(te).length*100);if(W(`Exercise completed! Time: ${c}ms, Accuracy: ${u}%`,"success"),Oe.playSound?.("success"),n()){console.log("Recording stats...",{exerciseType:n(),success:!0,accuracy:u,timeElapsed:c});const O=n()==="II-V-I"?"progression":n()==="note"||n()==="interval"?"chord":n();Ct.recordExerciseResult({exerciseId:window.location.pathname,exerciseType:O,success:!0,accuracy:u,timeElapsed:c,mistakes:t(f),score:Math.max(0,100-t(f)*10),timestamp:new Date,...i})}else console.warn("No exerciseType provided, stats not recorded.");t(G)&&t(R)&&t(T)?(b(je,t(f)===0?3:t(f)<=2?2:1,!0),b(Ae,u,!0),b(Re,Math.max(0,100-t(f)*10),!0),ba.completeLesson(t(R),t(T),t(je)),b(he,!0)):(e.onComplete?.(),se())}function L(){b(he,!1),_a(la("/journey"))}function H(){b(he,!1),se()}function z(){b(h,!t(h)),Te.setDebugMode(t(h))}function J(i){const u=i.target.value;ie(u)}function ve(i,c,u){b(ne,i,!0),b(pe,c,!0),b(x,u,!0)}function re(){b(P,!t(P))}var le=gs(),de=Ee(le),_e=o(de),Q=l(o(_e),2),Z=o(Q);{var K=i=>{var c=os(),u=l(o(c),2);u.__change=J,Ne(u,21,()=>Be,xe,(fe,Me)=>{var Se=ns(),Xe=o(Se,!0);s(Se);var Ce={};D(()=>{C(Xe,t(Me)),Ce!==(Ce=t(Me))&&(Se.value=(Se.__value=t(Me))??"")}),y(fe,Se)}),s(u);var O;oa(u),s(c),D(()=>{O!==(O=t(m))&&(u.value=(u.__value=t(m))??"",ia(u,t(m)))}),y(i,c)};V(Z,i=>{r()||i(K)})}var ye=l(Z,2);{var ue=i=>{var c=ls(),u=Ee(c),O=l(o(u),2);let fe;O.__click=re;var Me=o(O,!0);s(O),s(u);var Se=l(u,2);{var Xe=Ce=>{var Je=is(),Xt=o(Je);ua(Xt,{onTick:ve}),s(Je),y(Ce,Je)};V(Se,Ce=>{t(P)&&Ce(Xe)})}D(()=>{fe=ke(O,1,"toggle-btn svelte-w7gj7d",null,fe,{active:t(P)}),C(Me,t(P)?"Enabled":"Disabled")}),y(i,c)};V(ye,i=>{v()&&i(ue)})}var lt=l(ye,2);{var It=i=>{var c=ds(),u=l(o(c),2);u.__click=()=>b(ee,!t(ee));let O;var fe=o(u,!0);s(u),s(c),D(()=>{O=ke(u,1,"toggle-btn svelte-w7gj7d",null,O,{active:t(ee)}),C(fe,t(ee)?"Stop on Mistake":"Free Play")}),y(i,c)};V(lt,i=>{p()&&i(It)})}var Ue=l(lt,2),Ke=l(o(Ue),2);Ke.__click=z;let dt;var Ot=o(Ke,!0);s(Ke),s(Ue);var Dt=l(Ue,4);Dt.__click=se,s(Q),s(_e);var ct=l(_e,2),Ge=o(ct),qe=o(Ge),vt=o(qe);{var Ht=i=>{var c=cs(),u=o(c),O=l(o(u)),fe=o(O,!0);s(O),s(u),s(c),D(()=>C(fe,e.description)),y(i,c)};V(vt,i=>{e.description&&i(Ht)})}var ut=l(vt,2),Ft=o(ut,!0);s(ut),s(qe);var ft=l(qe,2),Ve=o(ft);let ht;var mt=l(o(Ve),2),Lt=o(mt,!0);s(mt),s(Ve);var gt=l(Ve,2),_t=l(o(gt),2),Kt=o(_t);s(_t),s(gt),s(ft),s(Ge);var bt=l(Ge,2);{var Vt=i=>{var c=vs(),u=o(c,!0);s(c),D(()=>C(u,t(A))),We(3,c,()=>et),y(i,c)};V(bt,i=>{t(A)&&i(Vt)})}var Ye=l(bt,2),pt=o(Ye);{var Pt=i=>{var c=us(),u=o(c),O=o(u,!0);s(u),s(c),D(()=>C(O,e.prompt)),y(i,c)};V(pt,i=>{e.prompt&&i(Pt)})}var wt=l(pt,2);{var Bt=i=>{var c=fs(),u=o(c);ts(u,tt(()=>t(Fe))),s(c),We(1,c,()=>et),y(i,c)};V(wt,i=>{t(X)&&i(Bt)})}var yt=l(wt,2);{var Wt=i=>{var c=hs(),u=o(c,!0);s(c),D(()=>C(u,t(ae))),y(i,c)};V(yt,i=>{t(ae)&&i(Wt)})}var Pe=l(yt,2);let Mt;var zt=o(Pe);$a(zt,tt(()=>t(ze))),s(Pe);var Nt=l(Pe,2),Ut=o(Nt);sa(Ut,()=>e.children??ea,()=>t(oe)),s(Nt),s(Ye);var xt=l(Ye,2);{var Gt=i=>{var c=ms(),u=o(c);{let O=E(()=>Te.getVirtualMidi()??void 0);Ya(u,{get noteEvents(){return t(M)},get expectedNotes(){return t(te)},get currentNotes(){return t(we)},get debugMode(){return t(h)},onToggleDebugMode:z,get virtualMidi(){return t(O)}})}s(c),y(i,c)};V(xt,i=>{t(h)&&i(Gt)})}var St=l(xt,2),kt=o(St),qt=o(kt);s(kt),s(St),s(ct),s(de);var Yt=l(de,2);rs(Yt,{get isOpen(){return t(he)},get stars(){return t(je)},get accuracy(){return t(Ae)},get xp(){return t(Re)},onContinue:L,onRetry:H}),D(i=>{dt=ke(Ke,1,"toggle-btn svelte-w7gj7d",null,dt,{active:t(h)}),C(Ot,t(h)?"Visible":"Hidden"),C(Ft,i),ht=ke(Ve,1,"stat-pill svelte-w7gj7d",null,ht,{neutral:t(f)===0,warn:t(f)>0}),C(Lt,t(f)),C(Kt,`${t(B)??""}%`),Mt=ke(Pe,1,"keyboard-container svelte-w7gj7d",null,Mt,{hidden:!t(Le)}),Rt(qt,`width: ${t(B)??""}%`)},[()=>n()?.toUpperCase()||"PRACTICE"]),y(a,le),He()}st(["change","click"]);export{Ks as B,it as a,Aa as b,Ls as c,Fs as d,Ra as e,Hs as g};
