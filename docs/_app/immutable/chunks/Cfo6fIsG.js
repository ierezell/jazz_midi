import{c as jt,a as w,f as M}from"./Dd8hKrah.js";import{o as Qe,a as Xt}from"./BT6Gp5KL.js";import{e as Jt,h as Qt,f as Se,p as Te,g as et,k as t,U as D,c as r,s as l,r as s,t as F,a as Ae,Z as g,X as j,_ as Zt,V as Xe,W as $t,Y as Mt}from"./DFyylC6V.js";import{d as tt,s as x}from"./DmHNaigj.js";import{I as ea,s as ta,e as be,i as pe}from"./CFkAzgcL.js";import{i as V}from"./B0w1lo-d.js";import{s as aa}from"./BG_ZfqP6.js";import{a as ye,b as Je,f as sa,C as ra,c as Tt,i as na,s as oa}from"./DI7-7HPV.js";import{t as We,s as ia,f as Ze,u as St}from"./CbOpigEV.js";import{l as la,s as $e,p as se}from"./70QimmpI.js";import{g as ca,m as Me,M as da}from"./DfxKnqMB.js";import{D as at,M as he,N as st,f as va,g as ua,A as Ve,b as fa,h as ma}from"./CXrKfc7O.js";import{p as Et}from"./Ck79lEV8.js";import{g as ha}from"./B23pNP44.js";import{j as ga}from"./C-rlQH5X.js";import{_ as _a}from"./PPVm8Dsz.js";import{S as ba}from"./BbQ9OhvR.js";import"./jHr4y6eo.js";import{A as pa}from"./uNHr5iFy.js";class rt{#e=new WeakMap;#t;#a;static entries=new WeakMap;constructor(e){this.#a=e}observe(e,n){var o=this.#e.get(e)||new Set;return o.add(n),this.#e.set(e,o),this.#s().observe(e,this.#a),()=>{var c=this.#e.get(e);c.delete(n),c.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#s(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var n of e){rt.entries.set(n.target,n);for(var o of this.#e.get(n.target)||[])o(n)}}))}}var wa=new rt({box:"border-box"});function Ct(a,e,n){var o=wa.observe(a,()=>n(a[e]));Jt(()=>(Qt(()=>n(a[e])),o))}function ya(a,e){const n=la(e,["children","$$slots","$$events","$$legacy"]);const o=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];ea(a,$e({name:"rotate-ccw"},()=>n,{get iconNode(){return o},children:(c,v)=>{var b=jt(),R=Se(b);ta(R,e,"default",{}),w(c,b)},$$slots:{default:!0}}))}const Na=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[0]+12,fifth:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n}}},ka=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],seventh:a[3],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[3],seventh:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[3],fifth:a[0]+12,seventh:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[3],third:a[0]+12,fifth:a[1]+12,seventh:a[2]+12,inversion:3,chordType:n}}},At=(a,e,n=0)=>{const o=a+2,c=a+3,v=a+4,b=a+5,R=a+6,f=a+7,S=a+8,u=a+9,y=a+10,T=a+11;let N=[];switch(e){case"major":{N=[a,v,f];break}case"minor":{N=[a,c,f];break}case"maj7":{N=[a,v,f,T];break}case"min7":{N=[a,c,f,y];break}case"7":case"dom7":{N=[a,v,f,y];break}case"diminished":{N=[a,c,R];break}case"augmented":{N=[a,v,S];break}case"sus2":{N=[a,o,f];break}case"sus4":{N=[a,b,f];break}case"dim7":{N=[a,c,R,u];break}case"half-dim7":{N=[a,c,R,y];break}default:N=[a]}if(N.length===3){if(n===3)throw new Error(`Triad ${e} chords do not have a 3rd inversion`);return Na(N,n,e)}else return ka(N,n,e)};function xa(a,e){const n=[a.root,a.third,a.fifth,a.seventh].filter(c=>c!==void 0),o=a.root+14;switch(e){case"full-right":return n;case"full-left":return n.map(c=>c-12).filter(c=>c>=24);case"1735":return[a.root-12,(a.seventh||a.root)-12,a.third,a.fifth].filter(c=>c!==void 0&&c>=24);case"1537":return[a.root-12,a.fifth-12,a.third,a.seventh||a.root].filter(c=>c!==void 0&&c>=24);case"rootless-a":return[a.third,a.fifth,a.seventh,o].filter(c=>c!==void 0);case"rootless-b":return[a.seventh,o,a.third+12,a.fifth+12].filter(c=>c!==void 0);default:return n}}function Ma(a,e){const n=xa(a,e);switch(e){case"full-right":return{leftHand:[],rightHand:[n.map(o=>he[o])]};case"full-left":return{leftHand:[n.map(o=>he[o])],rightHand:[]};case"1735":case"1537":{const o=n.slice(0,2),c=n.slice(2);return{leftHand:[o.map(v=>he[v])],rightHand:[c.map(v=>he[v])]}}case"rootless-a":case"rootless-b":return{leftHand:[],rightHand:[n.map(o=>he[o])]};default:return{leftHand:[],rightHand:[n.map(o=>he[o])]}}}function Cs(a,e,n,o){const c=a+at,v=st[c],b=At(v,e,n);return Ma(b,o)}function Sa(a,e=2,n=7){if(a.length===0)return{middleC:ua,octaves:e};const o=Math.min(...a),c=Math.max(...a),v=Math.floor((o-12)/12)*12+12,R=Math.ceil((c+12)/12)*12-v,f=Math.max(e,Math.min(n,Math.ceil(R/12))),S=v+Math.floor(f*12/2)-6;return{middleC:Math.max(24,S),octaves:f}}function Ea(a,e){switch((a%12-e%12+12)%12){case 0:return"root";case 4:return"third";case 7:return"fifth";case 11:return"seventh";case 2:return"ninth";case 5:return"eleventh";case 9:return"thirteenth";default:return"unknown"}}function js(a,e,n=at){const o=a+n,c=st[o],v=va[e];return c+v}class Ca{audioElements=new Map;enabled=!0;unlocked=!1;volume=.7;constructor(){this.preloadSounds()}async preloadSounds(){try{await this.loadSound("success","/src/lib/sounds/ok.mp3"),await this.loadSound("error","/src/lib/sounds/error.mp3")}catch(e){console.warn("Failed to preload some audio files:",e)}}async loadSound(e,n){return new Promise((o,c)=>{if(typeof Audio>"u"){o();return}const v=new Audio;v.addEventListener("canplaythrough",()=>{this.audioElements.set(e,v),o()}),v.addEventListener("error",b=>{console.warn(`Failed to load sound "${e}" from ${n}:`,b),c(b)}),v.preload="auto",v.volume=this.volume,v.src=n})}async playSound(e,n){if(!this.enabled)return;if(!this.unlocked){console.warn("Audio playback blocked: user gesture required to enable sound. Call audioManager.unlock() from a user interaction.");return}const o=this.audioElements.get(e);if(!o){console.warn(`Sound "${e}" not found`);return}try{o.currentTime=0,n!==void 0?o.volume=Math.max(0,Math.min(1,n)):o.volume=this.volume,await o.play()}catch(c){console.warn(`Failed to play sound "${e}":`,c)}}async playSuccess(){await this.playSound("success",.8)}async playError(){await this.playSound("error",.6)}async unlock(){if(this.unlocked)return!0;try{const e=this.audioElements.get("success")??Array.from(this.audioElements.values())[0];if(!e)return this.unlocked=!0,!0;const n=e.volume;return e.volume=0,await e.play(),e.pause(),e.currentTime=0,e.volume=n,this.unlocked=!0,this.enabled=!0,console.debug("AudioManager: audio unlocked by user gesture"),!0}catch(e){return console.warn("AudioManager: unlock failed (user gesture required):",e),this.enabled=!1,this.unlocked=!1,!1}}needsUserGesture(){return!this.unlocked}}const Pe=new Ca;var ja=M("<option> </option>"),Ta=M("<option> </option>"),Aa=M("<option> </option>"),Ra=M('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Virtual MIDI Controls</h4> <div class="control-group svelte-pmsc4d"><label class="svelte-pmsc4d">Root Note: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Keyboard Octave: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Chord Type: <select class="svelte-pmsc4d"></select></label></div></div> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Quick Actions</h4> <div class="button-group svelte-pmsc4d"><button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn stop svelte-pmsc4d">Stop All Notes</button> <button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn svelte-pmsc4d">Random Note</button></div></div>',1),Ha=M('<div class="svelte-pmsc4d"> </div>'),Oa=M('<div class="svelte-pmsc4d"> </div>'),Ia=M('<div class="svelte-pmsc4d"> </div>'),Da=M('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Exercise Status</h4> <div class="status-info svelte-pmsc4d"><!> <!> <!></div></div>'),Fa=M('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Ka=M('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),La=M('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d"> </h4> <div class="shortcuts svelte-pmsc4d"><div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">White Keys:</strong><br/> <!></div> <div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">Black Keys:</strong><br/> <!></div></div></div>'),Pa=M('<div class="debug-content svelte-pmsc4d"><!> <!> <!> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Status</h4> <div class="status svelte-pmsc4d"><p class="svelte-pmsc4d">Active Notes: <span class="count svelte-pmsc4d"> </span></p> <p class="svelte-pmsc4d">Virtual MIDI: <span class="status-good svelte-pmsc4d"> </span></p></div></div></div>'),Va=M('<div><div class="debug-header svelte-pmsc4d"><h3 class="svelte-pmsc4d">ðŸŽ¹ Debug Panel</h3> <button class="toggle-btn svelte-pmsc4d"> </button></div> <!></div>');function Wa(a,e){Te(e,!0);let n=se(e,"debugMode",3,!0),o=se(e,"noteEvents",19,()=>[]),c=se(e,"expectedNotes",19,()=>[]),v=se(e,"currentNotes",19,()=>[]),b=j(()=>c().map(p=>he[p])),R=j(()=>v().map(p=>he[p])),f=D("C"),S=D("maj7"),u=D(4),y=j(()=>{const p=ca(t(u),t(f)),E=P=>P.map(A=>({key:A.toUpperCase(),note:he[p[A.toLowerCase()]]})).filter(A=>A.note);return{white:E(["z","x","c","v","b","n","m"]),black:E(["s","d","g","h","j"])}});et(()=>{e.virtualMidi&&(e.virtualMidi.setOctave(t(u)),e.virtualMidi.setRootNote(t(f)))});function T(){if(!e.virtualMidi)return;const p=t(u)*12+12,E=Ve.indexOf(t(f));if(E===-1)return;const P=p+E,A=At(P,t(S)),C=[A.root,A.third,A.fifth,A.seventh].filter(W=>W!=null&&W!=null);e.virtualMidi.playChord(C)}function N(){e.virtualMidi&&e.virtualMidi.releaseAllKeys()}let m=[];function h(){if(!e.virtualMidi)return;m.forEach(C=>clearTimeout(C)),m=[];const p=t(u)*12+12,E=Ve.indexOf(t(f));if(E===-1)return;const P=p+E;[0,2,4,5,7,9,11,12].map(C=>P+C).forEach((C,W)=>{const Ne=setTimeout(()=>{e.virtualMidi.pressKey(C),setTimeout(()=>e.virtualMidi.releaseKey(C),300)},W*400);m.push(Ne)})}function k(){if(!e.virtualMidi)return;const p=72+Math.floor(Math.random()*24);e.virtualMidi.pressKey(p),setTimeout(()=>e.virtualMidi.releaseKey(p),500)}var O=Va();let K;var ce=r(O),re=l(r(ce),2);re.__click=function(...p){e.onToggleDebugMode?.apply(this,p)};var ne=r(re);s(re),s(ce);var G=l(ce,2);{var ve=p=>{var E=Pa(),P=r(E);{var A=q=>{var ee=Ra(),z=Se(ee),Y=l(r(z),2),oe=r(Y),te=l(r(oe));be(te,21,()=>Ve,pe,(U,Q)=>{var L=ja(),_e=r(L,!0);s(L);var de={};F(()=>{x(_e,t(Q)),de!==(de=t(Q))&&(L.value=(L.__value=t(Q))??"")}),w(U,L)}),s(te),s(oe);var ue=l(oe,2),ae=l(r(ue));be(ae,20,()=>[2,3,4,5,6],pe,(U,Q)=>{var L=Ta(),_e=r(L,!0);s(L);var de={};F(()=>{x(_e,Q),de!==(de=Q)&&(L.value=(L.__value=Q)??"")}),w(U,L)}),s(ae),s(ue);var ge=l(ue,2),I=l(r(ge));be(I,21,()=>fa,pe,(U,Q)=>{var L=Aa(),_e=r(L,!0);s(L);var de={};F(()=>{x(_e,t(Q)),de!==(de=t(Q))&&(L.value=(L.__value=t(Q))??"")}),w(U,L)}),s(I),s(ge),s(Y),s(z);var H=l(z,2),X=l(r(H),2),B=r(X);B.__click=T;var ie=r(B);s(B);var Z=l(B,2);Z.__click=N;var le=l(Z,2);le.__click=h;var fe=r(le);s(le);var me=l(le,2);me.__click=k,s(X),s(H),F(()=>{x(ie,`Play ${t(f)??""}${t(S)??""}`),x(fe,`Play ${t(f)??""} Scale`)}),Je(te,()=>t(f),U=>g(f,U)),Je(ae,()=>t(u),U=>g(u,U)),Je(I,()=>t(S),U=>g(S,U)),w(q,ee)};V(P,q=>{e.virtualMidi&&q(A)})}var C=l(P,2);{var W=q=>{var ee=Da(),z=l(r(ee),2),Y=r(z);{var oe=I=>{var H=Ha(),X=r(H);s(H),F(B=>x(X,`Expected Notes: ${B??""}`),[()=>t(b).join(", ")]),w(I,H)};V(Y,I=>{c().length>0&&I(oe)})}var te=l(Y,2);{var ue=I=>{var H=Oa(),X=r(H);s(H),F(B=>x(X,`Current Notes: ${B??""}`),[()=>t(R).join(", ")]),w(I,H)};V(te,I=>{v().length>0&&I(ue)})}var ae=l(te,2);{var ge=I=>{var H=Ia(),X=r(H);s(H),F(()=>x(X,`Recent Events: ${o().length??""}`)),w(I,H)};V(ae,I=>{o().length>0&&I(ge)})}s(z),s(ee),w(q,ee)};V(C,q=>{(c().length>0||v().length>0)&&q(W)})}var Ne=l(C,2);{var we=q=>{var ee=La(),z=r(ee),Y=r(z);s(z);var oe=l(z,2),te=r(oe),ue=l(r(te),3);be(ue,17,()=>t(y).white,pe,(I,H)=>{let X=()=>t(H).key,B=()=>t(H).note;var ie=Fa(),Z=Se(ie),le=r(Z,!0);s(Z);var fe=l(Z,2),me=r(fe,!0);s(fe),F(()=>{x(le,X()),x(me,B())}),w(I,ie)}),s(te);var ae=l(te,2),ge=l(r(ae),3);be(ge,17,()=>t(y).black,pe,(I,H)=>{let X=()=>t(H).key,B=()=>t(H).note;var ie=Ka(),Z=Se(ie),le=r(Z,!0);s(Z);var fe=l(Z,2),me=r(fe,!0);s(fe),F(()=>{x(le,X()),x(me,B())}),w(I,ie)}),s(ae),s(oe),s(ee),F(()=>x(Y,`Keyboard Shortcuts (Octave ${t(u)??""})`)),w(q,ee)};V(Ne,q=>{e.virtualMidi&&q(we)})}var J=l(Ne,2),Re=l(r(J),2),Ee=r(Re),He=l(r(Ee)),Oe=r(He,!0);s(He),s(Ee);var Ce=l(Ee,2),Ie=l(r(Ce)),ze=r(Ie,!0);s(Ie),s(Ce),s(Re),s(J),s(E),F(q=>{x(Oe,q),x(ze,e.virtualMidi?"Connected":"Disconnected")},[()=>e.virtualMidi?e.virtualMidi.getActiveNotes().length:0]),w(p,E)};V(G,p=>{n()&&p(ve)})}s(O),F(()=>{K=ye(O,1,"debug-panel svelte-pmsc4d",null,K,{visible:n()}),x(ne,`${n()?"Hide":"Show"} Debug`)}),w(a,O),Ae()}tt(["click"]);var za=M('<div><div class="note-role-dot svelte-ouqkuv"></div></div>'),Ba=M("<div><!></div>");function Ua(a,e){Te(e,!0);let n=se(e,"interactive",3,!1),o=se(e,"noteRoleColor",3,"transparent"),c=se(e,"isWrongNote",3,!1),v=![1,3,6,8,10].includes(e.noteNum%12),b=D(0);v||([1,6].includes(e.noteNum%12)?g(b,-e.keyWidth/12):[3,10].includes(e.noteNum%12)&&g(b,e.keyWidth/12));function R(){n()&&e.onclick&&e.onclick()}function f(h){n()&&e.onmousedown&&(e.onmousedown(),h.preventDefault())}function S(h){n()&&e.onmouseup&&(e.onmouseup(),h.preventDefault())}function u(h){n()&&e.onmousedown&&(e.onmousedown(),h.preventDefault())}function y(h){n()&&e.onmouseup&&(e.onmouseup(),h.preventDefault())}var T=Ba();sa(T,()=>({style:`--width: ${e.keyWidth-e.keyWidth*.47*(v?0:1)}px; --height: ${e.keyHeight??""}px; --note-role-color: ${o()??""}; transform: translate(${t(b)??""}px);`,draggable:"false",onclick:R,onmousedown:f,onmouseup:S,ontouchstart:u,ontouchend:y,role:n()?"button":void 0,...n()?{tabindex:0}:{},[ra]:{accidental:!v,natural:v,pressed:e.pressed,interactive:n(),"wrong-note":c()}}),void 0,void 0,void 0,"svelte-ouqkuv");var N=r(T);{var m=h=>{var k=za();let O;F(()=>O=ye(k,1,"note-role-indicator svelte-ouqkuv",null,O,{"natural-indicator":v,"accidental-indicator":!v})),w(h,k)};V(N,h=>{o()&&h(m)})}s(T),w(a,T),Ae()}var Ga=M('<div class="keyboard svelte-1dlz8xf"></div>');function qa(a,e){Te(e,!0);let n=se(e,"expectedNotes",19,()=>[]),o=se(e,"showExpected",3,!1),c=D(10),v=D(10);const b=Math.max(1,Math.min(10,e.octaves||2)),R=Math.max(24,Math.min(108,e.middleC||60));let f=[...Array(b*12+1).keys()].map(y=>y+(R-Math.floor(b/2)*12));const S=12*b;var u=Ga();be(u,21,()=>f,pe,(y,T)=>{const N=j(()=>o()&&n().includes(t(T))?"#2ecc71":ma[e.noteRoles[t(T)]]),m=j(()=>e.midiNotes.includes(t(T))),h=j(()=>t(m)&&n().length>0&&!n().includes(t(T)));{let k=j(()=>t(c)/S);Ua(y,{get noteNum(){return t(T)},get pressed(){return t(m)},get keyWidth(){return t(k)},get keyHeight(){return t(v)},get noteRoleColor(){return t(N)},get isWrongNote(){return t(h)}})}}),s(u),Ct(u,"clientWidth",y=>g(c,y)),Ct(u,"clientHeight",y=>g(v,y)),w(a,u),Ae()}var Ya=M('<div id="score-container" class="svelte-25wfcq"><canvas id="output" class="svelte-25wfcq"></canvas></div>');function Xa(a,e){Te(e,!0);let n=null,o=D(!1);Qe(async()=>{n=await _a(()=>import("./wr6S8XWn.js"),[],import.meta.url),g(o,!0)});const c=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]),v={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","E#":"F","B#":"C"};function b(m){return m.includes("b")?!0:c.has(m)}function R(m){return{"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"}[m]||m}function f(m){const h=/(.*?)(\d+)$/.exec(m);if(!h)return m;let k=h[1];const O=parseInt(h[2],10);return(k==="A#"||k==="D#"||k==="G#"||b(e.selectedNote)&&k.includes("#"))&&(k=v[k]??k),`${k}${O+1}`}const S=m=>m?.map(h=>h.length>1?`(${h.map(k=>f(k)).join(" ")})`:f(h[0])).join(", ")||"";let u=j(()=>S(e.rightHand)),y=j(()=>S(e.leftHand));function T(m){if(!n||!t(o))return;const{Factory:h,Renderer:k,Voice:O}=n,K=m<768,ce=m<480,re=m<360;let ne;re?ne=200:ce?ne=240:K?ne=280:ne=340;const G=document.getElementById("output");if(!G)return;const ve=G.getContext("2d");if(!ve)return;ve.clearRect(0,0,G.width,G.height);const p=new h({renderer:{elementId:"output",backend:k.Backends.CANVAS,width:Math.max(300,m),height:Math.max(200,ne)}}),E=p.EasyScore({throwOnError:!1}),P=K?10:20,A=p.System({width:Math.max(300,m),spaceBetweenStaves:P,noPadding:K,noJustification:K,formatOptions:{alignRests:!0,autoBeam:!0}});if((!e.rightHand||e.rightHand.length===0)&&(!e.leftHand||e.leftHand.length===0)){console.debug("No notes to render, rendering test chord");const C=`${f("C3")}, ${f("E3")}, ${f("G3")}`;try{const W=A.addStave({voices:[E.voice(E.notes(C,{clef:"treble",stem:"up"})).setMode(O.Mode.SOFT)]});W.addClef("treble"),e.selectedNote&&W.addKeySignature(R(e.selectedNote)),p.draw()}catch(W){console.error("Error rendering test chord:",W)}return}console.debug("Rendering score with notes:",{stringLeftHand:t(y),stringRightHand:t(u)}),console.debug("Selected note for key signature:",e.selectedNote);try{if(e.rightHand&&e.rightHand.length>0&&t(u)){const C=A.addStave({voices:[E.voice(E.notes(t(u),{clef:"treble",stem:"up"})).setMode(O.Mode.SOFT)]});C.addClef("treble"),e.selectedNote&&C.addKeySignature(R(e.selectedNote))}if(e.leftHand&&e.leftHand.length>0&&t(y)){const C=A.addStave({voices:[E.voice(E.notes(t(y),{clef:"bass",stem:"down"})).setMode(O.Mode.SOFT)]});C.addClef("bass"),e.selectedNote&&C.addKeySignature(R(e.selectedNote))}e.rightHand&&e.rightHand.length>0&&e.leftHand&&e.leftHand.length>0&&(A.addConnector("brace"),A.addConnector("single")),p.draw()}catch(C){console.error("Error rendering VexFlow score:",C)}}et(()=>{t(o)&&(console.debug("Score $effect triggered with props:",{leftHand:e.leftHand,rightHand:e.rightHand,selectedNote:e.selectedNote}),setTimeout(()=>{const m=document.getElementById("score-container");if(m){const h=m.getBoundingClientRect().width;h>0&&T(h)}},100))}),Qe(()=>{const m=()=>{const h=document.getElementById("score-container");if(h){const k=h.getBoundingClientRect().width;console.debug(`Container width: ${k}`),k>0&&T(k)}};return window.addEventListener("resize",m),()=>{window.removeEventListener("resize",m)}});var N=Ya();w(a,N),Ae()}var Ja=M('<div class="star-wrapper svelte-h6yjv8"><!></div>'),Qa=M('<div class="modal-overlay svelte-h6yjv8"><div class="modal-content svelte-h6yjv8"><div class="modal-header"><h2 class="svelte-h6yjv8">Lesson Complete!</h2> <div class="stars-container svelte-h6yjv8"></div></div> <div class="stats-grid svelte-h6yjv8"><div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">Accuracy</span> <span class="stat-value svelte-h6yjv8"> </span></div> <div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">XP Gained</span> <span class="stat-value svelte-h6yjv8"> </span></div></div> <div class="modal-actions svelte-h6yjv8"><button class="retry-btn svelte-h6yjv8"><!> Retry</button> <button class="continue-btn svelte-h6yjv8">Continue <!></button></div></div></div>');function Za(a,e){var n=jt(),o=Se(n);{var c=v=>{var b=Qa(),R=r(b),f=r(R),S=l(r(f),2);be(S,20,()=>Array(3),pe,(G,ve,p)=>{var E=Ja();Tt(E,`animation-delay: ${p*200}ms`);var P=r(E);{let A=j(()=>p<e.stars?"star-filled":"star-empty"),C=j(()=>p<e.stars?"#ffd700":"none"),W=j(()=>p<e.stars?"#ffd700":"currentColor");ba(P,{size:48,get class(){return t(A)},get fill(){return t(C)},get stroke(){return t(W)}})}s(E),w(G,E)}),s(S),s(f);var u=l(f,2),y=r(u),T=l(r(y),2),N=r(T);s(T),s(y);var m=l(y,2),h=l(r(m),2),k=r(h);s(h),s(m),s(u);var O=l(u,2),K=r(O);K.__click=function(...G){e.onRetry?.apply(this,G)};var ce=r(K);ya(ce,{size:20}),Zt(),s(K);var re=l(K,2);re.__click=function(...G){e.onContinue?.apply(this,G)};var ne=l(r(re));pa(ne,{size:20}),s(re),s(O),s(R),s(b),F(()=>{x(N,`${e.accuracy??""}%`),x(k,`+${e.xp??""}`)}),We(3,R,()=>ia),We(3,b,()=>Ze),w(v,b)};V(o,v=>{e.isOpen&&v(c)})}w(a,n)}tt(["click"]);var $a=M("<option> </option>"),es=M('<div class="control-group svelte-w7gj7d"><label for="note-select" class="svelte-w7gj7d">Root Key</label> <select id="note-select" class="svelte-w7gj7d"></select></div>'),ts=M('<div class="control-group svelte-w7gj7d"><!></div>'),as=M('<div class="exercise-description svelte-w7gj7d"><span class="info-icon svelte-w7gj7d">? <span class="desc-tooltip svelte-w7gj7d"> </span></span></div>'),ss=M('<div class="feedback-toast svelte-w7gj7d"> </div>'),rs=M('<div class="prompt-card card-premium svelte-w7gj7d"><div class="prompt-text svelte-w7gj7d"> </div></div>'),ns=M('<div class="score-container card-premium svelte-w7gj7d"><!></div>'),os=M('<div class="adaptive-help-text"> </div>'),is=M('<div class="debug-panel-wrapper"><!></div>'),ls=M('<div class="exercise-layout"><aside class="sidebar glass svelte-w7gj7d"><div class="sidebar-header svelte-w7gj7d"><h3 class="svelte-w7gj7d">Exercise Controls</h3></div> <div class="sidebar-content"><!> <div class="control-group svelte-w7gj7d"><label for="tempo-toggle" class="svelte-w7gj7d">Tempo Mode</label> <button id="tempo-toggle"> </button></div> <!> <div class="control-group svelte-w7gj7d"><label for="training-mode-toggle" class="svelte-w7gj7d">Training Mode</label> <button id="training-mode-toggle" title="If enabled, mistakes will stop the lesson until you correct it"> </button></div> <div class="control-group svelte-w7gj7d"><label for="debug-toggle" class="svelte-w7gj7d">Virtual Keyboard</label> <button id="debug-toggle"> </button></div> <div class="sidebar-spacer"></div> <button class="reset-btn svelte-w7gj7d">Reset Session</button></div></aside> <main class="exercise-main svelte-w7gj7d"><header class="exercise-header svelte-w7gj7d"><div class="info-group svelte-w7gj7d"><!> <h1 class="svelte-w7gj7d"> </h1></div> <div class="performance-strip svelte-w7gj7d"><div><span class="label">Mistakes:</span> <span class="value"> </span></div> <div class="stat-pill success svelte-w7gj7d"><span class="label">Progress:</span> <span class="value"> </span></div></div></header> <!> <div class="focus-area svelte-w7gj7d"><!> <!> <!> <div><!></div> <div class="exercise-custom-content"><!></div></div> <!> <footer class="exercise-footer svelte-w7gj7d"><div class="progress-track svelte-w7gj7d"><div class="progress-fill svelte-w7gj7d"></div></div></footer></main></div> <!>',1);function Ts(a,e){Te(e,!0);let n=se(e,"randomMode",3,!1),o=se(e,"exerciseType",3,"chord"),c=se(e,"progressiveHints",3,!0);const v=1,b=3,R=3;let f=D(Xe(e.initialNote??"C"));et(()=>{e.initialNote!==void 0&&e.initialNote!==t(f)&&(g(f,e.initialNote,!0),z())});let S=D(Xe([])),u=D(0),y=D(Xe(new Set)),T=D(0),N=D(!1),m=D(!1),h=D(""),k=!1,O=D(!1),K=D(!1),ce=D(0),re=120;const ne=150;let G=j(()=>e.showScore===!1?!1:o()==="partition"?!0:c()?t(u)>=v:e.showScore??!0);const ve=j(()=>Et.url.searchParams.get("unitId")),p=j(()=>Et.url.searchParams.get("lessonId")),E=j(()=>!!t(ve)&&!!t(p));let P=D(!1),A=D(0),C=D(0),W=D(0),Ne=j(()=>t(u)>=R),we=j(()=>t(S).map(i=>i.noteNumber)),J=j(()=>e.generateExpectedNotes(t(f))),Re=j(()=>e.generateScoreProps(t(f))),Ee=j(()=>t(m)||c()&&t(u)>=b),He=j(()=>({...Sa(t(J)),midiNotes:t(we),debugMode:t(m),noteRoles:Object.fromEntries(t(J).map(i=>[i,Ea(i,st[`${t(f)}${at}`])])),expectedNotes:t(J),showExpected:t(Ne)})),Oe=j(()=>{if(t(J).length===0)return 0;const i=[...new Set(t(J))];return Math.round(t(y).size/i.length*100)}),Ce=j(()=>{if(!c()||t(N)||o()==="partition")return"";if(t(u)<v){let i=`correct ${o()||"note"}`;if(e.prompt){const d=o()==="II-V-I"?"progression":o()==="note"?"note":o();i=`${e.prompt} ${d}`}return`Play the ${i}. After ${v-t(u)} more mistake${v-t(u)===1?"":"s"} the score will appear.`}return t(u)<b?`Reference keyboard will appear after ${b-t(u)} more mistake${b-t(u)===1?"":"s"}.`:"Adaptive help is active. Use the score and keyboard for reference."}),Ie=j(()=>({selectedNote:t(f),currentNotes:t(we),expectedNotes:t(J),mistakes:t(u),completed:t(N),collectedNotes:t(y),debugMode:t(m),feedbackMessage:t(h),showNotesRoles:k,tempoMode:t(K),toggleDebug:ae,showFeedback:Y,toggleTempoMode:H,handleTick:I,completeExercise:i=>oe(i)}));Xt(()=>{Me.cleanup()}),Qe(async()=>{await Me.initialize(),Me.setupVirtualKeyboard(),Me.setEventHandlers({onNoteOn:ze,onNoteOff:q}),g(T,Date.now(),!0);const i=async()=>{if(Pe.needsUserGesture()){const d=await Pe.unlock();Y(d?"Audio enabled":"Click or press any key to enable audio","info")}};window.addEventListener("pointerdown",i,{once:!0}),window.addEventListener("keydown",i,{once:!0})});function ze(i){if(t(m)&&console.debug(`MIDI Note ON: ${i.noteNumber} (${i.noteFullName}) velocity=${i.velocity} channel=${i.channel}`),t(K)){const _=Date.now(),$=60/re*1e3,ke=_-t(ce),je=$-ke;Math.min(ke,je)>ne&&(Y("Off beat! Try to play on the beat.","error"),Mt(u))}g(S,[...t(S),i],!0);const d=e.validateNoteEvent(t(f),i,t(J),t(we));if(d.resetCollected&&g(y,new Set,!0),d.collected&&t(y).add(i.noteNumber),d.isCorrect)Y(d.message,"success");else if(Mt(u),Y(d.message,"error"),Pe.playError(),t(O)){g(h,"error : Mistake! Take your time...");return}if(o()){const _=o()==="II-V-I"?"progression":o()==="note"||o()==="interval"?"chord":o();St.updateNoteProgress(i.noteName,_,void 0,d.isCorrect,0,d.isCorrect?100:0)}e.isCompleted(t(we),t(J))&&oe()}function q(i){t(m)&&console.debug(`MIDI Note OFF: ${i.noteNumber} (${i.noteFullName}) channel=${i.channel}`),g(S,t(S).filter(d=>d.noteNumber!==i.noteNumber),!0)}function ee(i){g(f,i,!0),z()}function z(){g(S,[],!0),g(u,0),g(N,!1),g(h,""),g(T,Date.now(),!0),g(f,t(f),!0),g(y,new Set,!0),e.onReset?.()}function Y(i,d){g(h,`${d} : ${i}`),setTimeout(()=>{g(h,"")},5e3)}function oe(i){console.log("Exercise Completed!",{exerciseType:o(),mistakes:t(u),startTime:t(T)}),g(N,!0);const d=Date.now()-t(T),_=Math.round((t(J).length-t(u))/t(J).length*100);if(Y(`Exercise completed! Time: ${d}ms, Accuracy: ${_}%`,"success"),Pe.playSound?.("success"),o()){console.log("Recording stats...",{exerciseType:o(),success:!0,accuracy:_,timeElapsed:d});const $=o()==="II-V-I"?"progression":o()==="note"||o()==="interval"?"chord":o();St.recordExerciseResult({exerciseId:window.location.pathname,exerciseType:$,success:!0,accuracy:_,timeElapsed:d,mistakes:t(u),score:Math.max(0,100-t(u)*10),timestamp:new Date,...i})}else console.warn("No exerciseType provided, stats not recorded.");t(E)&&t(ve)&&t(p)?(g(A,t(u)===0?3:t(u)<=2?2:1,!0),g(C,_,!0),g(W,Math.max(0,100-t(u)*10),!0),ga.completeLesson(t(ve),t(p),t(A)),g(P,!0)):(e.onComplete?.(),z())}function te(){g(P,!1),ha("/journey")}function ue(){g(P,!1),z()}function ae(){g(m,!t(m)),Me.setDebugMode(t(m))}function ge(i){const _=i.target.value;ee(_)}function I(i){g(ce,i,!0)}function H(){g(K,!t(K))}var X=ls(),B=Se(X),ie=r(B),Z=l(r(ie),2),le=r(Z);{var fe=i=>{var d=es(),_=l(r(d),2);_.__change=ge,be(_,21,()=>Ve,pe,(ke,je)=>{var xe=$a(),Yt=r(xe,!0);s(xe);var xt={};F(()=>{x(Yt,t(je)),xt!==(xt=t(je))&&(xe.value=(xe.__value=t(je))??"")}),w(ke,xe)}),s(_);var $;na(_),s(d),F(()=>{$!==($=t(f))&&(_.value=(_.__value=t(f))??"",oa(_,t(f)))}),w(i,d)};V(le,i=>{n()||i(fe)})}var me=l(le,2),U=l(r(me),2);let Q;U.__click=H;var L=r(U,!0);s(U),s(me);var _e=l(me,2);{var de=i=>{var d=ts(),_=r(d);da(_,{onTick:I}),s(d),w(i,d)};V(_e,i=>{t(K)&&i(de)})}var Be=l(_e,2),De=l(r(Be),2);De.__click=()=>g(O,!t(O));let nt;var Rt=r(De,!0);s(De),s(Be);var Ue=l(Be,2),Fe=l(r(Ue),2);Fe.__click=ae;let ot;var Ht=r(Fe,!0);s(Fe),s(Ue);var Ot=l(Ue,4);Ot.__click=z,s(Z),s(ie);var it=l(ie,2),Ge=r(it),qe=r(Ge),lt=r(qe);{var It=i=>{var d=as(),_=r(d),$=l(r(_)),ke=r($,!0);s($),s(_),s(d),F(()=>x(ke,e.description)),w(i,d)};V(lt,i=>{e.description&&i(It)})}var ct=l(lt,2),Dt=r(ct,!0);s(ct),s(qe);var dt=l(qe,2),Ke=r(dt);let vt;var ut=l(r(Ke),2),Ft=r(ut,!0);s(ut),s(Ke);var ft=l(Ke,2),mt=l(r(ft),2),Kt=r(mt);s(mt),s(ft),s(dt),s(Ge);var ht=l(Ge,2);{var Lt=i=>{var d=ss(),_=r(d,!0);s(d),F(()=>x(_,t(h))),We(3,d,()=>Ze),w(i,d)};V(ht,i=>{t(h)&&i(Lt)})}var Ye=l(ht,2),gt=r(Ye);{var Pt=i=>{var d=rs(),_=r(d),$=r(_,!0);s(_),s(d),F(()=>x($,e.prompt)),w(i,d)};V(gt,i=>{e.prompt&&!t(G)&&i(Pt)})}var _t=l(gt,2);{var Vt=i=>{var d=ns(),_=r(d);Xa(_,$e(()=>t(Re))),s(d),We(1,d,()=>Ze),w(i,d)};V(_t,i=>{t(G)&&i(Vt)})}var bt=l(_t,2);{var Wt=i=>{var d=os(),_=r(d,!0);s(d),F(()=>x(_,t(Ce))),w(i,d)};V(bt,i=>{t(Ce)&&i(Wt)})}var Le=l(bt,2);let pt;var zt=r(Le);qa(zt,$e(()=>t(He))),s(Le);var wt=l(Le,2),Bt=r(wt);aa(Bt,()=>e.children??$t,()=>t(Ie)),s(wt),s(Ye);var yt=l(Ye,2);{var Ut=i=>{var d=is(),_=r(d);{let $=j(()=>Me.getVirtualMidi()??void 0);Wa(_,{get noteEvents(){return t(S)},get expectedNotes(){return t(J)},get currentNotes(){return t(we)},get debugMode(){return t(m)},onToggleDebugMode:ae,get virtualMidi(){return t($)}})}s(d),w(i,d)};V(yt,i=>{t(m)&&i(Ut)})}var Nt=l(yt,2),kt=r(Nt),Gt=r(kt);s(kt),s(Nt),s(it),s(B);var qt=l(B,2);Za(qt,{get isOpen(){return t(P)},get stars(){return t(A)},get accuracy(){return t(C)},get xp(){return t(W)},onContinue:te,onRetry:ue}),F(i=>{Q=ye(U,1,"toggle-btn svelte-w7gj7d",null,Q,{active:t(K)}),x(L,t(K)?"Enabled":"Disabled"),nt=ye(De,1,"toggle-btn svelte-w7gj7d",null,nt,{active:t(O)}),x(Rt,t(O)?"Stop on Mistake":"Free Play"),ot=ye(Fe,1,"toggle-btn svelte-w7gj7d",null,ot,{active:t(m)}),x(Ht,t(m)?"Visible":"Hidden"),x(Dt,i),vt=ye(Ke,1,"stat-pill svelte-w7gj7d",null,vt,{neutral:t(u)===0,warn:t(u)>0}),x(Ft,t(u)),x(Kt,`${t(Oe)??""}%`),pt=ye(Le,1,"keyboard-container svelte-w7gj7d",null,pt,{hidden:!t(Ee)}),Tt(Gt,`width: ${t(Oe)??""}%`)},[()=>o()?.toUpperCase()||"PRACTICE"]),w(a,X),Ae()}tt(["change","click"]);export{Ts as B,At as a,xa as b,js as c,Ma as d,Cs as g};
