import{a3 as $,E as O,aG as z,an as F,e as K,aH as j,aI as _,af as J,ay as q,W as M,h as B,aJ as W,aK as G}from"./ZtE6Gyvq.js";import{b as H}from"./BnZ86L-c.js";const Q=()=>performance.now(),v={tick:i=>requestAnimationFrame(i),now:()=>Q(),tasks:new Set};function L(){const i=v.now();v.tasks.forEach(t=>{t.c(i)||(v.tasks.delete(t),t.f())}),v.tasks.size!==0&&v.tick(L)}function V(i){let t;return v.tasks.size===0&&v.tick(L),{promise:new Promise(e=>{v.tasks.add(t={c:i,f:e})}),abort(){v.tasks.delete(t)}}}function C(i,t){_(()=>{i.dispatchEvent(new CustomEvent(t))})}function X(i){if(i==="float")return"cssFloat";if(i==="offset")return"cssOffset";if(i.startsWith("--"))return i;const t=i.split("-");return t.length===1?t[0]:t[0]+t.slice(1).map(e=>e[0].toUpperCase()+e.slice(1)).join("")}function N(i){const t={},e=i.split(";");for(const s of e){const[a,r]=s.split(":");if(!a||r===void 0)break;const n=X(a.trim());t[n]=r.trim()}return t}const Y=i=>i;function et(i,t,e,s){var a=(i&W)!==0,r=(i&G)!==0,n=a&&r,l=(i&j)!==0,o=n?"both":a?"in":"out",d,h=t.inert,S=t.style.overflow,u,m;function y(){return _(()=>d??=e()(t,s?.()??{},{direction:o}))}var f={is_global:l,in(){if(t.inert=h,!a){m?.abort(),m?.reset?.();return}r||u?.abort(),C(t,"introstart"),u=k(t,y(),m,1,()=>{C(t,"introend"),u?.abort(),u=d=void 0,t.style.overflow=S})},out(P){if(!r){P?.(),d=void 0;return}t.inert=!0,C(t,"outrostart"),m=k(t,y(),u,0,()=>{C(t,"outroend"),P?.()})},stop:()=>{u?.abort(),m?.abort()}},g=$;if((g.transitions??=[]).push(f),a&&H){var w=l;if(!w){for(var p=g.parent;p&&(p.f&O)!==0;)for(;(p=p.parent)&&(p.f&z)===0;);w=!p||(p.f&F)!==0}w&&K(()=>{B(()=>f.in())})}}function k(i,t,e,s,a){var r=s===1;if(J(t)){var n,l=!1;return q(()=>{if(!l){var g=t({direction:r?"in":"out"});n=k(i,g,e,s,a)}}),{abort:()=>{l=!0,n?.abort()},deactivate:()=>n.deactivate(),reset:()=>n.reset(),t:()=>n.t()}}if(e?.deactivate(),!t?.duration)return a(),{abort:M,deactivate:M,reset:M,t:()=>s};const{delay:o=0,css:d,tick:h,easing:S=Y}=t;var u=[];if(r&&e===void 0&&(h&&h(0,1),d)){var m=N(d(0,1));u.push(m,m)}var y=()=>1-s,f=i.animate(u,{duration:o,fill:"forwards"});return f.onfinish=()=>{f.cancel();var g=e?.t()??1-s;e?.abort();var w=s-g,p=t.duration*Math.abs(w),P=[];if(p>0){var x=!1;if(d)for(var T=Math.ceil(p/16.666666666666668),A=0;A<=T;A+=1){var b=g+w*S(A/T),I=N(d(b,1-b));P.push(I),x||=I.overflow==="hidden"}x&&(i.style.overflow="hidden"),y=()=>{var D=f.currentTime;return g+w*S(D/p)},h&&V(()=>{if(f.playState!=="running")return!1;var D=y();return h(D,1-D),!0})}f=i.animate(P,{duration:p,fill:"forwards"}),f.onfinish=()=>{y=()=>s,h?.(s,1-s),a()}},{abort:()=>{f&&(f.cancel(),f.effect=null,f.onfinish=M)},deactivate:()=>{a=M},reset:()=>{s===0&&h?.(1,0)},t:()=>y()}}class c{static instance;static hasLocalStorage(){try{if(typeof globalThis>"u")return!1;const t=globalThis.localStorage;return!!t&&typeof t.getItem=="function"&&typeof t.setItem=="function"&&typeof t.removeItem=="function"}catch{return!1}}static _memoryStorage=null;static _storageResolved=!1;static _usingRealLocalStorage=!1;static getStorage(){try{const t=globalThis.localStorage;if(t&&typeof t.getItem=="function"&&typeof t.setItem=="function"&&typeof t.removeItem=="function")return c._storageResolved||(c._usingRealLocalStorage=!0,c._storageResolved=!0,console.info("UserStatsService: using real localStorage")),t;!c._storageResolved&&t&&(c._usingRealLocalStorage=!1,c._storageResolved=!0,console.warn("UserStatsService: localStorage object detected but missing expected methods â€” using in-memory fallback"))}catch{c._storageResolved||(c._usingRealLocalStorage=!1,c._storageResolved=!0,console.info("UserStatsService: accessing localStorage threw an error â€” using in-memory fallback"))}return c._memoryStorage||(c._memoryStorage=new Map),c._storageResolved||(c._usingRealLocalStorage=!1,c._storageResolved=!0,typeof window<"u"&&console.info("UserStatsService: no localStorage available â€” using in-memory fallback")),{getItem(t){return c._memoryStorage.has(t)?c._memoryStorage.get(t):null},setItem(t,e){c._memoryStorage.set(t,e)},removeItem(t){c._memoryStorage.delete(t)}}}storageKey="jazz-midi-user-stats";profileKey="jazz-midi-user-profile";listeners=[];profile;statistics;constructor(){this.profile=this.loadProfile(),this.statistics=this.loadStatistics()}static getInstance(){return c.instance||(c.instance=new c),c.instance}getProfile(){return{...this.profile}}updateProfile(t){this.profile={...this.profile,...t,lastActivity:new Date},this.saveProfile()}createProfile(t){this.profile={...this.createDefaultProfile(),id:crypto.randomUUID(),name:t,createdAt:new Date,lastActivity:new Date},this.saveProfile(),this.statistics=this.createDefaultStatistics(),this.saveStatistics(),this.notifyListeners()}getStatistics(){return{...this.statistics}}recordExerciseResult(t){this.updateOverallStats(t),this.updateTypeStats(t),this.updateMastery(t),this.updateStreak(t),this.updateDailyPractice(t),this.checkAchievements(),this.profile.lastActivity=new Date,this.profile.experiencePoints+=this.calculateExperiencePoints(t),this.profile.level=this.calculateLevel(this.profile.experiencePoints),this.saveStatistics(),this.saveProfile(),this.notifyListeners()}getChordMastery(t,e){return this.statistics.masteredChords.find(s=>s.root===t&&s.chordType===e)||null}getScaleMastery(t,e){return this.statistics.masteredScales.find(s=>s.root===t&&s.scaleType===e)||null}getProgressionMastery(t,e){return this.statistics.masteredProgressions.find(s=>s.key===t&&s.progressionType===e)||null}getAchievements(){return this.getDefaultAchievements().map(t=>{const e=this.calculateAchievementProgress(t);return{...t,progress:e,unlockedAt:e>=100?this.profile.lastActivity:void 0}})}startSession(){c.getStorage().setItem("jazz-midi-session-start",Date.now().toString())}endSession(){const t=c.getStorage(),e=t.getItem("jazz-midi-session-start");if(e){const s=(Date.now()-parseInt(e))/6e4;this.recordSession(s),t.removeItem("jazz-midi-session-start")}}exportData(){return JSON.stringify({profile:this.profile,statistics:this.statistics,exportDate:new Date,version:"1.0"},null,2)}importData(t){try{const e=JSON.parse(t);if(e.profile&&e.statistics)return this.profile={...this.profile,...e.profile},this.statistics={...this.statistics,...e.statistics},this.saveProfile(),this.saveStatistics(),this.notifyListeners(),!0}catch(e){console.error("Failed to import user data:",e)}return!1}subscribe(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}loadProfile(){try{const e=c.getStorage().getItem(this.profileKey);if(e){const s=JSON.parse(e);return{...s,createdAt:new Date(s.createdAt),lastActivity:new Date(s.lastActivity)}}}catch(t){console.warn("Failed to load user profile:",t)}return this.createDefaultProfile()}loadStatistics(){try{const e=c.getStorage().getItem(this.storageKey);if(e){const s=JSON.parse(e),a=r=>r?Array.isArray(r)?new Map(r):typeof r=="object"?new Map(Object.entries(r)):new Map:new Map;return{...s,noteProgress:a(s.noteProgress),missedNotes:a(s.missedNotes),missedChords:a(s.missedChords),practiceCalendar:a(s.practiceCalendar),masteredChords:s.masteredChords?.map(r=>({...r,lastPracticed:new Date(r.lastPracticed)}))||[],masteredScales:s.masteredScales?.map(r=>({...r,lastPracticed:new Date(r.lastPracticed)}))||[],masteredProgressions:s.masteredProgressions?.map(r=>({...r,lastPracticed:new Date(r.lastPracticed)}))||[],recentSessions:s.recentSessions?.map(r=>({...r,date:new Date(r.date)}))||[]}}}catch(t){console.warn("Failed to load user statistics:",t)}return this.createDefaultStatistics()}createDefaultProfile(){return{id:crypto.randomUUID(),name:"Jazz Student",createdAt:new Date,lastActivity:new Date,totalPracticeTime:0,level:1,experiencePoints:0}}createDefaultStatistics(){return{totalExercises:0,completedExercises:0,averageAccuracy:0,averageScore:0,totalPracticeTime:0,currentStreak:0,longestStreak:0,noteProgress:new Map,missedNotes:new Map,missedChords:new Map,practiceCalendar:new Map,chordStats:this.createDefaultTypeStats(),scaleStats:this.createDefaultTypeStats(),progressionStats:this.createDefaultTypeStats(),partitionStats:this.createDefaultTypeStats(),rhythmStats:this.createDefaultTypeStats(),masteredChords:[],masteredScales:[],masteredProgressions:[],recentSessions:[],improvementTrend:0}}createDefaultTypeStats(){return{attempted:0,completed:0,averageAccuracy:0,averageScore:0,bestScore:0,totalTime:0,masteryLevel:"beginner"}}updateOverallStats(t){this.statistics.totalExercises++,t.success&&this.statistics.completedExercises++;const e=this.statistics.totalExercises;this.statistics.averageAccuracy=(this.statistics.averageAccuracy*(e-1)+t.accuracy)/e,this.statistics.averageScore=(this.statistics.averageScore*(e-1)+t.score)/e,this.statistics.totalPracticeTime+=t.timeElapsed/(1e3*60)}updateTypeStats(t){const e=this.getTypeStats(t.exerciseType);e.attempted++,t.success&&e.completed++;const s=e.attempted;if(e.averageAccuracy=(e.averageAccuracy*(s-1)+t.accuracy)/s,e.averageScore=(e.averageScore*(s-1)+t.score)/s,e.bestScore=Math.max(e.bestScore,t.score),e.totalTime+=t.timeElapsed/(1e3*60),t.avgDeviationMs!==void 0){const a=e.completed;e.avgDeviationMs=((e.avgDeviationMs||0)*(a-1)+t.avgDeviationMs)/a}e.masteryLevel=this.calculateMasteryLevel(e)}updateMastery(t){}updateStreak(t){t.success&&t.accuracy>=80?(this.statistics.currentStreak++,this.statistics.longestStreak=Math.max(this.statistics.longestStreak,this.statistics.currentStreak)):this.statistics.currentStreak=0}getTypeStats(t){switch(t){case"chord":return this.statistics.chordStats;case"scale":return this.statistics.scaleStats;case"progression":return this.statistics.progressionStats;case"partition":return this.statistics.partitionStats;case"rhythm":return this.statistics.rhythmStats;default:throw new Error(`Unknown exercise type: ${t}`)}}calculateMasteryLevel(t){return t.averageScore>=90&&t.attempted>=100?"expert":t.averageScore>=80&&t.attempted>=50?"advanced":t.averageScore>=70&&t.attempted>=20?"intermediate":"beginner"}calculateExperiencePoints(t){let e=t.score;return t.success&&(e+=10),t.accuracy>=100&&(e+=20),t.mistakes===0&&(e+=15),e}calculateLevel(t){return Math.floor(t/1e3)+1}recordSession(t){const e={date:new Date,duration:t,exercisesCompleted:0,averageScore:0,topCategory:"chords",improvements:[]};this.statistics.recentSessions.unshift(e),this.statistics.recentSessions.length>10&&this.statistics.recentSessions.pop()}getDefaultAchievements(){return[{id:"first-chord",name:"First Chord",description:"Complete your first chord exercise",icon:"ðŸŽµ",progress:0,requirements:[{type:"exercise_count",target:1,current:0}]},{id:"chord-master",name:"Chord Master",description:"Complete 100 chord exercises",icon:"ðŸŽ¼",progress:0,requirements:[{type:"exercise_count",target:100,current:0}]},{id:"perfect-accuracy",name:"Perfect Performance",description:"Achieve 100% accuracy in an exercise",icon:"â­",progress:0,requirements:[{type:"accuracy",target:100,current:0}]},{id:"practice-streak",name:"Practice Makes Perfect",description:"Maintain a 7-day practice streak",icon:"ðŸ”¥",progress:0,requirements:[{type:"streak",target:7,current:0}]}]}calculateAchievementProgress(t){switch(t.id){case"first-chord":return this.statistics.chordStats.completed>0?100:0;case"chord-master":return Math.min(100,this.statistics.chordStats.completed/100*100);case"perfect-accuracy":return this.statistics.averageAccuracy>=100?100:0;case"practice-streak":return Math.min(100,this.statistics.currentStreak/7*100);default:return 0}}checkAchievements(){}updateNoteProgress(t,e,s,a,r,n){const l=this.generateProgressKey(t,e,s);let o=this.statistics.noteProgress.get(l);o||(o={note:t,exerciseType:e,chordType:s,attempts:0,successes:0,averageAccuracy:0,bestTime:1/0,lastPracticed:new Date,masteryLevel:"beginner"}),o.attempts++,a&&o.successes++,o.averageAccuracy=(o.averageAccuracy*(o.attempts-1)+n)/o.attempts,r<o.bestTime&&(o.bestTime=r),o.lastPracticed=new Date;const d=o.successes/o.attempts;d>=.95&&o.averageAccuracy>=95?o.masteryLevel="mastered":d>=.8&&o.averageAccuracy>=80?o.masteryLevel="advanced":d>=.6&&o.averageAccuracy>=60?o.masteryLevel="intermediate":o.masteryLevel="beginner",this.statistics.noteProgress.set(l,o),this.saveStatistics(),this.notifyListeners()}getNoteProgress(t,e,s){const a=this.generateProgressKey(t,e,s);return this.statistics.noteProgress.get(a)}getProgressByType(t){return Array.from(this.statistics.noteProgress.values()).filter(e=>e.exerciseType===t)}generateProgressKey(t,e,s){return s?`${t}-${e}-${s}`:`${t}-${e}`}saveProfile(){try{c.getStorage().setItem(this.profileKey,JSON.stringify(this.profile))}catch(t){console.warn("Failed to save user profile:",t)}}saveStatistics(){try{const t=c.getStorage(),e={...this.statistics,noteProgress:Array.from(this.statistics.noteProgress.entries()),missedNotes:Array.from(this.statistics.missedNotes.entries()),missedChords:Array.from(this.statistics.missedChords.entries()),practiceCalendar:Array.from(this.statistics.practiceCalendar.entries())};t.setItem(this.storageKey,JSON.stringify(e))}catch(t){console.warn("Failed to save user statistics:",t)}}notifyListeners(){this.listeners.forEach(t=>{try{t(this.statistics)}catch(e){console.error("Error in stats listener:",e)}})}trackMissedNote(t,e){const s=this.statistics.missedNotes.get(t);s?(s.count++,s.lastMissed=new Date):this.statistics.missedNotes.set(t,{count:1,lastMissed:new Date,exerciseType:e}),this.saveStatistics(),this.notifyListeners()}trackMissedChord(t,e){const s=this.statistics.missedChords.get(t);s?(s.count++,s.lastMissed=new Date):this.statistics.missedChords.set(t,{count:1,lastMissed:new Date,exerciseType:e}),this.saveStatistics(),this.notifyListeners()}getMostMissedNotes(t=12){return this.statistics.missedNotes instanceof Map||(this.statistics.missedNotes=new Map),Array.from(this.statistics.missedNotes.entries()).map(([e,s])=>({note:e,count:s.count,lastMissed:s.lastMissed})).sort((e,s)=>s.count-e.count).slice(0,t)}getMostMissedChords(t=5){return this.statistics.missedChords instanceof Map||(this.statistics.missedChords=new Map),Array.from(this.statistics.missedChords.entries()).map(([e,s])=>({chord:e,count:s.count,lastMissed:s.lastMissed,exerciseType:s.exerciseType})).sort((e,s)=>s.count-e.count).slice(0,t)}getWeaknessRecommendations(){const t=[],e=this.getMostMissedNotes(3),s=this.getMostMissedChords(3);return e.forEach(({note:a})=>{const r=a.replace(/[0-9]/g,"");t.push({weakness:`Note: ${a}`,recommendedExercise:`${r} Major Scale`,path:`/exercises/scales?root=${r}&mode=Maj`})}),s.forEach(({chord:a})=>{t.push({weakness:`Chord: ${a}`,recommendedExercise:`${a} Practice`,path:"/exercises/chords?root=C&quality=maj7"})}),t.slice(0,5)}updateDailyPractice(t){const s=new Date().toISOString().split("T")[0],a=this.statistics.practiceCalendar.get(s);a?(a.exercisesCompleted++,a.practiceTime+=t.timeElapsed/(1e3*60)):this.statistics.practiceCalendar.set(s,{date:s,exercisesCompleted:1,practiceTime:t.timeElapsed/(1e3*60)})}getPracticeCalendar(t=84){const e=[],s=new Date;this.statistics.practiceCalendar instanceof Map||(this.statistics.practiceCalendar=new Map);for(let a=t-1;a>=0;a--){const r=new Date(s);r.setDate(r.getDate()-a);const n=r.toISOString().split("T")[0],l=this.statistics.practiceCalendar.get(n);l?e.push(l):e.push({date:n,exercisesCompleted:0,practiceTime:0})}return e}getPracticeStreak(){const t=new Date;let e=0,s=0,a=0;const r=t.toISOString().split("T")[0];this.statistics.practiceCalendar.has(r);for(let n=0;n<365;n++){const l=new Date(t);l.setDate(l.getDate()-n);const o=l.toISOString().split("T")[0];if(this.statistics.practiceCalendar.has(o)){if(n===0||a>0)a++,e===0&&(e=a);else break;s=Math.max(s,a)}else{if(n===0)continue;a>0&&(s=Math.max(s,a),a=0)}}return{current:e,longest:Math.max(s,this.statistics.longestStreak)}}}const st=c.getInstance(),Z=i=>i;function R(i){const t=i-1;return t*t*t+1}function E(i){const t=typeof i=="string"&&i.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return t?[parseFloat(t[1]),t[2]||"px"]:[i,"px"]}function at(i,{delay:t=0,duration:e=400,easing:s=Z}={}){const a=+getComputedStyle(i).opacity;return{delay:t,duration:e,easing:s,css:r=>`opacity: ${r*a}`}}function rt(i,{delay:t=0,duration:e=400,easing:s=R,x:a=0,y:r=0,opacity:n=0}={}){const l=getComputedStyle(i),o=+l.opacity,d=l.transform==="none"?"":l.transform,h=o*(1-n),[S,u]=E(a),[m,y]=E(r);return{delay:t,duration:e,easing:s,css:(f,g)=>`
			transform: ${d} translate(${(1-f)*S}${u}, ${(1-f)*m}${y});
			opacity: ${o-h*g}`}}function it(i,{delay:t=0,duration:e=400,easing:s=R,start:a=0,opacity:r=0}={}){const n=getComputedStyle(i),l=+n.opacity,o=n.transform==="none"?"":n.transform,d=1-a,h=l*(1-r);return{delay:t,duration:e,easing:s,css:(S,u)=>`
			transform: ${o} scale(${1-d*u});
			opacity: ${l-h*u}
		`}}export{rt as a,at as f,it as s,et as t,st as u};
