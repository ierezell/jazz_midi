import{c as V,a as C,f as H}from"./BHFmxDGj.js";import{f as R,p as T,c as m,s as D,t as q,a as B,v as u,X as M,U as A,r as f}from"./D-WvxLPx.js";import{d as j,s as z}from"./y4LLdheI.js";import{i as S}from"./DD9bTvrE.js";import{I as U,s as F,r as G,d as W}from"./C_BxDK4Q.js";import{s as X}from"./DiVgXp1T.js";import"./L29NmxKK.js";import{l as J,s as Q}from"./CcxOe7hN.js";import{P as Y}from"./Br58hHMv.js";import{M as Z}from"./DgZpB3qr.js";import{_ as ee}from"./PPVm8Dsz.js";function te(o,e){const t=J(e,["children","$$slots","$$events","$$legacy"]);const s=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1"}]];U(o,Q({name:"pause"},()=>t,{get iconNode(){return s},children:(n,i)=>{var a=V(),r=R(a);F(r,e,"default",{}),C(n,a)},$$slots:{default:!0}}))}var se=H('<div class="metronome svelte-1lsk5dc"><div class="controls svelte-1lsk5dc"><button><!></button> <div class="bpm-control svelte-1lsk5dc"><span class="bpm-display svelte-1lsk5dc"> </span> <input type="range" min="40" max="240" class="bpm-slider svelte-1lsk5dc"/></div></div></div>');function ge(o,e){T(e,!0);let t=A(120),s=A(!1),n=null,i=null;function a(){u(s)?l():r()}function r(){i||(i=new AudioContext),M(s,!0);const c=60/u(t)*1e3;v(),n=window.setInterval(v,c)}function l(){M(s,!1),n&&(clearInterval(n),n=null)}function v(){if(!i)return;const c=i.createOscillator(),d=i.createGain();c.connect(d),d.connect(i.destination),c.frequency.value=1e3,d.gain.value=.5,c.start(),d.gain.exponentialRampToValueAtTime(.001,i.currentTime+.1),c.stop(i.currentTime+.1),e.onTick?.(Date.now())}function $(c){const d=c.target;M(t,parseInt(d.value),!0),u(s)&&(l(),r())}var g=se(),k=m(g),p=m(k);let E;p.__click=a;var L=m(p);{var O=c=>{te(c,{size:20})},P=c=>{Y(c,{size:20})};S(L,c=>{u(s)?c(O):c(P,!1)})}f(p);var w=D(p,2),y=m(w),K=m(y);f(y);var I=D(y,2);G(I),I.__input=$,f(w),f(k),f(g),q(()=>{E=X(p,1,"toggle-btn svelte-1lsk5dc",null,E,{playing:u(s)}),z(K,`${u(t)??""} BPM`),W(I,u(t))}),C(o,g),B()}j(["click","input"]);class ie{constructor(e={}){this.options=e,this.options={velocity:100,channel:0,...e}}listeners=[];activeNotes=new Set;currentOctave=4;addEventListener(e,t){e==="midimessage"&&this.listeners.push(t)}removeEventListener(e,t){if(e==="midimessage"){const s=this.listeners.indexOf(t);s>-1&&this.listeners.splice(s,1)}}pressKey(e,t=this.options.velocity||100){if(this.activeNotes.has(e))return;this.activeNotes.add(e);const s=this.createMidiMessage(144,e,t);this.dispatchMidiEvent(s)}releaseKey(e){if(!this.activeNotes.has(e))return;this.activeNotes.delete(e);const t=this.createMidiMessage(128,e,0);this.dispatchMidiEvent(t)}releaseAllKeys(){for(const e of this.activeNotes)this.releaseKey(e)}getActiveNotes(){return Array.from(this.activeNotes)}playChord(e,t=this.options.velocity||100){e.forEach(s=>this.pressKey(s,t))}setOctave(e){this.currentOctave=Math.max(0,Math.min(8,e))}getOctave(){return this.currentOctave}createMidiMessage(e,t,s){return new Uint8Array([e|(this.options.channel||0),t,s])}dispatchMidiEvent(e){const t={data:e,timeStamp:performance.now(),type:"midimessage"};this.listeners.forEach(s=>s(t))}}function ne(o="Virtual MIDI Keyboard"){const e=new ie,t={id:"virtual-midi-input",manufacturer:"Virtual",name:o,type:"input",version:"1.0.0",state:"connected",connection:"open",onmidimessage:null,onstatechange:null,addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e),dispatchEvent:()=>!1,open:()=>Promise.resolve(t),close:()=>Promise.resolve(t),_virtualInput:e};return Object.defineProperty(t,"onmidimessage",{get(){return this._onmidimessage},set(a){this._onmidimessage=a,a&&e.addEventListener("midimessage",a)}}),{inputs:new Map([["virtual-midi-input",t]]),outputs:new Map,sysexEnabled:!1,onstatechange:null,addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1,getVirtualInput:()=>e}}const x={z:0,x:2,c:4,v:5,b:7,n:9,m:11,",":12,".":14,"/":16,s:1,d:3,g:6,h:8,j:10,l:13,";":15,"'":17,q:12,w:14,e:16,r:17,t:19,y:21,u:23,i:24,o:26,p:28,"[":29,"]":31,2:1,3:3,5:6,6:8,7:10,9:13,0:15,"=":20};function N(o){const e={},t=o*12+12;for(const[s,n]of Object.entries(x)){const i=t+n;i>=24&&i<=127&&(e[s]=i)}return e}function _(o,e=!1){const t=new Set;function s(i){if(!e)return;const a=i.key.toLowerCase();console.debug("Key pressed:",a);const r=N(o.getOctave());if(r[a]&&!t.has(a)){t.add(a);const l=r[a];console.debug(`Pressing MIDI note ${l} for key '${a}' (octave ${o.getOctave()})`),o.pressKey(l),i.preventDefault()}}function n(i){if(!e)return;const a=i.key.toLowerCase(),r=N(o.getOctave());if(r[a]&&t.has(a)){t.delete(a);const l=r[a];console.debug(`Releasing MIDI note ${l} for key '${a}' (octave ${o.getOctave()})`),o.releaseKey(l),i.preventDefault()}}return e?console.debug("Virtual keyboard input setup complete. Available keys:",Object.keys(x),"Base octave:",o.getOctave()):console.debug("Virtual keyboard input setup (keyboard disabled)"),document.addEventListener("keydown",s),document.addEventListener("keyup",n),()=>{console.debug("Virtual keyboard input cleanup"),document.removeEventListener("keydown",s),document.removeEventListener("keyup",n)}}class h{static instance;basicPitch=null;audioContext=null;isRecording=!1;listeners=[];constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async start(){if(!this.isRecording)try{if(!this.basicPitch){const{BasicPitch:e}=await ee(async()=>{const{BasicPitch:t}=await import("./CAYENW2a.js");return{BasicPitch:t}},[],import.meta.url);this.basicPitch=new e("https://unpkg.com/@spotify/basic-pitch@1.0.1/model/model.json")}this.audioContext=new AudioContext,await this.audioContext.resume(),this.isRecording=!0,console.warn("Real-time audio processing with BasicPitch is pending implementation.")}catch(e){throw console.error("Error starting audio input:",e),e}}stop(){this.isRecording&&(this.isRecording=!1,this.audioContext&&(this.audioContext.close(),this.audioContext=null))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}notifyListeners(e,t,s){const n=s?144:128,i=new Uint8Array([n,e,t]),a=new MIDIMessageEvent("midimessage",{data:i});this.listeners.forEach(r=>r(a))}}const b=h.getInstance();class ae{midiAccess=null;virtualMidi=null;keyboardCleanup=null;eventHandlers={};errorCallbacks=[];debugMode=!1;audioInputEnabled=!1;constructor(){}async initialize(){try{return await this.connectMIDI(),this.setupAudioInput(),!0}catch(e){return this.handleError(e),!1}}async connectMIDI(){try{if(this.midiAccess=await this.safeRequestMidiAccess({sysex:!1}),!this.midiAccess)throw new Error("Failed to obtain MIDI access");return this.safeSetupMidiCallback(this.midiAccess,this.handleMIDIMessage.bind(this),this.handleError.bind(this)),console.debug("MIDI Manager: Connected to physical MIDI devices"),!0}catch(e){return this.handleError(e),!1}}async safeRequestMidiAccess(e){try{if(!navigator.requestMIDIAccess)return console.warn("Web MIDI API not supported in this browser"),null;const t=await navigator.requestMIDIAccess(e||{sysex:!1});return console.debug("MIDI Access obtained successfully"),t}catch(t){return console.error("Failed to obtain MIDI access:",t),null}}safeSetupMidiCallback(e,t,s){try{e.inputs.forEach(n=>{const i=`Input port [type:'${n.type}'] id:'${n.id}' manufacturer:'${n.manufacturer}' name:'${n.name}' version:'${n.version}'`;console.debug(`Setting up MIDI input: ${i}`),n.onmidimessage=a=>{try{t(a)}catch(r){console.error("Error in MIDI message callback:",r),s&&s(r)}}}),e.onstatechange=n=>{const i=n.port;console.debug(`MIDI port state changed: ${i.name} is now ${i.state}`)}}catch(n){console.error("Error setting up MIDI callback:",n),s&&s(n)}}setupVirtualKeyboard(){try{const e=ne("Virtual Debug Keyboard");this.virtualMidi=e.getVirtualInput(),this.keyboardCleanup=_(this.virtualMidi,this.debugMode);const t=Array.from(e.inputs.values())[0];t&&(t.onmidimessage=this.handleMIDIMessage.bind(this)),console.debug("MIDI Manager: Virtual keyboard enabled")}catch(e){this.handleError(e)}}setDebugMode(e){this.debugMode=e,this.virtualMidi&&(this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.keyboardCleanup=_(this.virtualMidi,this.debugMode),console.debug(`MIDI Manager: Debug mode ${e?"enabled":"disabled"}`))}setupAudioInput(){b.addListener(e=>{this.audioInputEnabled&&this.handleMIDIMessage(e)})}async setAudioInput(e){this.audioInputEnabled=e,e?(await b.start(),console.debug("MIDI Manager: Audio input enabled")):(b.stop(),console.debug("MIDI Manager: Audio input disabled"))}getVirtualMidi(){return this.virtualMidi}safeGetMidiNote(e){try{if(!e.data||e.data.length<3)return console.warn("Invalid MIDI message data"),null;const[t,s,n]=e.data,i=t&240,a=t&15;if(i!==144&&i!==128)return null;if(s<24||s>127)return console.warn(`MIDI note ${s} out of valid range (24-127)`),null;const r=s,l=Z[r];if(!l)return console.error(`No note name found for MIDI note ${r}`),null;const v=i===144&&n>0;return{noteNumber:r,type:v?"on":"off",noteFullName:l,noteName:l.slice(0,-1),velocity:n||0,timestamp:e.timeStamp||performance.now(),channel:a}}catch(t){return console.error("Error parsing MIDI message:",t),null}}handleMIDIMessage(e){try{const t=this.safeGetMidiNote(e);if(!t)return;t.type==="on"&&this.eventHandlers.onNoteOn?this.eventHandlers.onNoteOn(t):t.type==="off"&&this.eventHandlers.onNoteOff&&this.eventHandlers.onNoteOff(t)}catch(t){this.handleError(t)}}setEventHandlers(e){this.eventHandlers={...this.eventHandlers,...e}}handleError(e){console.error("MIDI Manager Error:",e),this.errorCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in error callback:",s)}}),this.eventHandlers.onError&&this.eventHandlers.onError(e)}getMIDIDevices(){return this.midiAccess?{inputs:Array.from(this.midiAccess.inputs.values()),outputs:Array.from(this.midiAccess.outputs.values())}:{inputs:[],outputs:[]}}cleanup(){this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.virtualMidi&&(this.virtualMidi.releaseAllKeys(),this.virtualMidi=null),this.midiAccess&&(this.midiAccess.inputs.forEach(e=>{e.onmidimessage=null}),this.midiAccess.onstatechange=null),this.eventHandlers={},this.errorCallbacks=[],console.debug("MIDI Manager: Cleaned up all connections")}}const ye=new ae;export{ge as M,N as g,ye as m};
