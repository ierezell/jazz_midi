import{c as Ct,a as y,f as x}from"./Bdvgn338.js";import{o as Ze,a as qt}from"./BRJReVLM.js";import{e as Yt,h as Xt,f as Se,p as Ae,g as tt,k as t,U as F,c as r,s as l,r as s,t as H,a as Re,Z as w,X as S,_ as Jt,V as Je,W as Qt,Y as xt}from"./ZtE6Gyvq.js";import{d as at,s as E}from"./BnZ86L-c.js";import{I as Zt,s as $t,e as ye,i as Ne}from"./DfaP9-sJ.js";import{i as P}from"./CdTPX8-T.js";import{s as ea}from"./C1phzpXo.js";import{c as Me,j as Qe,e as ta,C as aa,h as jt,i as sa,s as ra,a as na}from"./PYtk8PMn.js";import{t as We,s as oa,f as $e,u as Mt}from"./BEryLFqn.js";import{l as ia,s as et,p as ee}from"./-nZJNBOr.js";import{g as la,m as Ce,M as ca}from"./D6-daQGu.js";import{D as st,M as me,N as rt,g as da,f as va,A as Be,b as ua,h as fa}from"./CXrKfc7O.js";import{p as St}from"./D_WhGCa7.js";import{g as ha}from"./DwjNEjjL.js";import{j as ma}from"./BFE3C_Rr.js";import{_ as ga}from"./PPVm8Dsz.js";import{S as _a}from"./CSQp164W.js";import"./BUbxQ3bP.js";import{A as ba}from"./DA4VUxDa.js";class nt{#e=new WeakMap;#t;#a;static entries=new WeakMap;constructor(e){this.#a=e}observe(e,n){var i=this.#e.get(e)||new Set;return i.add(n),this.#e.set(e,i),this.#s().observe(e,this.#a),()=>{var c=this.#e.get(e);c.delete(n),c.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#s(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var n of e){nt.entries.set(n.target,n);for(var i of this.#e.get(n.target)||[])i(n)}}))}}var pa=new nt({box:"border-box"});function Et(a,e,n){var i=pa.observe(a,()=>n(a[e]));Yt(()=>(Xt(()=>n(a[e])),i))}function wa(a,e){const n=ia(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];Zt(a,et({name:"rotate-ccw"},()=>n,{get iconNode(){return i},children:(c,u)=>{var M=Ct(),C=Se(M);$t(C,e,"default",{}),y(c,M)},$$slots:{default:!0}}))}const ya=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[0]+12,fifth:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[0],third:a[1],fifth:a[2],inversion:0,chordType:n}}},Na=(a,e,n)=>{switch(e){case 0:return{root:a[0],third:a[1],fifth:a[2],seventh:a[3],inversion:0,chordType:n};case 1:return{root:a[1],third:a[2],fifth:a[3],seventh:a[0]+12,inversion:1,chordType:n};case 2:return{root:a[2],third:a[3],fifth:a[0]+12,seventh:a[1]+12,inversion:2,chordType:n};case 3:return{root:a[3],third:a[0]+12,fifth:a[1]+12,seventh:a[2]+12,inversion:3,chordType:n}}},Tt=(a,e,n=0)=>{const i=a+2,c=a+3,u=a+4,M=a+5,C=a+6,b=a+7,K=a+8,m=a+9,p=a+10,f=a+11;let N=[];switch(e){case"major":{N=[a,u,b];break}case"minor":{N=[a,c,b];break}case"maj7":{N=[a,u,b,f];break}case"min7":{N=[a,c,b,p];break}case"7":case"dom7":{N=[a,u,b,p];break}case"diminished":{N=[a,c,C];break}case"augmented":{N=[a,u,K];break}case"sus2":{N=[a,i,b];break}case"sus4":{N=[a,M,b];break}case"dim7":{N=[a,c,C,m];break}case"half-dim7":{N=[a,c,C,p];break}default:N=[a]}if(N.length===3){if(n===3)throw new Error(`Triad ${e} chords do not have a 3rd inversion`);return ya(N,n,e)}else return Na(N,n,e)};function ka(a,e){const n=[a.root,a.third,a.fifth,a.seventh].filter(c=>c!==void 0),i=a.root+14;switch(e){case"full-right":return n;case"full-left":return n.map(c=>c-12).filter(c=>c>=24);case"1735":return[a.root-12,(a.seventh||a.root)-12,a.third,a.fifth].filter(c=>c!==void 0&&c>=24);case"1537":return[a.root-12,a.fifth-12,a.third,a.seventh||a.root].filter(c=>c!==void 0&&c>=24);case"rootless-a":return[a.third,a.fifth,a.seventh,i].filter(c=>c!==void 0);case"rootless-b":return[a.seventh,i,a.third+12,a.fifth+12].filter(c=>c!==void 0);default:return n}}function xa(a,e){const n=ka(a,e);switch(e){case"full-right":return{leftHand:[],rightHand:[n.map(i=>me[i])]};case"full-left":return{leftHand:[n.map(i=>me[i])],rightHand:[]};case"1735":case"1537":{const i=n.slice(0,2),c=n.slice(2);return{leftHand:[i.map(u=>me[u])],rightHand:[c.map(u=>me[u])]}}case"rootless-a":case"rootless-b":return{leftHand:[],rightHand:[n.map(i=>me[i])]};default:return{leftHand:[],rightHand:[n.map(i=>me[i])]}}}function js(a,e,n,i){const c=a+st,u=rt[c],M=Tt(u,e,n);return xa(M,i)}function Ma(a,e=2,n=7){if(a.length===0)return{middleC:da,octaves:e};const i=Math.min(...a),c=Math.max(...a),u=c-i,M=Math.ceil(u/12)+1,C=Math.max(e,Math.min(n,M)),K=(i+c)/2-C*12/2,p=Math.floor(K/12)*12+Math.floor(C/2)*12;return{middleC:Math.max(24,p),octaves:C}}function Sa(a,e){switch((a%12-e%12+12)%12){case 0:return"root";case 4:return"third";case 7:return"fifth";case 11:return"seventh";case 2:return"ninth";case 5:return"eleventh";case 9:return"thirteenth";default:return"unknown"}}function Ts(a,e,n=st){const i=a+n,c=rt[i],u=va[e];return c+u}class Ea{audioElements=new Map;enabled=!0;unlocked=!1;volume=.7;constructor(){this.preloadSounds()}async preloadSounds(){try{await this.loadSound("success","/src/lib/sounds/ok.mp3"),await this.loadSound("error","/src/lib/sounds/error.mp3")}catch(e){console.warn("Failed to preload some audio files:",e)}}async loadSound(e,n){return new Promise((i,c)=>{if(typeof Audio>"u"){i();return}const u=new Audio;u.addEventListener("canplaythrough",()=>{this.audioElements.set(e,u),i()}),u.addEventListener("error",M=>{console.warn(`Failed to load sound "${e}" from ${n}:`,M),c(M)}),u.preload="auto",u.volume=this.volume,u.src=n})}async playSound(e,n){if(!this.enabled)return;if(!this.unlocked){console.warn("Audio playback blocked: user gesture required to enable sound. Call audioManager.unlock() from a user interaction.");return}const i=this.audioElements.get(e);if(!i){console.warn(`Sound "${e}" not found`);return}try{i.currentTime=0,n!==void 0?i.volume=Math.max(0,Math.min(1,n)):i.volume=this.volume,await i.play()}catch(c){console.warn(`Failed to play sound "${e}":`,c)}}async playSuccess(){await this.playSound("success",.8)}async playError(){await this.playSound("error",.6)}async unlock(){if(this.unlocked)return!0;try{const e=this.audioElements.get("success")??Array.from(this.audioElements.values())[0];if(!e)return this.unlocked=!0,!0;const n=e.volume;return e.volume=0,await e.play(),e.pause(),e.currentTime=0,e.volume=n,this.unlocked=!0,this.enabled=!0,console.debug("AudioManager: audio unlocked by user gesture"),!0}catch(e){return console.warn("AudioManager: unlock failed (user gesture required):",e),this.enabled=!1,this.unlocked=!1,!1}}needsUserGesture(){return!this.unlocked}}const Te=new Ea;var Ca=x("<option> </option>"),ja=x("<option> </option>"),Ta=x("<option> </option>"),Aa=x('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Virtual MIDI Controls</h4> <div class="control-group svelte-pmsc4d"><label class="svelte-pmsc4d">Root Note: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Keyboard Octave: <select class="svelte-pmsc4d"></select></label> <label class="svelte-pmsc4d">Chord Type: <select class="svelte-pmsc4d"></select></label></div></div> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Quick Actions</h4> <div class="button-group svelte-pmsc4d"><button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn stop svelte-pmsc4d">Stop All Notes</button> <button class="action-btn svelte-pmsc4d"> </button> <button class="action-btn svelte-pmsc4d">Random Note</button></div></div>',1),Ra=x('<div class="svelte-pmsc4d"> </div>'),Oa=x('<div class="svelte-pmsc4d"> </div>'),Ha=x('<div class="svelte-pmsc4d"> </div>'),Ia=x('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Exercise Status</h4> <div class="status-info svelte-pmsc4d"><!> <!> <!></div></div>'),Da=x('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Fa=x('<kbd class="svelte-pmsc4d"> </kbd> <span> </span>',1),Ka=x('<div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d"> </h4> <div class="shortcuts svelte-pmsc4d"><div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">White Keys:</strong><br/> <!></div> <div class="shortcut-row svelte-pmsc4d"><strong class="svelte-pmsc4d">Black Keys:</strong><br/> <!></div></div></div>'),La=x('<div class="debug-content svelte-pmsc4d"><!> <!> <!> <div class="section svelte-pmsc4d"><h4 class="svelte-pmsc4d">Status</h4> <div class="status svelte-pmsc4d"><p class="svelte-pmsc4d">Active Notes: <span class="count svelte-pmsc4d"> </span></p> <p class="svelte-pmsc4d">Virtual MIDI: <span class="status-good svelte-pmsc4d"> </span></p></div></div></div>'),Pa=x('<div><div class="debug-header svelte-pmsc4d"><h3 class="svelte-pmsc4d">ðŸŽ¹ Debug Panel</h3> <button class="toggle-btn svelte-pmsc4d"> </button></div> <!></div>');function Va(a,e){Ae(e,!0);let n=ee(e,"debugMode",3,!0),i=ee(e,"noteEvents",19,()=>[]),c=ee(e,"expectedNotes",19,()=>[]),u=ee(e,"currentNotes",19,()=>[]),M=S(()=>c().map(k=>me[k])),C=S(()=>u().map(k=>me[k])),b=F("C"),K=F("maj7"),m=F(4),p=S(()=>{const k=la(t(m),t(b)),j=z=>z.map(I=>({key:I.toUpperCase(),note:me[k[I.toLowerCase()]]})).filter(I=>I.note);return{white:j(["z","x","c","v","b","n","m"]),black:j(["s","d","g","h","j"])}});tt(()=>{e.virtualMidi&&(e.virtualMidi.setOctave(t(m)),e.virtualMidi.setRootNote(t(b)))});function f(){if(!e.virtualMidi)return;const k=t(m)*12+12,j=Be.indexOf(t(b));if(j===-1)return;const z=k+j,I=Tt(z,t(K)),T=[I.root,I.third,I.fifth,I.seventh].filter(W=>W!=null&&W!=null);e.virtualMidi.playChord(T)}function N(){e.virtualMidi&&e.virtualMidi.releaseAllKeys()}let _=[];function g(){if(!e.virtualMidi)return;_.forEach(T=>clearTimeout(T)),_=[];const k=t(m)*12+12,j=Be.indexOf(t(b));if(j===-1)return;const z=k+j;[0,2,4,5,7,9,11,12].map(T=>z+T).forEach((T,W)=>{const xe=setTimeout(()=>{e.virtualMidi.pressKey(T),setTimeout(()=>e.virtualMidi.releaseKey(T),300)},W*400);_.push(xe)})}function h(){if(!e.virtualMidi)return;const k=72+Math.floor(Math.random()*24);e.virtualMidi.pressKey(k),setTimeout(()=>e.virtualMidi.releaseKey(k),500)}var A=Pa();let X;var te=r(A),B=l(r(te),2);B.__click=function(...k){e.onToggleDebugMode?.apply(this,k)};var se=r(B);s(B),s(te);var J=l(te,2);{var ke=k=>{var j=La(),z=r(j);{var I=G=>{var re=Aa(),ne=Se(re),fe=l(r(ne),2),Q=r(fe),V=l(r(Q));ye(V,21,()=>Be,Ne,(ae,$)=>{var L=Ca(),pe=r(L,!0);s(L);var ve={};H(()=>{E(pe,t($)),ve!==(ve=t($))&&(L.value=(L.__value=t($))??"")}),y(ae,L)}),s(V),s(Q);var ie=l(Q,2),le=l(r(ie));ye(le,20,()=>[2,3,4,5,6],Ne,(ae,$)=>{var L=ja(),pe=r(L,!0);s(L);var ve={};H(()=>{E(pe,$),ve!==(ve=$)&&(L.value=(L.__value=$)??"")}),y(ae,L)}),s(le),s(ie);var _e=l(ie,2),R=l(r(_e));ye(R,21,()=>ua,Ne,(ae,$)=>{var L=Ta(),pe=r(L,!0);s(L);var ve={};H(()=>{E(pe,t($)),ve!==(ve=t($))&&(L.value=(L.__value=t($))??"")}),y(ae,L)}),s(R),s(_e),s(fe),s(ne);var D=l(ne,2),q=l(r(D),2),Y=r(q);Y.__click=f;var ce=r(Y);s(Y);var Z=l(Y,2);Z.__click=N;var oe=l(Z,2);oe.__click=g;var de=r(oe);s(oe);var be=l(oe,2);be.__click=h,s(q),s(D),H(()=>{E(ce,`Play ${t(b)??""}${t(K)??""}`),E(de,`Play ${t(b)??""} Scale`)}),Qe(V,()=>t(b),ae=>w(b,ae)),Qe(le,()=>t(m),ae=>w(m,ae)),Qe(R,()=>t(K),ae=>w(K,ae)),y(G,re)};P(z,G=>{e.virtualMidi&&G(I)})}var T=l(z,2);{var W=G=>{var re=Ia(),ne=l(r(re),2),fe=r(ne);{var Q=R=>{var D=Ra(),q=r(D);s(D),H(Y=>E(q,`Expected Notes: ${Y??""}`),[()=>t(M).join(", ")]),y(R,D)};P(fe,R=>{c().length>0&&R(Q)})}var V=l(fe,2);{var ie=R=>{var D=Oa(),q=r(D);s(D),H(Y=>E(q,`Current Notes: ${Y??""}`),[()=>t(C).join(", ")]),y(R,D)};P(V,R=>{u().length>0&&R(ie)})}var le=l(V,2);{var _e=R=>{var D=Ha(),q=r(D);s(D),H(()=>E(q,`Recent Events: ${i().length??""}`)),y(R,D)};P(le,R=>{i().length>0&&R(_e)})}s(ne),s(re),y(G,re)};P(T,G=>{(c().length>0||u().length>0)&&G(W)})}var xe=l(T,2);{var Oe=G=>{var re=Ka(),ne=r(re),fe=r(ne);s(ne);var Q=l(ne,2),V=r(Q),ie=l(r(V),3);ye(ie,17,()=>t(p).white,Ne,(R,D)=>{let q=()=>t(D).key,Y=()=>t(D).note;var ce=Da(),Z=Se(ce),oe=r(Z,!0);s(Z);var de=l(Z,2),be=r(de,!0);s(de),H(()=>{E(oe,q()),E(be,Y())}),y(R,ce)}),s(V);var le=l(V,2),_e=l(r(le),3);ye(_e,17,()=>t(p).black,Ne,(R,D)=>{let q=()=>t(D).key,Y=()=>t(D).note;var ce=Fa(),Z=Se(ce),oe=r(Z,!0);s(Z);var de=l(Z,2),be=r(de,!0);s(de),H(()=>{E(oe,q()),E(be,Y())}),y(R,ce)}),s(le),s(Q),s(re),H(()=>E(fe,`Keyboard Shortcuts (Octave ${t(m)??""})`)),y(G,re)};P(xe,G=>{e.virtualMidi&&G(Oe)})}var He=l(xe,2),ge=l(r(He),2),U=r(ge),Ie=l(r(U)),ze=r(Ie,!0);s(Ie),s(U);var De=l(U,2),je=l(r(De)),Fe=r(je,!0);s(je),s(De),s(ge),s(He),s(j),H(G=>{E(ze,G),E(Fe,e.virtualMidi?"Connected":"Disconnected")},[()=>e.virtualMidi?e.virtualMidi.getActiveNotes().length:0]),y(k,j)};P(J,k=>{n()&&k(ke)})}s(A),H(()=>{X=Me(A,1,"debug-panel svelte-pmsc4d",null,X,{visible:n()}),E(se,`${n()?"Hide":"Show"} Debug`)}),y(a,A),Re()}at(["click"]);var Ba=x('<div><div class="note-role-dot svelte-ouqkuv"></div></div>'),Wa=x("<div><!></div>");function za(a,e){Ae(e,!0);let n=ee(e,"interactive",3,!1),i=ee(e,"noteRoleColor",3,"transparent"),c=ee(e,"isWrongNote",3,!1),u=![1,3,6,8,10].includes(e.noteNum%12),M=F(0);u||([1,6].includes(e.noteNum%12)?w(M,-e.keyWidth/12):[3,10].includes(e.noteNum%12)&&w(M,e.keyWidth/12));function C(){n()&&e.onclick&&e.onclick()}function b(g){n()&&e.onmousedown&&(e.onmousedown(),g.preventDefault())}function K(g){n()&&e.onmouseup&&(e.onmouseup(),g.preventDefault())}function m(g){n()&&e.onmousedown&&(e.onmousedown(),g.preventDefault())}function p(g){n()&&e.onmouseup&&(e.onmouseup(),g.preventDefault())}var f=Wa();ta(f,()=>({style:`--width: ${e.keyWidth-e.keyWidth*.47*(u?0:1)}px; --height: ${e.keyHeight??""}px; --note-role-color: ${i()??""}; transform: translate(${t(M)??""}px);`,draggable:"false",onclick:C,onmousedown:b,onmouseup:K,ontouchstart:m,ontouchend:p,role:n()?"button":void 0,...n()?{tabindex:0}:{},[aa]:{accidental:!u,natural:u,pressed:e.pressed,interactive:n(),"wrong-note":c()}}),void 0,void 0,void 0,"svelte-ouqkuv");var N=r(f);{var _=g=>{var h=Ba();let A;H(()=>A=Me(h,1,"note-role-indicator svelte-ouqkuv",null,A,{"natural-indicator":u,"accidental-indicator":!u})),y(g,h)};P(N,g=>{i()&&g(_)})}s(f),y(a,f),Re()}var Ua=x('<div class="keyboard svelte-1dlz8xf"></div>');function Ga(a,e){Ae(e,!0);let n=ee(e,"expectedNotes",19,()=>[]),i=ee(e,"showExpected",3,!1),c=F(10),u=F(10),M=S(()=>Math.max(1,Math.min(10,e.octaves||2))),C=S(()=>Math.max(24,Math.min(108,e.middleC||60))),b=S(()=>[...Array(t(M)*12+1).keys()].map(p=>p+(t(C)-Math.floor(t(M)/2)*12))),K=S(()=>t(b).filter(p=>![1,3,6,8,10].includes(p%12)).length);var m=Ua();ye(m,21,()=>t(b),Ne,(p,f)=>{const N=S(()=>i()&&n().includes(t(f))?"#2ecc71":fa[e.noteRoles[t(f)]]),_=S(()=>e.midiNotes.includes(t(f))),g=S(()=>t(_)&&n().length>0&&!n().includes(t(f)));{let h=S(()=>t(c)/t(K));za(p,{get noteNum(){return t(f)},get pressed(){return t(_)},get keyWidth(){return t(h)},get keyHeight(){return t(u)},get noteRoleColor(){return t(N)},get isWrongNote(){return t(g)}})}}),s(m),Et(m,"clientWidth",p=>w(c,p)),Et(m,"clientHeight",p=>w(u,p)),y(a,m),Re()}var qa=x('<div id="score-container" class="svelte-25wfcq"><canvas id="output" class="svelte-25wfcq"></canvas></div>');function Ya(a,e){Ae(e,!0);let n=null,i=F(!1);Ze(async()=>{n=await ga(()=>import("./wr6S8XWn.js"),[],import.meta.url),w(i,!0)});const c=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]),u={"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","E#":"F","B#":"C"};function M(_){return _.includes("b")?!0:c.has(_)}function C(_){return{"A#":"Bb","C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab"}[_]||_}function b(_){const g=/(.*?)(\d+)$/.exec(_);if(!g)return _;let h=g[1];const A=parseInt(g[2],10);return(h==="A#"||h==="D#"||h==="G#"||M(e.selectedNote)&&h.includes("#"))&&(h=u[h]??h),`${h}${A+1}`}const K=_=>_?.map(g=>g.length>1?`(${g.map(h=>b(h)).join(" ")})`:b(g[0])).join(", ")||"";let m=S(()=>K(e.rightHand)),p=S(()=>K(e.leftHand));function f(_){if(!n||!t(i))return;const{Factory:g,Renderer:h,Voice:A}=n,X=_<768,te=_<480,B=_<360;let se;B?se=200:te?se=240:X?se=280:se=340;const J=document.getElementById("output");if(!J)return;const ke=J.getContext("2d");if(!ke)return;ke.clearRect(0,0,J.width,J.height);const k=new g({renderer:{elementId:"output",backend:h.Backends.CANVAS,width:Math.max(300,_),height:Math.max(200,se)}}),j=k.EasyScore({throwOnError:!1}),z=X?10:20,I=k.System({width:Math.max(300,_),spaceBetweenStaves:z,noPadding:X,noJustification:X,formatOptions:{alignRests:!0,autoBeam:!0}});if((!e.rightHand||e.rightHand.length===0)&&(!e.leftHand||e.leftHand.length===0)){console.debug("No notes to render, rendering test chord");const T=`${b("C3")}, ${b("E3")}, ${b("G3")}`;try{const W=I.addStave({voices:[j.voice(j.notes(T,{clef:"treble",stem:"up"})).setMode(A.Mode.SOFT)]});W.addClef("treble"),e.selectedNote&&W.addKeySignature(C(e.selectedNote)),k.draw()}catch(W){console.error("Error rendering test chord:",W)}return}console.debug("Rendering score with notes:",{stringLeftHand:t(p),stringRightHand:t(m)}),console.debug("Selected note for key signature:",e.selectedNote);try{if(e.rightHand&&e.rightHand.length>0&&t(m)){const T=I.addStave({voices:[j.voice(j.notes(t(m),{clef:"treble",stem:"up"})).setMode(A.Mode.SOFT)]});T.addClef("treble"),e.selectedNote&&T.addKeySignature(C(e.selectedNote))}if(e.leftHand&&e.leftHand.length>0&&t(p)){const T=I.addStave({voices:[j.voice(j.notes(t(p),{clef:"bass",stem:"down"})).setMode(A.Mode.SOFT)]});T.addClef("bass"),e.selectedNote&&T.addKeySignature(C(e.selectedNote))}e.rightHand&&e.rightHand.length>0&&e.leftHand&&e.leftHand.length>0&&(I.addConnector("brace"),I.addConnector("single")),k.draw()}catch(T){console.error("Error rendering VexFlow score:",T)}}tt(()=>{t(i)&&(console.debug("Score $effect triggered with props:",{leftHand:e.leftHand,rightHand:e.rightHand,selectedNote:e.selectedNote}),setTimeout(()=>{const _=document.getElementById("score-container");if(_){const g=_.getBoundingClientRect().width;g>0&&f(g)}},100))}),Ze(()=>{const _=()=>{const g=document.getElementById("score-container");if(g){const h=g.getBoundingClientRect().width;console.debug(`Container width: ${h}`),h>0&&f(h)}};return window.addEventListener("resize",_),()=>{window.removeEventListener("resize",_)}});var N=qa();y(a,N),Re()}var Xa=x('<div class="star-wrapper svelte-h6yjv8"><!></div>'),Ja=x('<div class="modal-overlay svelte-h6yjv8"><div class="modal-content svelte-h6yjv8"><div class="modal-header"><h2 class="svelte-h6yjv8">Lesson Complete!</h2> <div class="stars-container svelte-h6yjv8"></div></div> <div class="stats-grid svelte-h6yjv8"><div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">Accuracy</span> <span class="stat-value svelte-h6yjv8"> </span></div> <div class="stat-item svelte-h6yjv8"><span class="stat-label svelte-h6yjv8">XP Gained</span> <span class="stat-value svelte-h6yjv8"> </span></div></div> <div class="modal-actions svelte-h6yjv8"><button class="retry-btn svelte-h6yjv8"><!> Retry</button> <button class="continue-btn svelte-h6yjv8">Continue <!></button></div></div></div>');function Qa(a,e){var n=Ct(),i=Se(n);{var c=u=>{var M=Ja(),C=r(M),b=r(C),K=l(r(b),2);ye(K,20,()=>Array(3),Ne,(J,ke,k)=>{var j=Xa();jt(j,`animation-delay: ${k*200}ms`);var z=r(j);{let I=S(()=>k<e.stars?"star-filled":"star-empty"),T=S(()=>k<e.stars?"#ffd700":"none"),W=S(()=>k<e.stars?"#ffd700":"currentColor");_a(z,{size:48,get class(){return t(I)},get fill(){return t(T)},get stroke(){return t(W)}})}s(j),y(J,j)}),s(K),s(b);var m=l(b,2),p=r(m),f=l(r(p),2),N=r(f);s(f),s(p);var _=l(p,2),g=l(r(_),2),h=r(g);s(g),s(_),s(m);var A=l(m,2),X=r(A);X.__click=function(...J){e.onRetry?.apply(this,J)};var te=r(X);wa(te,{size:20}),Jt(),s(X);var B=l(X,2);B.__click=function(...J){e.onContinue?.apply(this,J)};var se=l(r(B));ba(se,{size:20}),s(B),s(A),s(C),s(M),H(()=>{E(N,`${e.accuracy??""}%`),E(h,`+${e.xp??""}`)}),We(3,C,()=>oa),We(3,M,()=>$e),y(u,M)};P(i,u=>{e.isOpen&&u(c)})}y(a,n)}at(["click"]);var Za=x("<option> </option>"),$a=x('<div class="control-group svelte-w7gj7d"><label for="note-select" class="svelte-w7gj7d">Root Key</label> <select id="note-select" class="svelte-w7gj7d"></select></div>'),es=x('<div class="control-group svelte-w7gj7d"><!></div>'),ts=x('<div class="control-group svelte-w7gj7d"><label for="tempo-toggle" class="svelte-w7gj7d">Tempo Mode</label> <button id="tempo-toggle"> </button></div> <!>',1),as=x('<div class="control-group svelte-w7gj7d"><label for="training-mode-toggle" class="svelte-w7gj7d">Training Mode</label> <button id="training-mode-toggle" title="If enabled, mistakes will stop the lesson until you correct it"> </button></div>'),ss=x('<div class="exercise-description svelte-w7gj7d"><span class="info-icon svelte-w7gj7d">? <span class="desc-tooltip svelte-w7gj7d"> </span></span></div>'),rs=x('<div class="feedback-toast svelte-w7gj7d"> </div>'),ns=x('<div class="prompt-card card-premium svelte-w7gj7d"><div class="prompt-text svelte-w7gj7d"> </div></div>'),os=x('<div class="score-container card-premium svelte-w7gj7d"><!></div>'),is=x('<div class="adaptive-help-text"> </div>'),ls=x('<div class="debug-panel-wrapper"><!></div>'),cs=x('<div class="exercise-layout"><aside class="sidebar glass svelte-w7gj7d"><div class="sidebar-header svelte-w7gj7d"><h3 class="svelte-w7gj7d">Exercise Controls</h3></div> <div class="sidebar-content"><!> <!> <!> <div class="control-group svelte-w7gj7d"><label for="debug-toggle" class="svelte-w7gj7d">Virtual Keyboard</label> <button id="debug-toggle"> </button></div> <div class="sidebar-spacer"></div> <button class="reset-btn svelte-w7gj7d">Reset Session</button></div></aside> <main class="exercise-main svelte-w7gj7d"><header class="exercise-header svelte-w7gj7d"><div class="info-group svelte-w7gj7d"><!> <h1 class="svelte-w7gj7d"> </h1></div> <div class="performance-strip svelte-w7gj7d"><div><span class="label">Mistakes:</span> <span class="value"> </span></div> <div class="stat-pill success svelte-w7gj7d"><span class="label">Progress:</span> <span class="value"> </span></div></div></header> <!> <div class="focus-area svelte-w7gj7d"><!> <!> <!> <div><!></div> <div class="exercise-custom-content"><!></div></div> <!> <footer class="exercise-footer svelte-w7gj7d"><div class="progress-track svelte-w7gj7d"><div class="progress-fill svelte-w7gj7d"></div></div></footer></main></div> <!>',1);function As(a,e){Ae(e,!0);let n=ee(e,"randomMode",3,!1),i=ee(e,"exerciseType",3,"chord"),c=ee(e,"progressiveHints",3,!0),u=ee(e,"showTempoControl",3,!0),M=ee(e,"showTrainingControl",3,!0);const C=1,b=3,K=3;let m=F(Je(e.initialNote??"C"));tt(()=>{e.initialNote!==void 0&&e.initialNote!==t(m)&&(w(m,e.initialNote,!0),Q())});let p=F(Je([])),f=F(0),N=F(Je(new Set)),_=F(0),g=F(!1),h=F(!1),A=F(""),X=!1,te=F(!1),B=F(!1),se=F(0),J=120;const ke=150;let k=S(()=>e.showScore===!1?!1:i()==="partition"?!0:c()?t(f)>=C:e.showScore??!0);const j=S(()=>St.url.searchParams.get("unitId")),z=S(()=>St.url.searchParams.get("lessonId")),I=S(()=>!!t(j)&&!!t(z));let T=F(!1),W=F(0),xe=F(0),Oe=F(0),He=S(()=>t(f)>=K),ge=S(()=>t(p).map(o=>o.noteNumber)),U=S(()=>e.generateExpectedNotes(t(m))),Ie=S(()=>e.generateScoreProps(t(m))),ze=S(()=>t(h)||c()&&t(f)>=b),De=S(()=>({...Ma(t(U)),midiNotes:t(ge),debugMode:t(h),noteRoles:Object.fromEntries(t(U).map(o=>[o,Sa(o,rt[`${t(m)}${st}`])])),expectedNotes:t(U),showExpected:t(He)})),je=S(()=>{if(t(U).length===0)return 0;const o=[...new Set(t(U))];return Math.round(t(N).size/o.length*100)}),Fe=S(()=>{if(!c()||t(g)||i()==="partition")return"";if(t(f)<C){let o=`correct ${i()||"note"}`;if(e.prompt){const d=i()==="II-V-I"?"progression":i()==="note"?"note":i();o=`${e.prompt} ${d}`}return`Play the ${o}. After ${C-t(f)} more mistake${C-t(f)===1?"":"s"} the score will appear.`}return t(f)<b?`Reference keyboard will appear after ${b-t(f)} more mistake${b-t(f)===1?"":"s"}.`:"Adaptive help is active. Use the score and keyboard for reference."}),G=S(()=>({selectedNote:t(m),currentNotes:t(ge),expectedNotes:t(U),mistakes:t(f),completed:t(g),collectedNotes:t(N),debugMode:t(h),feedbackMessage:t(A),showNotesRoles:X,tempoMode:t(B),toggleDebug:R,showFeedback:V,toggleTempoMode:Y,handleTick:q,completeExercise:o=>ie(o)}));qt(()=>{Ce.cleanup()}),Ze(async()=>{await Ce.initialize(),Ce.setupVirtualKeyboard(),Ce.setEventHandlers({onNoteOn:re,onNoteOff:ne}),w(_,Date.now(),!0);const o=async()=>{if(Te.needsUserGesture()){const d=await Te.unlock();V(d?"Audio enabled":"Click or press any key to enable audio","info")}};window.addEventListener("pointerdown",o,{once:!0}),window.addEventListener("keydown",o,{once:!0})});function re(o){t(h)&&console.debug(`MIDI Note ON: ${o.noteNumber} (${o.noteFullName}) velocity=${o.velocity} channel=${o.channel}`);let d=!1;if(t(B)){const O=Date.now(),ue=60/J*1e3,we=O-t(se),he=ue-we;Math.min(we,he)>ke&&(V("Off beat! Try to play on the beat.","error"),xt(f),d=!0,Te.playError())}w(p,[...t(p),o],!0);const v=e.validateNoteEvent(t(m),o,t(U),t(ge));if(v.resetCollected&&w(N,new Set,!0),v.resetMistakes&&w(f,0),v.collected&&!d&&t(N).add(o.noteNumber),v.isCorrect)d||V(v.message,"success");else if(d||(xt(f),V(v.message,"error"),Te.playError()),t(te)){w(A,"error : Mistake! Take your time...");return}if(i()){const O=i()==="II-V-I"?"progression":i()==="note"||i()==="interval"?"chord":i();Mt.updateNoteProgress(o.noteName,O,void 0,v.isCorrect,0,v.isCorrect?100:0)}e.isCompleted(t(ge),t(U))&&ie()}function ne(o){t(h)&&console.debug(`MIDI Note OFF: ${o.noteNumber} (${o.noteFullName}) channel=${o.channel}`),w(p,t(p).filter(d=>d.noteNumber!==o.noteNumber),!0)}function fe(o){w(m,o,!0),Q()}function Q(){w(p,[],!0),w(f,0),w(g,!1),w(A,""),w(_,Date.now(),!0),w(m,t(m),!0),w(N,new Set,!0),e.onReset?.()}function V(o,d){w(A,`${d} : ${o}`),setTimeout(()=>{w(A,"")},5e3)}function ie(o){console.log("Exercise Completed!",{exerciseType:i(),mistakes:t(f),startTime:t(_)}),w(g,!0);const d=Date.now()-t(_),v=Math.round((t(U).length-t(f))/t(U).length*100);if(V(`Exercise completed! Time: ${d}ms, Accuracy: ${v}%`,"success"),Te.playSound?.("success"),i()){console.log("Recording stats...",{exerciseType:i(),success:!0,accuracy:v,timeElapsed:d});const O=i()==="II-V-I"?"progression":i()==="note"||i()==="interval"?"chord":i();Mt.recordExerciseResult({exerciseId:window.location.pathname,exerciseType:O,success:!0,accuracy:v,timeElapsed:d,mistakes:t(f),score:Math.max(0,100-t(f)*10),timestamp:new Date,...o})}else console.warn("No exerciseType provided, stats not recorded.");t(I)&&t(j)&&t(z)?(w(W,t(f)===0?3:t(f)<=2?2:1,!0),w(xe,v,!0),w(Oe,Math.max(0,100-t(f)*10),!0),ma.completeLesson(t(j),t(z),t(W)),w(T,!0)):(e.onComplete?.(),Q())}function le(){w(T,!1),ha(na("/journey"))}function _e(){w(T,!1),Q()}function R(){w(h,!t(h)),Ce.setDebugMode(t(h))}function D(o){const v=o.target.value;fe(v)}function q(o){w(se,o,!0)}function Y(){w(B,!t(B))}var ce=cs(),Z=Se(ce),oe=r(Z),de=l(r(oe),2),be=r(de);{var ae=o=>{var d=$a(),v=l(r(d),2);v.__change=D,ye(v,21,()=>Be,Ne,(ue,we)=>{var he=Za(),Ve=r(he,!0);s(he);var Ee={};H(()=>{E(Ve,t(we)),Ee!==(Ee=t(we))&&(he.value=(he.__value=t(we))??"")}),y(ue,he)}),s(v);var O;sa(v),s(d),H(()=>{O!==(O=t(m))&&(v.value=(v.__value=t(m))??"",ra(v,t(m)))}),y(o,d)};P(be,o=>{n()||o(ae)})}var $=l(be,2);{var L=o=>{var d=ts(),v=Se(d),O=l(r(v),2);let ue;O.__click=Y;var we=r(O,!0);s(O),s(v);var he=l(v,2);{var Ve=Ee=>{var Xe=es(),Gt=r(Xe);ca(Gt,{onTick:q}),s(Xe),y(Ee,Xe)};P(he,Ee=>{t(B)&&Ee(Ve)})}H(()=>{ue=Me(O,1,"toggle-btn svelte-w7gj7d",null,ue,{active:t(B)}),E(we,t(B)?"Enabled":"Disabled")}),y(o,d)};P($,o=>{u()&&o(L)})}var pe=l($,2);{var ve=o=>{var d=as(),v=l(r(d),2);v.__click=()=>w(te,!t(te));let O;var ue=r(v,!0);s(v),s(d),H(()=>{O=Me(v,1,"toggle-btn svelte-w7gj7d",null,O,{active:t(te)}),E(ue,t(te)?"Stop on Mistake":"Free Play")}),y(o,d)};P(pe,o=>{M()&&o(ve)})}var Ue=l(pe,2),Ke=l(r(Ue),2);Ke.__click=R;let ot;var At=r(Ke,!0);s(Ke),s(Ue);var Rt=l(Ue,4);Rt.__click=Q,s(de),s(oe);var it=l(oe,2),Ge=r(it),qe=r(Ge),lt=r(qe);{var Ot=o=>{var d=ss(),v=r(d),O=l(r(v)),ue=r(O,!0);s(O),s(v),s(d),H(()=>E(ue,e.description)),y(o,d)};P(lt,o=>{e.description&&o(Ot)})}var ct=l(lt,2),Ht=r(ct,!0);s(ct),s(qe);var dt=l(qe,2),Le=r(dt);let vt;var ut=l(r(Le),2),It=r(ut,!0);s(ut),s(Le);var ft=l(Le,2),ht=l(r(ft),2),Dt=r(ht);s(ht),s(ft),s(dt),s(Ge);var mt=l(Ge,2);{var Ft=o=>{var d=rs(),v=r(d,!0);s(d),H(()=>E(v,t(A))),We(3,d,()=>$e),y(o,d)};P(mt,o=>{t(A)&&o(Ft)})}var Ye=l(mt,2),gt=r(Ye);{var Kt=o=>{var d=ns(),v=r(d),O=r(v,!0);s(v),s(d),H(()=>E(O,e.prompt)),y(o,d)};P(gt,o=>{e.prompt&&!t(k)&&o(Kt)})}var _t=l(gt,2);{var Lt=o=>{var d=os(),v=r(d);Ya(v,et(()=>t(Ie))),s(d),We(1,d,()=>$e),y(o,d)};P(_t,o=>{t(k)&&o(Lt)})}var bt=l(_t,2);{var Pt=o=>{var d=is(),v=r(d,!0);s(d),H(()=>E(v,t(Fe))),y(o,d)};P(bt,o=>{t(Fe)&&o(Pt)})}var Pe=l(bt,2);let pt;var Vt=r(Pe);Ga(Vt,et(()=>t(De))),s(Pe);var wt=l(Pe,2),Bt=r(wt);ea(Bt,()=>e.children??Qt,()=>t(G)),s(wt),s(Ye);var yt=l(Ye,2);{var Wt=o=>{var d=ls(),v=r(d);{let O=S(()=>Ce.getVirtualMidi()??void 0);Va(v,{get noteEvents(){return t(p)},get expectedNotes(){return t(U)},get currentNotes(){return t(ge)},get debugMode(){return t(h)},onToggleDebugMode:R,get virtualMidi(){return t(O)}})}s(d),y(o,d)};P(yt,o=>{t(h)&&o(Wt)})}var Nt=l(yt,2),kt=r(Nt),zt=r(kt);s(kt),s(Nt),s(it),s(Z);var Ut=l(Z,2);Qa(Ut,{get isOpen(){return t(T)},get stars(){return t(W)},get accuracy(){return t(xe)},get xp(){return t(Oe)},onContinue:le,onRetry:_e}),H(o=>{ot=Me(Ke,1,"toggle-btn svelte-w7gj7d",null,ot,{active:t(h)}),E(At,t(h)?"Visible":"Hidden"),E(Ht,o),vt=Me(Le,1,"stat-pill svelte-w7gj7d",null,vt,{neutral:t(f)===0,warn:t(f)>0}),E(It,t(f)),E(Dt,`${t(je)??""}%`),pt=Me(Pe,1,"keyboard-container svelte-w7gj7d",null,pt,{hidden:!t(ze)}),jt(zt,`width: ${t(je)??""}%`)},[()=>i()?.toUpperCase()||"PRACTICE"]),y(a,ce),Re()}at(["change","click"]);export{As as B,Tt as a,ka as b,Ts as c,xa as d,js as g};
