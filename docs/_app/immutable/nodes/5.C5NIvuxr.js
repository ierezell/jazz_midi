var We=Object.defineProperty;var Be=(c,e,s)=>e in c?We(c,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[e]=s;var C=(c,e,s)=>Be(c,typeof e!="symbol"?e+"":e,s);import"../chunks/CWj6FrbW.js";import{d as Je,o as xe,a as Ge,s as v}from"../chunks/DMAeUSXr.js";import{p as Qe,q as Xe,v as Ye,f as L,s as o,d as n,k as t,t as M,b as w,c as Ze,x as p,w as et,r,y as tt}from"../chunks/tdu9TRks.js";import{i as st}from"../chunks/ByAurAgR.js";import{c as it,N as at,A as Me,e as Ce,i as ke,b as ot}from"../chunks/t8yZTVXO.js";import{i as E,b as rt,c as T,s as nt}from"../chunks/tx2ohI1j.js";import{B as lt,m as se,a as ie}from"../chunks/CgVM9aVJ.js";const j={midi:{autoConnect:!0,virtualKeyboard:{enabled:!0,layout:"piano",size:"normal"},latency:{compensation:0,monitoring:!1}},audio:{enabled:!0,volume:{master:.8,feedback:.6,metronome:.5},sounds:{success:"/sounds/ok.mp3",error:"/sounds/error.mp3",metronome:"/sounds/metronome.mp3"}},ui:{theme:"auto",layout:"comfortable",animations:!0,accessibility:{highContrast:!1,reducedMotion:!1,screenReader:!1},keyboard:{showLabels:!1,highlightPressed:!0,size:"medium",octaves:2,startOctave:4}},exercise:{errorThreshold:{showNoteNames:3,showKeyboard:6},autoProgress:!1,showHints:!0,defaultKey:"C",defaultTempo:120}};class ct{constructor(){C(this,"config");C(this,"storageKey","jazz-midi-config");C(this,"listeners",[]);this.config=this.loadConfig()}loadConfig(){try{if(typeof localStorage<"u"){const e=localStorage.getItem(this.storageKey);if(e){const s=JSON.parse(e);return this.mergeWithDefaults(s)}}}catch(e){console.warn("Failed to load config from localStorage:",e)}return{...j}}mergeWithDefaults(e){return{midi:{...j.midi,...e.midi},audio:{...j.audio,...e.audio},ui:{...j.ui,...e.ui},exercise:{...j.exercise,...e.exercise}}}saveConfig(){try{typeof localStorage<"u"&&localStorage.setItem(this.storageKey,JSON.stringify(this.config))}catch(e){console.warn("Failed to save config to localStorage:",e)}}getConfig(){return{...this.config}}getSection(e){return{...this.config[e]}}updateConfig(e){this.config={...this.config,...e},this.saveConfig(),this.notifyListeners()}updateSection(e,s){this.config[e]={...this.config[e],...s},this.saveConfig(),this.notifyListeners()}resetToDefaults(){this.config={...j},this.saveConfig(),this.notifyListeners()}resetSection(e){this.config[e]={...j[e]},this.saveConfig(),this.notifyListeners()}subscribe(e){return this.listeners.push(e),()=>{const s=this.listeners.indexOf(e);s>-1&&this.listeners.splice(s,1)}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.config)}catch(s){console.error("Error in config listener:",s)}})}exportConfig(){return JSON.stringify(this.config,null,2)}importConfig(e){try{const s=JSON.parse(e),a=this.mergeWithDefaults(s);return this.config=a,this.saveConfig(),this.notifyListeners(),!0}catch(s){return console.error("Failed to import config:",s),!1}}getSchema(){return{midi:{autoConnect:"boolean",virtualKeyboard:{enabled:"boolean",layout:["piano","chromatic","isomorphic"],size:["compact","normal","large"]},latency:{compensation:"number",monitoring:"boolean"}},audio:{enabled:"boolean",volume:{master:"number(0-1)",feedback:"number(0-1)",metronome:"number(0-1)"}},ui:{theme:["light","dark","auto"],layout:["compact","comfortable","spacious"],animations:"boolean"},exercise:{errorThreshold:{showNoteNames:"number",showKeyboard:"number"},autoProgress:"boolean",showHints:"boolean"}}}}const Se=new ct;class ut{constructor(e){C(this,"state");C(this,"listeners",[]);this.state={...e}}getState(){return{...this.state}}getStatus(){return this.state.status}isActive(){return this.state.status==="active"}isCompleted(){return this.state.status==="completed"||this.state.status==="failed"}updateState(e){this.state={...this.state,...e},this.notifyListeners()}updateSettings(e){this.state.settings={...this.state.settings,...e},this.notifyListeners()}updateUI(e){this.state.ui={...this.state.ui,...e},this.notifyListeners()}setFeedback(e,s){this.state.feedback={message:e,type:s,visible:!0},this.notifyListeners()}clearFeedback(){this.state.feedback.visible=!1,this.notifyListeners()}addNoteEvent(e){this.state.noteEvents=[...this.state.noteEvents,e],e.type==="on"?this.state.currentNotes.includes(e.noteNumber)||(this.state.currentNotes=[...this.state.currentNotes,e.noteNumber]):this.state.currentNotes=this.state.currentNotes.filter(s=>s!==e.noteNumber),this.notifyListeners()}setExpectedNotes(e){this.state.expectedNotes=[...e],this.notifyListeners()}addCompletedNote(e){this.state.completedNotes.includes(e)||(this.state.completedNotes=[...this.state.completedNotes,e],this.notifyListeners())}start(){this.state.status="active",this.state.startTime=Date.now(),this.state.mistakes=0,this.state.currentNotes=[],this.state.completedNotes=[],this.state.noteEvents=[],this.clearFeedback(),this.notifyListeners()}pause(){this.state.status==="active"&&(this.state.status="paused",this.notifyListeners())}resume(){this.state.status==="paused"&&(this.state.status="active",this.notifyListeners())}complete(e){this.state.status=e?"completed":"failed",this.state.endTime=Date.now();const s=this.createResult(e);return this.notifyListeners(),s}reset(){const e=this.state.settings,s=this.state.ui;this.state={...this.state,status:"idle",currentNotes:[],expectedNotes:[],completedNotes:[],noteEvents:[],mistakes:0,startTime:void 0,endTime:void 0,settings:e,ui:s,feedback:{message:"",type:"info",visible:!1}},this.notifyListeners()}recordMistake(e){this.state.mistakes++,this.state.mistakes>=3&&(this.state.ui.showNoteNames=!0),this.state.mistakes>=6&&(this.state.ui.showKeyboard=!0),this.notifyListeners()}calculateProgress(){if(this.state.expectedNotes.length===0)return 0;const e=this.state.currentNotes.filter(s=>this.state.expectedNotes.includes(s));return Math.round(e.length/this.state.expectedNotes.length*100)}calculateAccuracy(){if(this.state.expectedNotes.length===0)return 100;const e=this.state.noteEvents.filter(a=>a.type==="on").length;if(e===0)return 0;const s=this.state.completedNotes.length;return Math.round(s/e*100)}getTimeElapsed(){return this.state.startTime?(this.state.endTime||Date.now())-this.state.startTime:0}validateChord(){const e=[...this.state.currentNotes].sort(),s=[...this.state.expectedNotes].sort();return e.length===s.length&&e.every((a,i)=>a===s[i])}validateScaleProgress(e=!1){if(!e)return this.validateChord();const s=this.state.noteEvents.filter(a=>a.type==="on").map(a=>a.noteNumber);for(let a=0;a<s.length;a++)if(s[a]!==this.state.expectedNotes[a])return!1;return s.length===this.state.expectedNotes.length}subscribe(e){return this.listeners.push(e),()=>{const s=this.listeners.indexOf(e);s>-1&&this.listeners.splice(s,1)}}notifyListeners(){this.listeners.forEach(e=>{try{e(this.state)}catch(s){console.error("Error in state listener:",s)}})}createResult(e){const s=this.getTimeElapsed(),a=this.calculateAccuracy(),i=this.calculateScore(a,s,this.state.mistakes);return{exerciseId:this.state.id,exerciseType:this.state.type,success:e,accuracy:a,timeElapsed:s,mistakes:this.state.mistakes,score:i,timestamp:new Date}}calculateScore(e,s,a){let i=e;const u=Math.max(0,Math.min(20,(6e4-s)/3e3));i+=u;const m=a*5;return i-=m,Math.max(0,Math.min(100,Math.round(i)))}}function dt(c,e){return{id:c,type:"chord",status:"idle",currentNotes:[],expectedNotes:[],completedNotes:[],noteEvents:[],mistakes:0,settings:e,ui:{showKeyboard:!1,showNoteNames:!1,showScore:!0,debugMode:!1},feedback:{message:"",type:"info",visible:!1},chord:{type:"maj7",inversion:0,voicing:"full"}}}class ht{static getChordNotes(e,s,a=0,i="close",u=4){const m=e+u,k=at[m],g=it(k,s,a);let q=[g.root,g.third,g.fifth,g.seventh].filter(S=>S!==void 0);return this.applyVoicing(q,i)}static applyVoicing(e,s){switch(s){case"close":return e;case"open":return e.map((a,i)=>i>1?a+12:a);case"drop2":if(e.length>=3){const a=[...e];return a[e.length-2]=a[e.length-2]-12,a.sort((i,u)=>i-u)}return e;case"drop3":if(e.length>=4){const a=[...e];return a[e.length-3]=a[e.length-3]-12,a.sort((i,u)=>i-u)}return e;case"shell":return e.filter((a,i)=>i!==2);default:return e}}static getChordSymbol(e,s){return e+{major:"",minor:"m",maj7:"maj7",min7:"m7",7:"7",diminished:"¬∞",augmented:"+",sus2:"sus2",sus4:"sus4"}[s]}static getChordQuality(e){return{major:"Major Triad",minor:"Minor Triad",maj7:"Major Seventh",min7:"Minor Seventh",7:"Dominant Seventh",diminished:"Diminished",augmented:"Augmented",sus2:"Suspended Second",sus4:"Suspended Fourth"}[e]}static getJazzProgressions(){return{"ii-V-I":["min7","7","maj7"],"vi-ii-V-I":["min7","min7","7","maj7"],"I-vi-ii-V":["maj7","min7","min7","7"],"iii-vi-ii-V":["min7","min7","min7","7"],"Giant Steps":["maj7","7","maj7","7"]}}}class vt{static calculateOptimalRange(e,s=2,a=7){if(e.length===0)return{middleC:60,octaves:s};const i=Math.min(...e),u=Math.max(...e),m=Math.floor((i-12)/12)*12+12,g=Math.ceil((u+12)/12)*12-m,q=Math.max(s,Math.min(a,Math.ceil(g/12))),S=m+Math.floor(q*12/2)-6;return{middleC:Math.max(24,S),octaves:q}}static getKeyboardLayouts(){return{piano:{whiteKeyWidth:30,blackKeyWidth:20,whiteKeyHeight:120,blackKeyHeight:80},compact:{whiteKeyWidth:20,blackKeyWidth:14,whiteKeyHeight:80,blackKeyHeight:55},large:{whiteKeyWidth:40,blackKeyWidth:26,whiteKeyHeight:150,blackKeyHeight:100}}}}class mt{static isValidMidiNote(e){return e>=24&&e<=128&&Number.isInteger(e)}static isValidNote(e){return Me.includes(e)}static isValidChordType(e){return["major","minor","maj7","min7","7","diminished","augmented","sus2","sus4"].includes(e)}static arraysEqual(e,s){if(e.length!==s.length)return!1;const a=[...e].sort(),i=[...s].sort();return a.every((u,m)=>u===i[m])}static isSequential(e){for(let s=1;s<e.length;s++)if(e[s]<=e[s-1])return!1;return!0}}const K={Chord:ht,Keyboard:vt,Validation:mt};var pt=L("<div> </div>"),gt=(c,e)=>e(c.target.value),ft=L("<option> </option>"),bt=(c,e)=>e(c.target.value),yt=L("<option> </option>"),_t=(c,e)=>e(parseInt(c.target.value)),Nt=(c,e)=>e(c.target.value),jt=L('<div class="demo-exercise svelte-2juiiq"><header class="demo-header svelte-2juiiq"><h1 class="svelte-2juiiq">üéØ Improved Architecture Demo</h1> <div class="benefits svelte-2juiiq"><div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üì¶ Consolidated Logic</h3> <p class="svelte-2juiiq">No more duplicate chord/scale/progression calculations</p></div> <div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üîß Type-Safe Config</h3> <p class="svelte-2juiiq">Centralized, persistent configuration management</p></div> <div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üéÆ Unified State</h3> <p class="svelte-2juiiq">Consistent state management across all exercises</p></div> <div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üß∞ Rich Utilities</h3> <p class="svelte-2juiiq">Comprehensive music theory and validation tools</p></div></div></header> <div class="exercise-info svelte-2juiiq"><h2 class="chord-display svelte-2juiiq"> </h2> <div class="exercise-details svelte-2juiiq"><span> </span> <span> </span> <span> </span></div></div> <div class="metrics svelte-2juiiq"><div class="metric svelte-2juiiq"><label class="svelte-2juiiq">Progress:</label> <div class="progress-bar svelte-2juiiq"><div class="fill svelte-2juiiq"></div></div> <span> </span></div> <div class="metric svelte-2juiiq"><label class="svelte-2juiiq">Accuracy:</label> <span> </span></div> <div class="metric svelte-2juiiq"><label class="svelte-2juiiq">Mistakes:</label> <span> </span></div> <div class="metric svelte-2juiiq"><label class="svelte-2juiiq">Time:</label> <span> </span></div></div> <!> <div class="controls svelte-2juiiq"><div class="control-group svelte-2juiiq"><label class="svelte-2juiiq">Key:</label> <select class="svelte-2juiiq"></select></div> <div class="control-group svelte-2juiiq"><label class="svelte-2juiiq">Chord Type:</label> <select class="svelte-2juiiq"></select></div> <div class="control-group svelte-2juiiq"><label class="svelte-2juiiq">Inversion:</label> <select class="svelte-2juiiq"><option>Root</option><option>1st</option><option>2nd</option><option>3rd</option></select></div> <div class="control-group svelte-2juiiq"><label class="svelte-2juiiq">Voicing:</label> <select class="svelte-2juiiq"><option>Full</option><option>Left Hand</option><option>Right Hand</option><option>Split</option></select></div> <div class="control-group svelte-2juiiq"><button class="svelte-2juiiq">Reset</button> <button class="svelte-2juiiq"> </button></div></div> <!> <div class="comparison svelte-2juiiq"><h3 class="svelte-2juiiq">üìä Before vs After</h3> <div class="comparison-grid svelte-2juiiq"><div class="before svelte-2juiiq"><h4 class="svelte-2juiiq">‚ùå Before (Original)</h4> <ul class="svelte-2juiiq"><li class="svelte-2juiiq">863 lines in chords route</li> <li class="svelte-2juiiq">706 lines in scales route</li> <li class="svelte-2juiiq">~70% code duplication</li> <li class="svelte-2juiiq">Scattered configuration</li> <li class="svelte-2juiiq">Inconsistent patterns</li> <li class="svelte-2juiiq">Hard to extend</li></ul></div> <div class="after svelte-2juiiq"><h4 class="svelte-2juiiq">‚úÖ After (Improved)</h4> <ul class="svelte-2juiiq"><li class="svelte-2juiiq">Shared BaseExercise component</li> <li class="svelte-2juiiq">Consolidated utilities</li> <li class="svelte-2juiiq">Type-safe configuration</li> <li class="svelte-2juiiq">Unified state management</li> <li class="svelte-2juiiq">Easy to add new exercises</li> <li class="svelte-2juiiq">90% reduction in duplication</li></ul></div></div></div></div>');function Tt(c,e){Qe(e,!0),Se.getConfig(),Se.getSection("exercise");const s=dt("demo-chord",{key:"C",tempo:120,allowedMistakes:3,showHints:!0,enableMetronome:!1}),a=new ut(s);let i=Xe(Ye(a.getState()));xe(()=>a.subscribe(d=>{et(i,d,!0)}));let u=p(()=>K.Chord.getChordNotes(t(i).settings.key,t(i).chord.type,t(i).chord.inversion,t(i).chord.voicing)),m=p(()=>K.Keyboard.calculateOptimalRange(t(u))),k=p(()=>()=>K.Chord.getChordSymbol(t(i).settings.key,t(i).chord.type));function g(l){var d,h,x,f;if(a.addNoteEvent(l),t(u).includes(l.noteNumber)?(a.addCompletedNote(l.noteNumber),a.setFeedback("Correct!","success"),(h=(d=ie).playSound)==null||h.call(d,"success")):(a.recordMistake(l.noteNumber),a.setFeedback("Try again!","error"),(f=(x=ie).playSound)==null||f.call(x,"error")),K.Validation.arraysEqual(t(i).currentNotes.sort(),t(u).sort())){const Ue=a.complete(!0);console.log("Exercise completed!",Ue)}}function q(l){a.addNoteEvent(l)}function S(l){a.updateState({chord:{...t(i).chord,type:l}}),a.setExpectedNotes(t(u))}function we(l){a.updateState({chord:{...t(i).chord,inversion:l}}),a.setExpectedNotes(t(u))}function Ee(l){a.updateState({chord:{...t(i).chord,voicing:l}}),a.setExpectedNotes(t(u))}function ae(l){a.updateSettings({key:l}),a.setExpectedNotes(t(u))}function oe(){a.reset()}function re(){a.updateUI({debugMode:!t(i).ui.debugMode})}xe(async()=>{await se.initialize(),se.setEventHandlers({onNoteOn:g,onNoteOff:q}),await ie.initialize(),a.setExpectedNotes(t(u)),a.start()}),Ge(()=>{se.cleanup()});let ne=p(()=>a.calculateProgress()),Te=p(()=>a.calculateAccuracy()),Ke=p(()=>a.getTimeElapsed());var D=jt(),I=o(n(D),2),O=n(I),Le=n(O,!0);r(O);var le=o(O,2),V=n(le),De=n(V);r(V);var A=o(V,2),Ie=n(A);r(A);var ce=o(A,2),Oe=n(ce);r(ce),r(le),r(I);var H=o(I,2),P=n(H),F=o(n(P),2),Ve=n(F);r(F);var ue=o(F,2),Ae=n(ue);r(ue),r(P);var R=o(P,2),de=o(n(R),2),He=n(de);r(de),r(R);var $=o(R,2),he=o(n($),2),Pe=n(he,!0);r(he),r($);var ve=o($,2),me=o(n(ve),2),Fe=n(me);r(me),r(ve),r(H);var pe=o(H,2);{var Re=l=>{var d=pt(),h=n(d,!0);r(d),M(()=>{nt(d,1,`feedback feedback-${t(i).feedback.type??""}`,"svelte-2juiiq"),v(h,t(i).feedback.message)}),w(l,d)};st(pe,l=>{t(i).feedback.visible&&l(Re)})}var z=o(pe,2),U=n(z),b=o(n(U),2);b.__change=[gt,ae],Ce(b,21,()=>Me,ke,(l,d)=>{var h=ft(),x=n(h,!0);r(h);var f={};M(()=>{v(x,t(d)),f!==(f=t(d))&&(h.value=(h.__value=t(d))??"")}),w(l,h)}),r(b);var ge;E(b),r(U);var W=o(U,2),y=o(n(W),2);y.__change=[bt,S],Ce(y,21,()=>ot,ke,(l,d)=>{var h=yt(),x=n(h,!0);r(h);var f={};M(()=>{v(x,t(d)),f!==(f=t(d))&&(h.value=(h.__value=t(d))??"")}),w(l,h)}),r(y);var fe;E(y),r(W);var B=o(W,2),_=o(n(B),2);_.__change=[_t,we];var J=n(_);J.value=J.__value=0;var G=o(J);G.value=G.__value=1;var Q=o(G);Q.value=Q.__value=2;var be=o(Q);be.value=be.__value=3,r(_);var ye;E(_),r(B);var X=o(B,2),N=o(n(X),2);N.__change=[Nt,Ee];var Y=n(N);Y.value=Y.__value="full";var Z=o(Y);Z.value=Z.__value="left-hand";var ee=o(Z);ee.value=ee.__value="right-hand";var _e=o(ee);_e.value=_e.__value="split",r(N);var Ne;E(N),r(X);var je=o(X,2),qe=n(je);qe.__click=oe;var te=o(qe,2);te.__click=re;var $e=n(te);r(te),r(je),r(z);var ze=o(z,2);{let l=p(()=>({noteEvents:t(i).noteEvents,midiNotes:t(i).currentNotes,selectedNote:t(i).settings.key,debugMode:t(i).ui.debugMode,errorCount:t(i).mistakes,showNoteNames:t(i).ui.showNoteNames,showKeyboard:t(i).ui.showKeyboard,feedbackMessage:t(i).feedback.message})),d=p(()=>({midiNotes:t(i).currentNotes,middleC:t(m).middleC,octaves:t(m).octaves,interactive:t(i).ui.debugMode,showLabels:t(i).ui.showNoteNames})),h=p(()=>({title:t(k),showClefs:!0}));lt(ze,{get exerciseState(){return t(l)},exerciseTitle:"Chord Practice (Improved)",exerciseDescription:"Demonstrating the new consolidated architecture",get expectedNotes(){return t(u)},get keyboardProps(){return t(d)},get scoreProps(){return t(h)},onNoteSelect:ae,onDebugToggle:re,onReset:oe,customControls:!0})}tt(2),r(D),M(l=>{v(Le,t(k)),v(De,`Voicing: ${t(i).chord.voicing??""}`),v(Ie,`Inversion: ${t(i).chord.inversion??""}`),v(Oe,`Status: ${t(i).status??""}`),rt(Ve,`width: ${t(ne)??""}%`),v(Ae,`${t(ne)??""}%`),v(He,`${t(Te)??""}%`),v(Pe,t(i).mistakes),v(Fe,`${l??""}s`),ge!==(ge=t(i).settings.key)&&(b.value=(b.__value=t(i).settings.key)??"",T(b,t(i).settings.key)),fe!==(fe=t(i).chord.type)&&(y.value=(y.__value=t(i).chord.type)??"",T(y,t(i).chord.type)),ye!==(ye=t(i).chord.inversion)&&(_.value=(_.__value=t(i).chord.inversion)??"",T(_,t(i).chord.inversion)),Ne!==(Ne=t(i).chord.voicing)&&(N.value=(N.__value=t(i).chord.voicing)??"",T(N,t(i).chord.voicing)),v($e,`${t(i).ui.debugMode?"Hide":"Show"} Debug`)},[()=>Math.round(t(Ke)/1e3)]),w(c,D),Ze()}Je(["change","click"]);export{Tt as component};
