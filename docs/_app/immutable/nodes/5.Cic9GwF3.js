import"../chunks/NZTpNUN0.js";import{d as Fe,o as be,a as ze,s as v}from"../chunks/DutP5Gvj.js";import{p as He,z as Ve,A as Ge,f as E,s as a,d as l,k as e,t as N,b as j,c as Je,C as p,B as Qe,r as o,D as We}from"../chunks/C7Lc0MXo.js";import{i as Xe}from"../chunks/DSSW3rDz.js";import{e as Ne,i as je,A as Ye,b as Ze}from"../chunks/KCvTrXcA.js";import{i as q,a as et,b as x,s as tt}from"../chunks/9IstWcpU.js";import{c as qe,M as k}from"../chunks/xECcMkd1.js";import{B as st,m as X,a as Y}from"../chunks/B0lqf9OI.js";class it{state;listeners=[];constructor(s){this.state={...s}}getState(){return{...this.state}}getStatus(){return this.state.status}isActive(){return this.state.status==="active"}isCompleted(){return this.state.status==="completed"||this.state.status==="failed"}updateState(s){this.state={...this.state,...s},this.notifyListeners()}updateSettings(s){this.state.settings={...this.state.settings,...s},this.notifyListeners()}updateUI(s){this.state.ui={...this.state.ui,...s},this.notifyListeners()}setFeedback(s,r){this.state.feedback={message:s,type:r,visible:!0},this.notifyListeners()}clearFeedback(){this.state.feedback.visible=!1,this.notifyListeners()}addNoteEvent(s){this.state.noteEvents=[...this.state.noteEvents,s],s.type==="on"?this.state.currentNotes.includes(s.noteNumber)||(this.state.currentNotes=[...this.state.currentNotes,s.noteNumber]):this.state.currentNotes=this.state.currentNotes.filter(r=>r!==s.noteNumber),this.notifyListeners()}setExpectedNotes(s){this.state.expectedNotes=[...s],this.notifyListeners()}addCompletedNote(s){this.state.completedNotes.includes(s)||(this.state.completedNotes=[...this.state.completedNotes,s],this.notifyListeners())}start(){this.state.status="active",this.state.startTime=Date.now(),this.state.mistakes=0,this.state.currentNotes=[],this.state.completedNotes=[],this.state.noteEvents=[],this.clearFeedback(),this.notifyListeners()}pause(){this.state.status==="active"&&(this.state.status="paused",this.notifyListeners())}resume(){this.state.status==="paused"&&(this.state.status="active",this.notifyListeners())}complete(s){this.state.status=s?"completed":"failed",this.state.endTime=Date.now();const r=this.createResult(s);return this.notifyListeners(),r}reset(){const s=this.state.settings,r=this.state.ui;this.state={...this.state,status:"idle",currentNotes:[],expectedNotes:[],completedNotes:[],noteEvents:[],mistakes:0,startTime:void 0,endTime:void 0,settings:s,ui:r,feedback:{message:"",type:"info",visible:!1}},this.notifyListeners()}recordMistake(s){this.state.mistakes++,this.state.mistakes>=3&&(this.state.ui.showNoteNames=!0),this.state.mistakes>=6&&(this.state.ui.showKeyboard=!0),this.notifyListeners()}calculateProgress(){if(this.state.expectedNotes.length===0)return 0;const s=this.state.currentNotes.filter(r=>this.state.expectedNotes.includes(r));return Math.round(s.length/this.state.expectedNotes.length*100)}calculateAccuracy(){if(this.state.expectedNotes.length===0)return 100;const s=this.state.noteEvents.filter(i=>i.type==="on").length;if(s===0)return 0;const r=this.state.completedNotes.length;return Math.round(r/s*100)}getTimeElapsed(){return this.state.startTime?(this.state.endTime||Date.now())-this.state.startTime:0}validateChord(){const s=[...this.state.currentNotes].sort(),r=[...this.state.expectedNotes].sort();return s.length===r.length&&s.every((i,t)=>i===r[t])}validateScaleProgress(s=!1){if(!s)return this.validateChord();const r=this.state.noteEvents.filter(i=>i.type==="on").map(i=>i.noteNumber);for(let i=0;i<r.length;i++)if(r[i]!==this.state.expectedNotes[i])return!1;return r.length===this.state.expectedNotes.length}subscribe(s){return this.listeners.push(s),()=>{const r=this.listeners.indexOf(s);r>-1&&this.listeners.splice(r,1)}}notifyListeners(){this.listeners.forEach(s=>{try{s(this.state)}catch(r){console.error("Error in state listener:",r)}})}createResult(s){const r=this.getTimeElapsed(),i=this.calculateAccuracy(),t=this.calculateScore(i,r,this.state.mistakes);return{exerciseId:this.state.id,exerciseType:this.state.type,success:s,accuracy:i,timeElapsed:r,mistakes:this.state.mistakes,score:t,timestamp:new Date}}calculateScore(s,r,i){let t=s;const h=Math.max(0,Math.min(20,(6e4-r)/3e3));t+=h;const b=i*5;return t-=b,Math.max(0,Math.min(100,Math.round(t)))}}function at(u,s){return{id:u,type:"chord",status:"idle",currentNotes:[],expectedNotes:[],completedNotes:[],noteEvents:[],mistakes:0,settings:s,ui:{showKeyboard:!1,showNoteNames:!1,showScore:!0,debugMode:!1},feedback:{message:"",type:"info",visible:!1},chord:{type:"maj7",inversion:0,voicing:"close"}}}var ot=E("<div> </div>"),rt=(u,s)=>s(u.target.value),lt=E("<option> </option>"),nt=(u,s)=>s(u.target.value),ct=E("<option> </option>"),dt=(u,s)=>s(parseInt(u.target.value)),ut=(u,s)=>s(u.target.value),vt=E('<div class="demo-exercise svelte-2juiiq"><header class="demo-header svelte-2juiiq"><h1 class="svelte-2juiiq">üéØ Improved Architecture Demo</h1> <div class="benefits svelte-2juiiq"><div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üì¶ Consolidated Logic</h3> <p class="svelte-2juiiq">No more duplicate chord/scale/progression calculations</p></div> <div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üîß Type-Safe Config</h3> <p class="svelte-2juiiq">Centralized, persistent configuration management</p></div> <div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üéÆ Unified State</h3> <p class="svelte-2juiiq">Consistent state management across all exercises</p></div> <div class="benefit svelte-2juiiq"><h3 class="svelte-2juiiq">üß∞ Rich Utilities</h3> <p class="svelte-2juiiq">Comprehensive music theory and validation tools</p></div></div></header> <div class="exercise-info svelte-2juiiq"><h2 class="chord-display svelte-2juiiq"> </h2> <div class="exercise-details svelte-2juiiq"><span> </span> <span> </span> <span> </span></div></div> <div class="metrics svelte-2juiiq"><div class="metric svelte-2juiiq"><label for="progress" class="svelte-2juiiq">Progress:</label> <div class="progress-bar svelte-2juiiq"><div class="fill svelte-2juiiq"></div></div> <span> </span></div> <div class="metric svelte-2juiiq"><label for="accuracy" class="svelte-2juiiq">Accuracy:</label> <span> </span></div> <div class="metric svelte-2juiiq"><label for="mistakes" class="svelte-2juiiq">Mistakes:</label> <span> </span></div> <div class="metric svelte-2juiiq"><label for="time" class="svelte-2juiiq">Time:</label> <span> </span></div></div> <!> <div class="controls svelte-2juiiq"><div class="control-group svelte-2juiiq"><label for="key-select" class="svelte-2juiiq">Key:</label> <select id="key-select" class="svelte-2juiiq"></select></div> <div class="control-group svelte-2juiiq"><label for="chord-type-select" class="svelte-2juiiq">Chord Type:</label> <select id="chord-type-select" class="svelte-2juiiq"></select></div> <div class="control-group svelte-2juiiq"><label for="inversion-select" class="svelte-2juiiq">Inversion:</label> <select id="inversion-select" class="svelte-2juiiq"><option>Root</option><option>1st</option><option>2nd</option><option>3rd</option></select></div> <div class="control-group svelte-2juiiq"><label for="voicing-select" class="svelte-2juiiq">Voicing:</label> <select id="voicing-select" class="svelte-2juiiq"><option>Close</option><option>Open</option><option>Drop 2</option><option>Drop 3</option><option>Shell</option></select></div> <div class="control-group svelte-2juiiq"><button class="svelte-2juiiq">Reset</button> <button class="svelte-2juiiq"> </button></div></div> <!> <div class="comparison svelte-2juiiq"><h3 class="svelte-2juiiq">üìä Before vs After</h3> <div class="comparison-grid svelte-2juiiq"><div class="before svelte-2juiiq"><h4 class="svelte-2juiiq">‚ùå Before (Original)</h4> <ul class="svelte-2juiiq"><li class="svelte-2juiiq">863 lines in chords route</li> <li class="svelte-2juiiq">706 lines in scales route</li> <li class="svelte-2juiiq">~70% code duplication</li> <li class="svelte-2juiiq">Scattered configuration</li> <li class="svelte-2juiiq">Inconsistent patterns</li> <li class="svelte-2juiiq">Hard to extend</li></ul></div> <div class="after svelte-2juiiq"><h4 class="svelte-2juiiq">‚úÖ After (Improved)</h4> <ul class="svelte-2juiiq"><li class="svelte-2juiiq">Shared BaseExercise component</li> <li class="svelte-2juiiq">Consolidated utilities</li> <li class="svelte-2juiiq">Type-safe configuration</li> <li class="svelte-2juiiq">Unified state management</li> <li class="svelte-2juiiq">Easy to add new exercises</li> <li class="svelte-2juiiq">90% reduction in duplication</li></ul></div></div></div></div>');function Nt(u,s){He(s,!0),qe.getConfig(),qe.getSection("exercise");const r=at("demo-chord",{key:"C",tempo:120,allowedMistakes:3,showHints:!0,enableMetronome:!1}),i=new it(r);let t=Ve(Ge(i.getState()));be(()=>i.subscribe(c=>{Qe(t,c,!0)}));let h=p(()=>e(t).type!=="chord"?[]:k.Chord.getChordNotes(e(t).settings.key,e(t).chord.type,e(t).chord.inversion,e(t).chord.voicing)),b=p(()=>k.Keyboard.calculateOptimalRange(e(h))),Z=p(()=>()=>e(t).type!=="chord"?"Unknown":k.Chord.getChordSymbol(e(t).settings.key,e(t).chord.type));function xe(n){if(i.addNoteEvent(n),e(h).includes(n.noteNumber)?(i.addCompletedNote(n.noteNumber),i.setFeedback("Correct!","success"),Y.playSound?.("success")):(i.recordMistake(n.noteNumber),i.setFeedback("Try again!","error"),Y.playSound?.("error")),k.Validation.arraysEqual(e(t).currentNotes.sort(),e(h).sort())){const c=i.complete(!0);console.log("Exercise completed!",c)}}function ke(n){i.addNoteEvent(n)}function Ee(n){e(t).type==="chord"&&(i.updateState({chord:{...e(t).chord,type:n}}),i.setExpectedNotes(e(h)))}function Se(n){e(t).type==="chord"&&(i.updateState({chord:{...e(t).chord,inversion:n}}),i.setExpectedNotes(e(h)))}function Ce(n){e(t).type==="chord"&&(i.updateState({chord:{...e(t).chord,voicing:n}}),i.setExpectedNotes(e(h)))}function ee(n){i.updateSettings({key:n}),i.setExpectedNotes(e(h))}function te(){i.reset()}function se(){i.updateUI({debugMode:!e(t).ui.debugMode})}be(async()=>{await X.initialize(),X.setEventHandlers({onNoteOn:xe,onNoteOff:ke}),await Y.initialize(),i.setExpectedNotes(e(h)),i.start()}),ze(()=>{X.cleanup()});let ie=p(()=>i.calculateProgress()),Me=p(()=>i.calculateAccuracy()),we=p(()=>i.getTimeElapsed());var S=vt(),C=a(l(S),2),M=l(C),Te=l(M,!0);o(M);var ae=a(M,2),w=l(ae),Le=l(w);o(w);var T=a(w,2),Ae=l(T);o(T);var oe=a(T,2),De=l(oe);o(oe),o(ae),o(C);var L=a(C,2),A=l(L),D=a(l(A),2),$e=l(D);o(D);var re=a(D,2),Ie=l(re);o(re),o(A);var $=a(A,2),le=a(l($),2),Oe=l(le);o(le),o($);var I=a($,2),ne=a(l(I),2),Pe=l(ne,!0);o(ne),o(I);var ce=a(I,2),de=a(l(ce),2),Re=l(de);o(de),o(ce),o(L);var ue=a(L,2);{var Be=n=>{var c=ot(),d=l(c,!0);o(c),N(()=>{tt(c,1,`feedback feedback-${e(t).feedback.type??""}`,"svelte-2juiiq"),v(d,e(t).feedback.message)}),j(n,c)};Xe(ue,n=>{e(t).feedback.visible&&n(Be)})}var O=a(ue,2),P=l(O),f=a(l(P),2);f.__change=[rt,ee],Ne(f,21,()=>Ye,je,(n,c)=>{var d=lt(),W=l(d,!0);o(d);var y={};N(()=>{v(W,e(c)),y!==(y=e(c))&&(d.value=(d.__value=e(c))??"")}),j(n,d)}),o(f);var ve;q(f),o(P);var R=a(P,2),m=a(l(R),2);m.__change=[nt,Ee],Ne(m,21,()=>Ze,je,(n,c)=>{var d=ct(),W=l(d,!0);o(d);var y={};N(()=>{v(W,e(c)),y!==(y=e(c))&&(d.value=(d.__value=e(c))??"")}),j(n,d)}),o(m);var he;q(m),o(R);var B=a(R,2),g=a(l(B),2);g.__change=[dt,Se];var K=l(g);K.value=K.__value=0;var U=a(K);U.value=U.__value=1;var F=a(U);F.value=F.__value=2;var pe=a(F);pe.value=pe.__value=3,o(g);var fe;q(g),o(B);var z=a(B,2),_=a(l(z),2);_.__change=[ut,Ce];var H=l(_);H.value=H.__value="close";var V=a(H);V.value=V.__value="open";var G=a(V);G.value=G.__value="drop2";var J=a(G);J.value=J.__value="drop3";var me=a(J);me.value=me.__value="shell",o(_);var ge;q(_),o(z);var _e=a(z,2),ye=l(_e);ye.__click=te;var Q=a(ye,2);Q.__click=se;var Ke=l(Q);o(Q),o(_e),o(O);var Ue=a(O,2);{let n=p(()=>({noteEvents:e(t).noteEvents,midiNotes:e(t).currentNotes,selectedNote:e(t).settings.key,debugMode:e(t).ui.debugMode,errorCount:e(t).mistakes,showNoteNames:e(t).ui.showNoteNames,showKeyboard:e(t).ui.showKeyboard,feedbackMessage:e(t).feedback.message,completed:e(t).status==="completed"})),c=p(()=>({midiNotes:e(t).currentNotes,middleC:e(b).middleC,octaves:e(b).octaves,interactive:e(t).ui.debugMode,showLabels:e(t).ui.showNoteNames})),d=p(()=>({title:e(Z).toString(),showClefs:!0}));st(Ue,{get exerciseState(){return e(n)},exerciseTitle:"Chord Practice (Improved)",exerciseDescription:"Demonstrating the new consolidated architecture",get expectedNotes(){return e(h)},get keyboardProps(){return e(c)},get scoreProps(){return e(d)},onNoteSelect:ee,onDebugToggle:se,onReset:te,customControls:!0})}We(2),o(S),N(n=>{v(Te,e(Z)),v(Le,`Voicing: ${(e(t).type==="chord"?e(t).chord.voicing:"N/A")??""}`),v(Ae,`Inversion: ${(e(t).type==="chord"?e(t).chord.inversion:"N/A")??""}`),v(De,`Status: ${e(t).status??""}`),et($e,`width: ${e(ie)??""}%`),v(Ie,`${e(ie)??""}%`),v(Oe,`${e(Me)??""}%`),v(Pe,e(t).mistakes),v(Re,`${n??""}s`),ve!==(ve=e(t).settings.key)&&(f.value=(f.__value=e(t).settings.key)??"",x(f,e(t).settings.key)),he!==(he=e(t).type==="chord"?e(t).chord.type:"maj7")&&(m.value=(m.__value=e(t).type==="chord"?e(t).chord.type:"maj7")??"",x(m,e(t).type==="chord"?e(t).chord.type:"maj7")),fe!==(fe=e(t).type==="chord"?e(t).chord.inversion:0)&&(g.value=(g.__value=e(t).type==="chord"?e(t).chord.inversion:0)??"",x(g,e(t).type==="chord"?e(t).chord.inversion:0)),ge!==(ge=e(t).type==="chord"?e(t).chord.voicing:"close")&&(_.value=(_.__value=e(t).type==="chord"?e(t).chord.voicing:"close")??"",x(_,e(t).type==="chord"?e(t).chord.voicing:"close")),v(Ke,`${e(t).ui.debugMode?"Hide":"Show"} Debug`)},[()=>Math.round(e(we)/1e3)]),j(u,S),Je()}Fe(["change","click"]);export{Nt as component};
